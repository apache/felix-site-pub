<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       https://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Apache Felix Tutorial Example 9</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="https://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="https://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><a href="/news.html">News</a>  <br />
<a href="/license.html">License</a>  <br />
<a href="/downloads.cgi">Downloads</a>  <br />
<a href="/documentation.html">Documentation</a>  <br />
<a href="/documentation/community/project-info.html">Project Info</a>  <br />
<a href="/documentation/community/contributing.html">Contributing</a>  <br />
<a href="/sitemap.html">Site Map</a>  <br />
<a href="https://www.apache.org/">ASF</a>  <br />
<a href="https://www.apache.org/security/">Security</a>  <br />
<a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>  <br />
<a href="https://www.apache.org/foundation/thanks.html">Sponsors</a>    </p>
<iframe
    src="https://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/tutorials-examples-and-presentations.html">Tutorials, Examples, and Presentations</a>&nbsp;&raquo&nbsp;<a href="/documentation/tutorials-examples-and-presentations/apache-felix-osgi-tutorial.html">Apache Felix OSGi Tutorial</a>
      </div>

      <h1>Apache Felix Tutorial Example 9</h1>
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<h1 id="example-9-spell-checker-service-using-declarative-services">Example 9 - Spell Checker Service using Declarative Services<a class="headerlink" href="#example-9-spell-checker-service-using-declarative-services" title="Permanent link">&para;</a></h1>
<p>The purpose of this example is to re-implement the spell checker service in Example 6, but to do so using Declarative Service. Therefore you need to install the Declarative Services implementation into your OSGi framework.</p>
<p>The spell checker service of Example 6 was complex because it needed to aggregate all available dictionary services and monitor their dynamic availability. In addition, the spell checker service's own availability was dependent upon the availability of dictionary services; in other words, the spell checker service had a dynamic, one-to-many dependency on dictionary services. As it turns out, service dependencies are not managed at all by the OSGi framework and end up being the responsibility of the application developer. Declarative Services tries to eliminate complex and error-prone service dependency handling by automating it. To do this, Declarative Services parses XML files in a bundle that describes the components we want to create and their service dependencies. Instead of writing a lot of complex code, we simply use annotations. At build time the tooling creates a declarative XML file which is included in the bundle. There is no need to write an Activator.</p>
<p>We define the new spell checker service in a file called <code>SpellCheckerImpl.java</code> as follows:</p>
<div class="codehilite"><pre><span class="cm">/*</span>
<span class="cm"> * Apache Felix OSGi tutorial.</span>
<span class="cm">**/</span>

<span class="kn">package</span> <span class="n">tutorial</span><span class="p">.</span><span class="n">example9</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">StringTokenizer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">examples</span><span class="p">.</span><span class="n">dictionaryservice</span><span class="p">.</span><span class="n">DictionaryService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">examples</span><span class="p">.</span><span class="n">spellcheckservice</span><span class="p">.</span><span class="n">SpellCheckService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">ReferenceCardinality</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">ReferencePolicy</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * This class re-implements the spell check service of Example 6. This service</span>
<span class="cm"> * implementation behaves exactly like the one in Example 6, specifically, it</span>
<span class="cm"> * aggregates all available dictionary services, monitors their dynamic</span>
<span class="cm"> * availability, and only offers the spell check service if there are dictionary</span>
<span class="cm"> * services available. The service implementation is greatly simplified, though,</span>
<span class="cm"> * by using the Service Component Runtime. Notice that there is no OSGi references in the</span>
<span class="cm"> * application code; instead, the annotations describe the service</span>
<span class="cm"> * dependencies to the Service Component Runtime, which automatically manages them and it</span>
<span class="cm"> * also automatically registers the spell check services as appropriate.</span>
<span class="cm"> */</span>
<span class="p">@</span><span class="n">Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="n">SpellCheckServiceImpl</span> <span class="n">implements</span> <span class="n">SpellCheckService</span>
<span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * List of service objects.</span>
<span class="cm">     *</span>
<span class="cm">     * This field is managed by the Service Component Runtime and updated</span>
<span class="cm">     * with the current set of available dictionary services.</span>
<span class="cm">     * At least one dictionary service is required.</span>
<span class="cm">     */</span>
    <span class="p">@</span><span class="n">Reference</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">ReferencePolicy</span><span class="p">.</span><span class="no">DYNAMIC</span><span class="p">,</span> <span class="n">cardinality</span><span class="o">=</span><span class="n">ReferenceCardinality</span><span class="p">.</span><span class="no">AT_LEAST_ONE</span><span class="p">)</span>
    <span class="n">private</span> <span class="n">volatile</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DictionaryService</span><span class="o">&gt;</span> <span class="n">m_svcObjList</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Checks a given passage for spelling errors. A passage is any number of</span>
<span class="cm">     * words separated by a space and any of the following punctuation marks:</span>
<span class="cm">     * comma (,), period (.), exclamation mark (!), question mark (?),</span>
<span class="cm">     * semi-colon (;), and colon(:).</span>
<span class="cm">     *</span>
<span class="cm">     * @param passage</span>
<span class="cm">     *            the passage to spell check.</span>
<span class="cm">     * @return An array of misspelled words or null if no words are misspelled.</span>
<span class="cm">     */</span>
    <span class="n">public</span> <span class="n">String</span><span class="p">[]</span> <span class="n">check</span><span class="p">(</span> <span class="n">String</span> <span class="n">passage</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// No misspelled words for an empty string.</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">passage</span> <span class="o">==</span> <span class="k">null</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">passage</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">errorList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

        <span class="c1">// Tokenize the passage using spaces and punctionation.</span>
        <span class="n">StringTokenizer</span> <span class="n">st</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="p">(</span> <span class="n">passage</span><span class="p">,</span> <span class="s">&quot; ,.!?;:&quot;</span> <span class="p">);</span>

        <span class="c1">// Put the current set of services in a local field</span>
        <span class="c1">// the field m_svcObjList might be modified concurrently</span>
        <span class="k">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DictionaryService</span><span class="o">&gt;</span> <span class="n">localServices</span> <span class="o">=</span> <span class="n">m_svcObjList</span><span class="p">;</span>

        <span class="c1">// Loop through each word in the passage.</span>
        <span class="k">while</span> <span class="p">(</span> <span class="n">st</span><span class="p">.</span><span class="n">hasMoreTokens</span><span class="p">()</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">String</span> <span class="n">word</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">nextToken</span><span class="p">();</span>
            <span class="n">boolean</span> <span class="n">correct</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>

            <span class="c1">// Check each available dictionary for the current word.</span>
            <span class="k">for</span><span class="p">(</span><span class="k">final</span> <span class="n">DictionaryService</span> <span class="n">dictionary</span> <span class="o">:</span> <span class="n">localServices</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">dictionary</span><span class="p">.</span><span class="n">checkWord</span><span class="p">(</span> <span class="n">word</span> <span class="p">)</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">correct</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// If the word is not correct, then add it</span>
            <span class="c1">// to the incorrect word list.</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">correct</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">errorList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span> <span class="n">word</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Return null if no words are incorrect.</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">errorList</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Return the array of incorrect words.</span>
        <span class="k">return</span> <span class="n">errorList</span><span class="p">.</span><span class="n">toArray</span><span class="p">(</span> <span class="k">new</span> <span class="n">String</span><span class="p">[</span><span class="n">errorList</span><span class="p">.</span><span class="n">size</span><span class="p">()]</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Notice how much simpler this service implementation is when compared to the same service implemented in Example 6. There are no references to OSGi interfaces in our application code and all tricky and complex code dealing with monitoring of services is handled for us.</p>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1741128 by cziegeler on Wed, 27 Apr 2016 00:20:00 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
