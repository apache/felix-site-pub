<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Apache Felix Event Admin</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="http://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="http://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <p><a href="/news.html">news</a>  <br />
<a href="/license.html">license</a>  <br />
<a href="/downloads.cgi">downloads</a>  <br />
<a href="/documentation.html">documentation</a>  <br />
<a href="/mailinglists.html">mailing lists</a>  <br />
<a href="/documentation/community/contributing.html">contributing</a>  <br />
<a href="/sitemap.html">site map</a>  <br />
<a href="http://www.apache.org/">asf</a>  <br />
<a href="http://www.apache.org/security/">security</a>  <br />
<a href="http://www.apache.org/foundation/sponsorship.html">sponsorship</a>  <br />
<a href="http://www.apache.org/foundation/thanks.html">sponsors</a>  <br />
</p>
<iframe
    src="http://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects.html">Apache Felix Subproject Documentation</a>
      </div>

      
      <div class="tip">
           This page is a translated version of <a href="/site/apache-felix-event-admin.html" target="felix_cwiki">/site/apache-felix-event-admin.html</a>. In case of
           doubt you might want to refer to the old page.
      </div>
      
      
      <h1>Apache Felix Event Admin</h1>
      <h1 id="apache-felix-event-admin">Apache Felix Event Admin</h1>
<p>The Event Admin Service Specification, part of the OSGi Compendium specification, defines a general inter-bundle communication mechanism. The communication conforms to the popular publish/subscribe paradigm and can be performed in a synchronous or asysnchronous manner.</p>
<p>The main components in a publish/subscribe communication are:</p>
<ul>
<li><em>Event Publisher</em> - sends events or messages related to a specific <em>topic</em></li>
<li><em>Event Handler</em> (or <em>Subscriber</em>) - expresses interest in one or more topics and receives all the messages belonging to such topics.</li>
</ul>
<p>Events are composed of two attributes:</p>
<ul>
<li>a <em>topic</em> defining the nature of the event; topic names are usually arranged in a hierarchical namespace, where slashes are used to separate the levels (i.e. "org/osgi/framework/FrameworkEvent/STARTED") and</li>
<li>a set of <em>properties</em> describing the event.</li>
</ul>
<h2 id="creating-an-event-publisher">Creating an Event Publisher</h2>
<p>An event publisher is a simple Java class that creates events and sends them using the <code>EventAdmin</code> service interface, for example:</p>
<div class="codehilite"><pre>    <span class="n">public</span> <span class="n">void</span> <span class="n">reportGenerated</span><span class="p">(</span><span class="n">Report</span> <span class="n">report</span><span class="p">,</span> <span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ServiceReference</span> <span class="nb">ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getServiceReference</span><span class="p">(</span><span class="n">EventAdmin</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">ref</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">EventAdmin</span> <span class="n">eventAdmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">EventAdmin</span><span class="p">)</span> <span class="n">context</span><span class="o">.</span><span class="n">getService</span><span class="p">(</span><span class="nb">ref</span><span class="p">);</span>

            <span class="n">Dictionary</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">getTitle</span><span class="p">());</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;path&quot;</span> <span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">getAbsolutePath</span><span class="p">());</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">());</span>

            <span class="n">Event</span> <span class="n">reportGeneratedEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Event</span><span class="p">(</span><span class="s">&quot;com/acme/reportgenerator/GENERATED&quot;</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>

            <span class="n">eventAdmin</span><span class="o">.</span><span class="n">sendEvent</span><span class="p">(</span><span class="n">reportGeneratedEvent</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>The <code>EventAdmin.sendEvent()</code> method sends the <code>Event</code> object synchronously. To send it asynchronously, use the <code>EventAdmin.postEvent()</code> method, such as:</p>
<div class="codehilite"><pre>            <span class="sr">//</span><span class="o">..</span>        
            <span class="n">Event</span> <span class="n">reportGeneratedEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Event</span><span class="p">(</span><span class="s">&quot;com/acme/reportgenerator/GENERATED&quot;</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
            <span class="n">eventAdmin</span><span class="o">.</span><span class="n">postEvent</span><span class="p">(</span><span class="n">reportGeneratedEvent</span><span class="p">);</span>
</pre></div>


<h2 id="creating-an-event-handler">Creating an Event Handler</h2>
<p>Creating an event handler is as simple as implementing the <code>EventHandler</code> interface:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">ReportEventHandler</span> <span class="n">implements</span> <span class="n">EventHandler</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">handleEvent</span><span class="p">(</span><span class="n">Event</span> <span class="n">event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">String</span> <span class="n">reportTitle</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">event</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">reportPath</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">event</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">);</span>

        <span class="n">sendReportByEmail</span><span class="p">(</span><span class="n">reportTitle</span><span class="p">,</span> <span class="n">reportPath</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sr">//</span><span class="o">..</span>
</pre></div>


<h2 id="registering-an-event-handler">Registering an Event Handler</h2>
<p>To receive event notifications, the event handler must be registered as a OSGi service under the object class <code>org.osgi.service.event.EventHandler</code>. When registering the service, a <code>String\[\]()</code> property named <code>*EVENT_TOPIC*</code> must be specified; this property describes the list of topics in which the event handler is interested. For example:</p>
<div class="codehilite"><pre>        <span class="n">String</span><span class="o">[]</span> <span class="n">topics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="p">{</span>
            <span class="s">&quot;com/acme/reportgenerator/GENERATED&quot;</span>
        <span class="p">};</span>

        <span class="n">Dictionary</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
        <span class="n">props</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">EVENT_TOPIC</span><span class="p">,</span> <span class="n">topics</span><span class="p">);</span>
        <span class="n">bundleContext</span><span class="o">.</span><span class="n">registerService</span><span class="p">(</span><span class="n">EventHandler</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="k">new</span> <span class="n">ReportEventHandler</span><span class="p">()</span> <span class="p">,</span> <span class="n">props</span><span class="p">);</span>
</pre></div>


<p>It is possible to use '*' as a wildcard in the final character of the EVENT_TOPIC, like in this example:</p>
<div class="codehilite"><pre>        <span class="n">String</span><span class="o">[]</span> <span class="n">topics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="p">{</span>
            <span class="s">&quot;com/acme/reportgenerator/*&quot;</span>
        <span class="p">};</span>

        <span class="n">Dictionary</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
        <span class="n">props</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">EVENT_TOPIC</span><span class="p">,</span> <span class="n">topics</span><span class="p">);</span>
        <span class="n">bundleContext</span><span class="o">.</span><span class="n">registerService</span><span class="p">(</span><span class="n">EventHandler</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="k">new</span> <span class="n">ReportEventHandler</span><span class="p">()</span> <span class="p">,</span> <span class="n">props</span><span class="p">);</span>
</pre></div>


<p>Finally, it is possible to specify an additional <code>EVENT_FILTER</code> property to filter event notifications; the filter expression follows, the normal LDAP syntax:</p>
<div class="codehilite"><pre>        <span class="n">String</span><span class="o">[]</span> <span class="n">topics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="p">{</span>
            <span class="s">&quot;com/acme/reportgenerator/GENERATED&quot;</span>
        <span class="p">};</span>

        <span class="n">Dictionary</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
        <span class="n">props</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">EVENT_TOPIC</span><span class="p">,</span> <span class="n">topics</span><span class="p">);</span>
        <span class="n">props</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">EVENT_FILTER</span><span class="p">,</span> <span class="s">&quot;(title=samplereport)&quot;</span><span class="p">);</span>
        <span class="n">bundleContext</span><span class="o">.</span><span class="n">registerService</span><span class="p">(</span><span class="n">EventHandler</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="k">new</span> <span class="n">ReportEventHandler</span><span class="p">()</span> <span class="p">,</span> <span class="n">props</span><span class="p">);</span>
</pre></div>


<h2 id="osgi-events">OSGi Events</h2>
<p>Every OSGi framework sends (asynchronously) a number of events that can be captured by any bundle.</p>
<h3 id="framework-events">Framework Events</h3>
<ul>
<li>org/osgi/framework/BundleEvent/STARTED</li>
<li>org/osgi/framework/BundleEvent/ERROR</li>
<li>org/osgi/framework/BundleEvent/PACKAGES_REFRESHED</li>
<li>org/osgi/framework/BundleEvent/STARTLEVEL_CHANGED</li>
<li>org/osgi/framework/BundleEvent/WARNING</li>
<li>org/osgi/framework/BundleEvent/INFO</li>
</ul>
<h3 id="bundle-events">Bundle Events</h3>
<ul>
<li>org/osgi/framework/BundleEvent/INSTALLED</li>
<li>org/osgi/framework/BundleEvent/STARTED</li>
<li>org/osgi/framework/BundleEvent/STOPPED</li>
<li>org/osgi/framework/BundleEvent/UPDATED</li>
<li>org/osgi/framework/BundleEvent/UNINSTALLED</li>
<li>org/osgi/framework/BundleEvent/RESOLVED</li>
<li>org/osgi/framework/BundleEvent/UNRESOLVED</li>
</ul>
<p>The followig properties are always present in a bundle event object:</p>
<ul>
<li><em>bundle.id</em></li>
<li><em>bundle.symbolicName</em></li>
</ul>
<h3 id="service-events">Service Events</h3>
<ul>
<li>org/osgi/framework/ServiceEvent/REGISTERED</li>
<li>org/osgi/framework/ServiceEvent/MODIFIED</li>
<li>org/osgi/framework/ServiceEvent/UNREGISTERING</li>
</ul>
<p>The following properties are always present in a service event object:</p>
<ul>
<li><em>service</em></li>
<li><em>service.id</em></li>
<li><em>service.pid</em></li>
</ul>
<p>Each of the aforementioned events actually contains a wider set of properties. Check the OSGi Compendium specification, section 113.6, for a complete list.</p>
<h2 id="configuration">Configuration</h2>
<p>The Apache Felix Event Admin implementation is trying the deliver the events as fast as possible. Events sent from different threads are sent in parallel. Events from the same thread are sent in the order they are received (this is according to the spec).
A timeout can be configured which is used for event handlers. If an event handler takes longer than the configured timeout to process an event, it is blacklisted. Once a handler is in a blacklist, it doesn't get sent any events anymore.
The Felix Event Admin can be configured either through framework properties or through the configuration admin. This is a list of configuration properties:
|Function|Property Name|Type and Default|Description|
|--|--|--|
|Cache Size|org.apache.felix.eventadmin.CacheSize|Integer, 30|The size of various internal caches. The default value is 30. Increase in case of a large number (more then 100) of services. A value less then 10 triggers the default value.|
|Thread Pool Size|org.apache.felix.eventadmin.ThreadPoolSize|Integer, 10|The size of the thread pool. The default value is 10. Increase in case of a large amount of synchronous events where the event handler services in turn send new synchronous events in the event dispatching thread or a lot of timeouts are to be expected. A value of less then 2 triggers the default value. A value of 2 effectively disables thread pooling.|
|Timeout|org.apache.felix.eventadmin.Timeout|Integer, 5000|The black-listing timeout in milliseconds. The default value is 5000. Increase or decrease at own discretion. A value of less then 100 turns timeouts off. Any other value is the time in milliseconds granted to each event handler before it gets blacklisted.|
|Require Topic|org.apache.felix.eventadmin.RequireTopic|Boolean, true|Are event handlers required to be registered with a topic? This is enabled by default. The specification says that event handlers must register with a list of topics they are interested in. Disabling this setting will enable that handlers without a topic are receiving all events (i.e., they are treated the same as with a topic=*).|
|Ignore Timeouts|org.apache.felix.eventadmin.IgnoreTimeout|String, empty|Configure event handlers to be called without a timeout. If a timeout is configured by default all event handlers are called using the timeout. For performance optimization it is possible to configure event handlers where the timeout handling is not used - this reduces the thread usage from the thread pools as the timout handling requires an additional thread to call the event handler. However, the application should work without this configuration property. It is a pure optimization! The value is a list of strings. If a string ends with a dot, all handlers in exactly this package are ignored. If the string ends with a star, all handlers in this package and all subpackages are ignored. If the string neither ends with a dot nor with a start, this is assumed to define an exact class name.|</p>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1422427 by fmeschbe on Sun, 16 Dec 2012 00:36:51 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
