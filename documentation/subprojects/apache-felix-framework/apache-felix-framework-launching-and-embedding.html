<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       https://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Apache Felix Framework Launching and Embedding</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="https://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="https://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><a href="/news.html">News</a>  <br />
<a href="/license.html">License</a>  <br />
<a href="/downloads.cgi">Downloads</a>  <br />
<a href="/documentation.html">Documentation</a>  <br />
<a href="/documentation/community/project-info.html">Project Info</a>  <br />
<a href="/documentation/community/contributing.html">Contributing</a>  <br />
<a href="/sitemap.html">Site Map</a>  <br />
<a href="https://www.apache.org/">ASF</a>  <br />
<a href="https://www.apache.org/security/">Security</a>  <br />
<a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>  <br />
<a href="https://www.apache.org/foundation/thanks.html">Sponsors</a>    </p>
<iframe
    src="https://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-framework.html">Apache Felix Framework</a>
      </div>

      <h1>Apache Felix Framework Launching and Embedding</h1>
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><em>[This document describes framework launching introduced in Felix Framework 2.0.0 and continuing with the latest releases; it is incompatible with older versions of the Felix framework.]()</em></p>
<ul>
<li><a href="">Introduction</a></li>
<li><a href="">OSGi Launching and Embedding API Overview</a>
<strong> <a href="">Creating and Configuring the Framework Instance</a>
</strong> <a href="">Starting the Framework Instance</a>
** <a href="">Stopping the Framework Instance</a></li>
<li><a href="">Launching Felix</a>
<strong> <a href="">Standard Felix Launcher</a>
</strong> <a href="">Custom Felix Launcher</a></li>
<li><a href="">Embedding Felix</a>
<strong> <a href="">Host/Felix Interaction</a>
</strong> <a href="">Providing Host Application Services</a>
** <a href="">Using Services Provided by Bundles</a>
<strong><em> <a href="">Using Bundle Services via Reflection</a>
</em></strong> <a href="">Other Approaches</a></li>
<li><a href="">Caveat</a></li>
<li><a href="">Feedback</a></li>
</ul>
<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>The Apache Felix Framework is intended to be easily launchable and embeddable. For example, the Felix framework implementation avoids the use of system properties for configuration, since these are globals and can cause interference if multiple framework instances are created in the same VM. The framework also tries to multiplex singleton facilities, like the URL stream handler factory. The goal is to make it possible to use the framework in a variety of scenarios; however, this is still just a goal. In other words, this is a work in progress and if any issues arise, it would be greatly appreciated if they are brought to the attention of the Felix community. The next section provides an overview of the standard OSGi launching and embedding API for frameworks, while the remainder of the document is divided into two sections, one focusing on how to launch Felix and one focusing on how to embed Felix into a host application.</p>
<h1 id="osgi-launching-and-embedding-api-overview">OSGi Launching and Embedding API Overview<a class="headerlink" href="#osgi-launching-and-embedding-api-overview" title="Permanent link">&para;</a></h1>
<p>The Felix framework is implemented by the <code>org.apache.felix.framework.Felix</code> class or just <code>Felix</code> for short. As part of the R4.2 OSGi specification, the launching and embedding API of the OSGi framework has been standardized. The approach is to have the framework implement the <code>org.osgi.framework.launch.Framework</code> interface, which extends the <code>org.osgi.framework.Bundle</code> interface. These interfaces provide the necessary means to launch and manage framework instances. The <code>Bundle</code> interface is defined as:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">interface</span> <span class="n">Bundle</span>
<span class="p">{</span>
    <span class="n">BundleContext</span> <span class="n">getBundleContext</span><span class="p">();</span>
    <span class="n">long</span> <span class="n">getBundleId</span><span class="p">();</span>
    <span class="n">URL</span> <span class="n">getEntry</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Enumeration</span> <span class="n">getEntryPaths</span><span class="p">(</span><span class="n">String</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">Enumeration</span> <span class="n">findEntries</span><span class="p">(</span><span class="n">String</span> <span class="n">path</span><span class="p">,</span> <span class="n">String</span> <span class="n">filePattern</span><span class="p">,</span> <span class="n">boolean</span> <span class="n">recurse</span><span class="p">);</span>
    <span class="n">Dictionary</span> <span class="n">getHeaders</span><span class="p">();</span>
    <span class="n">Dictionary</span> <span class="n">getHeaders</span><span class="p">(</span><span class="n">String</span> <span class="n">locale</span><span class="p">);</span>
    <span class="n">long</span> <span class="n">getLastModified</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">getLocation</span><span class="p">();</span>
    <span class="n">URL</span> <span class="n">getResource</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Enumeration</span> <span class="n">getResources</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span><span class="p">;</span>
    <span class="n">ServiceReference</span><span class="p">[]</span> <span class="n">getRegisteredServices</span><span class="p">();</span>
    <span class="n">ServiceReference</span><span class="p">[]</span> <span class="n">getServicesInUse</span><span class="p">();</span>
    <span class="n">int</span> <span class="n">getState</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">getSymbolicName</span><span class="p">();</span>
    <span class="n">Version</span> <span class="n">getVersion</span><span class="p">();</span>
    <span class="n">boolean</span> <span class="n">hasPermission</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">);</span>
    <span class="n">Class</span> <span class="n">loadClass</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="n">throws</span> <span class="n">ClassNotFoundException</span><span class="p">;</span>
    <span class="n">void</span> <span class="n">start</span><span class="p">()</span> <span class="n">throws</span> <span class="n">BundleException</span><span class="p">;</span>
    <span class="n">void</span> <span class="n">stop</span><span class="p">()</span> <span class="n">throws</span> <span class="n">BundleException</span><span class="p">;</span>
    <span class="n">void</span> <span class="n">uninstall</span><span class="p">()</span> <span class="n">throws</span> <span class="n">BundleException</span><span class="p">;</span>
    <span class="n">void</span> <span class="n">update</span><span class="p">()</span> <span class="n">throws</span> <span class="n">BundleException</span><span class="p">;</span>
    <span class="n">void</span> <span class="n">update</span><span class="p">(</span><span class="n">InputStream</span> <span class="n">is</span><span class="p">)</span> <span class="n">throws</span> <span class="n">BundleException</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>The <code>Framework</code> interface is defined as:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">interface</span> <span class="n">Framework</span> <span class="n">extends</span> <span class="n">Bundle</span>
<span class="p">{</span>
    <span class="n">void</span> <span class="n">init</span><span class="p">();</span>
    <span class="n">FrameworkEvent</span> <span class="n">waitForStop</span><span class="p">(</span><span class="n">long</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>To actually construct a framework instance, the R4.2 specification defines the <code>FrameworkFactory</code> interface:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">interface</span> <span class="n">FrameworkFactory</span>
<span class="p">{</span>
    <span class="n">Framework</span> <span class="n">newFramework</span><span class="p">(</span><span class="n">Map</span> <span class="n">config</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>The framework factory can be used to create configured framework instances. It is obtained following the standard <code>META-INF/services</code> approach.</p>
<h2 id="creating-and-configuring-the-framework-instance">Creating and Configuring the Framework Instance<a class="headerlink" href="#creating-and-configuring-the-framework-instance" title="Permanent link">&para;</a></h2>
<p>You use the framework factory to construct and configure a framework instance (or by directly instantiating the Felix class). The configuration map may contain any of the framework configuration properties listed in the <a href="/documentation/subprojects/apache-felix-framework/apache-felix-framework-configuration-properties.html">Apache Felix Framework Configuration Properties</a> document, not the launcher configuration properties. The configuration map is copied and the keys are treated as case insensitive. You are not able to change the framework's configuration after construction. If you need a different configuration, you must create a new framework instance.</p>
<div class="warning" markdown="1">
**WARNING**
Felix configuration properties have change considerably starting from `1.4.0`; if you are upgrading from an earlier version, the [configuration property document]() describes the configuration property changes.
</div>

<h2 id="starting-the-framework-instance">Starting the Framework Instance<a class="headerlink" href="#starting-the-framework-instance" title="Permanent link">&para;</a></h2>
<p>The <code>start()</code> method is used to start the framework instance. If the <code>init()</code> method was not invoked prior to calling <code>start()</code>, then it is invoked by <code>start()</code>. The two methods result in two different framework state transitions:</p>
<ul>
<li><code>init()</code> results in the framework instance in the <code>Bundle.STARTING</code> state.</li>
<li><code>start()</code> results in the framework instance in the <code>Bundle.ACTIVE</code> state.</li>
</ul>
<p>The <code>init()</code> method is necessary since the framework does not have a <code>BundleContext</code> when it is first created, so a transition to the <code>Bundle.STARTING</code> state is required to acquire its context (via <code>Bundle.getBundleContext()</code>) for performing various tasks, such as installing bundles. Note that the Felix framework also provides the <code>felix.systembundle.activators</code> property that serves a similar purpose, but is not standard. After the <code>init()</code> method completes, the follow actions have been performed:</p>
<ul>
<li>Event handling is enabled.</li>
<li>The security manager is installed if it is enabled.</li>
<li>The framework is set to start level 0.</li>
<li>All bundles in the bundle caches are reified and their state is set to <code>Bundle.INSTALLED</code>.</li>
<li>The framework gets a valid <code>BundleContext</code>.</li>
<li>All framework-provided services are made available (e.g., PackageAdmin, StartLevel, etc.).</li>
<li>The framework enters the <code>Bundle.STARTING</code> state.</li>
</ul>
<p>A call to <code>start()</code> is necessary to start the framework instance, if the <code>init()</code> method is invoked manually. Invoking <code>init()</code> or <code>start()</code> on an already started framework as no effect.</p>
<h2 id="stopping-the-framework-instance">Stopping the Framework Instance<a class="headerlink" href="#stopping-the-framework-instance" title="Permanent link">&para;</a></h2>
<p>To stop the framework instance, invoke the <code>stop()</code> method, which will asynchronously stop the framework. To know when the framework has finished its shutdown sequence, use the <code>waitForStop()</code> method to wait until it is complete. A stopped framework will be in the <code>Bundle.RESOLVED</code> state. It is possible to restart the framework, using the normal combination of <code>init()</code>/<code>start()</code> methods as previously described.</p>
<h1 id="launching-a-framework">Launching a Framework<a class="headerlink" href="#launching-a-framework" title="Permanent link">&para;</a></h1>
<p>Launching a framework is fairly simple and involves only four steps:</p>
<ol>
<li>Define some configuration properties.</li>
<li>Obtain framework factory.</li>
<li>Use factory to create framework with the configuration properties.</li>
<li>Invoke the <code>Framework.start()</code> method.</li>
</ol>
<p>In reality, the first step is optional, since all properties will have reasonable defaults, but if you are creating a launcher you will generally want to more than that, such as automatically installing and starting bundles when you start the framework instance. The default Felix launcher defines reusable functionality to automatically install and/or start bundles upon framework startup; see the <a href="">usage document</a> for more information on configuring the Felix framework and on the various configuration properties.</p>
<p>The remainder of this section describes how the standard Felix launcher works as well as how to create a custom launcher.</p>
<h2 id="standard-felix-framework-launcher">Standard Felix Framework Launcher<a class="headerlink" href="#standard-felix-framework-launcher" title="Permanent link">&para;</a></h2>
<p>The standard Felix framework launcher is very simple and is not intended to solve every possible requirement; it is intended to work for most standard situations. Most special launching requirements should be resolved by creating a custom launcher. This section describes how the standard launcher works. The following code represents the complete <code>main()</code> method of the standard launcher, each numbered comment will be described in more detail below:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="p">(</span>1<span class="p">)</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">command</span> <span class="n">line</span> <span class="n">arguments</span> <span class="n">and</span> <span class="n">verify</span> <span class="n">usage</span><span class="p">.</span>
    <span class="n">String</span> <span class="n">bundleDir</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">cacheDir</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">boolean</span> <span class="n">expectBundleDir</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="nb">i</span> <span class="p">=</span> 0<span class="p">;</span> <span class="nb">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="nb">length</span><span class="p">;</span> <span class="nb">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="nb">i</span><span class="p">].</span><span class="n">equals</span><span class="p">(</span><span class="n">BUNDLE_DIR_SWITCH</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">expectBundleDir</span> <span class="p">=</span> <span class="n">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">expectBundleDir</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">bundleDir</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="nb">i</span><span class="p">];</span>
            <span class="n">expectBundleDir</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">cacheDir</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="nb">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="p">.</span><span class="nb">length</span> <span class="o">&gt;</span> 3<span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">expectBundleDir</span> <span class="o">&amp;&amp;</span> <span class="n">bundleDir</span> <span class="o">==</span> <span class="n">null</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Usage</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span> <span class="o">&lt;</span><span class="n">bundle</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="n">dir</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">bundle</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">dir</span><span class="o">&gt;</span><span class="p">]</span>&quot;<span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="p">(</span>2<span class="p">)</span> <span class="n">Load</span> <span class="n">system</span> <span class="k">properties</span><span class="p">.</span>
    <span class="n">Main</span><span class="p">.</span><span class="n">loadSystemProperties</span><span class="p">();</span>

    <span class="o">//</span> <span class="p">(</span>3<span class="p">)</span> <span class="n">Read</span> <span class="n">configuration</span> <span class="k">properties</span><span class="p">.</span>
    <span class="n">Properties</span> <span class="n">configProps</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">loadConfigProperties</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">configProps</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">No</span> &quot; <span class="o">+</span> <span class="n">CONFIG_PROPERTIES_FILE_VALUE</span> <span class="o">+</span> &quot; <span class="n">found</span><span class="p">.</span>&quot;<span class="p">);</span>
        <span class="n">configProps</span> <span class="p">=</span> <span class="n">new</span> <span class="n">Properties</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="p">(</span>4<span class="p">)</span> <span class="n">Copy</span> <span class="n">framework</span> <span class="k">properties</span> <span class="n">from</span> <span class="n">the</span> <span class="n">system</span> <span class="k">properties</span><span class="p">.</span>
    <span class="n">Main</span><span class="p">.</span><span class="n">copySystemProperties</span><span class="p">(</span><span class="n">configProps</span><span class="p">);</span>

    <span class="o">//</span> <span class="p">(</span>5<span class="p">)</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">auto</span><span class="o">-</span><span class="n">deploy</span> <span class="n">directory</span> <span class="n">over</span> <span class="n">default</span><span class="p">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bundleDir</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">configProps</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">AutoProcessor</span><span class="p">.</span><span class="n">AUTO_DEPLOY_DIR_PROPERY</span><span class="p">,</span> <span class="n">bundleDir</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="p">(</span>6<span class="p">)</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">bundle</span> <span class="n">cache</span> <span class="n">directory</span> <span class="n">over</span> <span class="n">default</span><span class="p">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cacheDir</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">configProps</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">FRAMEWORK_STORAGE</span><span class="p">,</span> <span class="n">cacheDir</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="p">(</span>7<span class="p">)</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">shutdown</span> <span class="n">hook</span> <span class="n">to</span> <span class="n">clean</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">framework</span><span class="p">.</span>
    <span class="n">String</span> <span class="n">enableHook</span> <span class="p">=</span> <span class="n">configProps</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">SHUTDOWN_HOOK_PROP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">enableHook</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="o">||</span> !<span class="n">enableHook</span><span class="p">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span>&quot;<span class="n">false</span>&quot;<span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Runtime</span><span class="p">.</span><span class="n">getRuntime</span><span class="p">().</span><span class="n">addShutdownHook</span><span class="p">(</span><span class="n">new</span> <span class="n">Thread</span><span class="p">(</span>&quot;<span class="n">Felix</span> <span class="n">Shutdown</span> <span class="n">Hook</span>&quot;<span class="p">)</span> <span class="p">{</span>
            <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">m_fwk</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">m_fwk</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
                        <span class="n">m_fwk</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Error</span> <span class="n">stopping</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="p">(</span>8<span class="p">)</span> <span class="n">Create</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">and</span> <span class="n">initialize</span> <span class="n">the</span> <span class="n">framework</span><span class="p">.</span>
        <span class="n">FrameworkFactory</span> <span class="n">factory</span> <span class="p">=</span> <span class="n">getFrameworkFactory</span><span class="p">();</span>
        <span class="n">m_fwk</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">newFramework</span><span class="p">(</span><span class="n">configProps</span><span class="p">);</span>
        <span class="n">m_fwk</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>
        <span class="o">//</span> <span class="p">(</span>9<span class="p">)</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">system</span> <span class="n">bundle</span> <span class="n">context</span> <span class="n">to</span> <span class="n">process</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">deploy</span>
        <span class="o">//</span> <span class="n">and</span> <span class="n">auto</span><span class="o">-</span><span class="n">install</span><span class="o">/</span><span class="n">auto</span><span class="o">-</span><span class="n">start</span> <span class="k">properties</span><span class="p">.</span>
        <span class="n">AutoProcessor</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">configProps</span><span class="p">,</span> <span class="n">m_fwk</span><span class="p">.</span><span class="n">getBundleContext</span><span class="p">());</span>
        <span class="o">//</span> <span class="p">(</span>10<span class="p">)</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">framework</span><span class="p">.</span>
        <span class="n">m_fwk</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
        <span class="o">//</span> <span class="p">(</span>11<span class="p">)</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">framework</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">to</span> <span class="n">exit</span> <span class="n">the</span> <span class="n">VM</span><span class="p">.</span>
        <span class="n">m_fwk</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="n">create</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
        <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The general steps of the standard launcher are quite straightforward:</p>
<ol>
<li>The launcher supports setting the auto-deploy directory (with the <code>-b</code> switch) and setting the bundle cache path with a single argument, so check for this and issue a usage message it there are more than one arguments.</li>
<li>Load any system properties specified in the <code>system.properties</code> file; this file is typically located in the <code>conf/</code> directory of the Felix installation directory, but it can be specified directly using the <code>felix.system.properties</code> system property. This file is not needed to launch Felix and is provided merely for convenience when system properties must be specified. The file is a standard Java properties file, but it also supports property substitution using <code>$\{&lt;property-name</code>} syntax. Property substitution can be nested; only system properties will be used for substitution.</li>
<li>Load any configuration properties specified in the <code>config.properties</code> file; this file is typically located in the <code>conf/</code> directory of the Felix installation directory, but it can be specified directly using the <code>felix.config.properties</code> system property. This file is used to configure the framework instance created by the launcher. The file is a standard Java properties file, but it also supports property substitution using "<code>$\{&lt;property-name&gt;</code>}" syntax. Property substitution can be nested; configuration and system properties will be used for substitution with configuration properties having precedence.</li>
<li>For convenience, any configuration properties that are set as system properties are copied into the set of configuration properties. This provide an easy way to add to or override configuration properties specified in the <code>config.properties</code> file, since the Felix instance will never look at system properties for configuration.</li>
<li>If the <code>-b</code> switch was used to specify an auto-deploy directory, then use that to set the value of <code>felix.auto.deploy.dir</code>.</li>
<li>If a single command-line argument is specified, then use that to set the value of <code>org.osgi.framework.storage</code>; relative paths are relative to the current directory unless the <code>felix.cache.rootdir</code> property is set.</li>
<li>Add a shutdown hook to cleanly stop the framework, unless the hook is disabled.</li>
<li>Create a framework instance using the <code>FrameworkFactory</code> passing in the configuration properties, then initialize the factory instance; see the <a href="">custom launcher example</a> below to see how the META-INF/services <code>FrameworkFactory</code> is obtained.</li>
<li>Use <code>org.apache.felix.main.AutoProcessor</code>, which will automatically deploy any bundles in the auto-deploy directory as well as bundles specified in the <code>felix.auto.install</code> and <code>felix.auto.start</code> configuration properties during framework startup to automatically install and/or start bundles; see the usage document for more information <a href="">configuration properties</a> and [bundle auto-deploy|Apache Felix Framework Usage Documentation#auto-deploy].</li>
<li>Invoke <code>waitForStop()</code> to wait for the framework to stop to force the VM to exit; this is necessary because the framework never calls <code>System.exit()</code> and some libraries (e.g., Swing) create threads that will not allow the VM to exit.</li>
</ol>
<p>The framework is not active until the <code>start()</code> method is called. If no shell bundles are installed and started or if there is difficulty locating the shell bundles specified in the auto-start property, then it will appear as if the framework is hung, but it is actually running without any way to interact with it since the shell bundles provide the only means of interaction.</p>
<h2 id="custom-framework-launcher">Custom Framework Launcher<a class="headerlink" href="#custom-framework-launcher" title="Permanent link">&para;</a></h2>
<p>This section creates a bare-bones launcher to demonstrate the minimum requirements for creating an interactive launcher for the Felix framework. This example uses the standard Gogo shell bundles for interactivity, but any other bundles could be used instead. This example launcher project has the following directory structure:</p>
<div class="codehilite"><pre><span class="n">launcher</span><span class="o">/</span>
   <span class="n">lib</span><span class="o">/</span>
      <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">main</span><span class="o">-</span>3<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span>
   <span class="n">bundle</span><span class="o">/</span>
      <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">command</span><span class="o">-</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span>
      <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="o">-</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span>
      <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">shell</span><span class="o">-</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span>
   <span class="n">src</span><span class="o">/</span>
      <span class="n">example</span><span class="o">/</span>
         <span class="n">Main</span><span class="p">.</span><span class="n">java</span>
</pre></div>


<p>The <code>lib/</code> directory contains Felix' main JAR file, which also contains the OSGi core interfaces. The main JAR file is used so that we can reuse the default launcher's auto-install/auto-start configuration property handling; if these capabilities are not needed, then it would be possible to use the framework JAR file instead of the main JAR file. The <code>bundle/</code> directory contains the shell service and textual shell interface bundles that will be used for interacting with the framework instance. Note: If you do not launch the framework with interactive bundles, it will appear as if the framework instance is hung, but it is actually just sitting there waiting for someone to tell it to do something. The <code>src/example/</code> directory contains the following <code>Main.java</code> file, which is a very simplistic framework launcher.</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">example</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="o">.*</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">launch</span><span class="o">.*</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">AutoProcessor</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">Main</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">Framework</span> <span class="n">m_fwk</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">argv</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Print</span> <span class="n">welcome</span> <span class="n">banner</span><span class="p">.</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="o">\</span><span class="n">nWelcome</span> <span class="n">to</span> <span class="n">My</span> <span class="n">Launcher</span>&quot;<span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="o">======================\</span><span class="n">n</span>&quot;<span class="p">);</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">m_fwk</span> <span class="p">=</span> <span class="n">getFrameworkFactory</span><span class="p">().</span><span class="n">newFramework</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>
            <span class="n">m_fwk</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>
            <span class="n">AutoProcessor</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">m_fwk</span><span class="p">.</span><span class="n">getBundleContext</span><span class="p">());</span>
            <span class="n">m_fwk</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
            <span class="n">m_fwk</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span>0<span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="n">create</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
            <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span>1<span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">static</span> <span class="n">FrameworkFactory</span> <span class="n">getFrameworkFactory</span><span class="p">()</span> <span class="n">throws</span> <span class="n">Exception</span>
    <span class="p">{</span>
        <span class="n">java</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">URL</span> <span class="n">url</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">getClassLoader</span><span class="p">().</span><span class="n">getResource</span><span class="p">(</span>
            &quot;<span class="n">META</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">launch</span><span class="p">.</span><span class="n">FrameworkFactory</span>&quot;<span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">url</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="p">=</span> <span class="n">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">openStream</span><span class="p">()));</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">s</span> <span class="p">=</span> <span class="n">br</span><span class="p">.</span><span class="n">readLine</span><span class="p">();</span> <span class="n">s</span> !<span class="p">=</span> <span class="n">null</span><span class="p">;</span> <span class="n">s</span> <span class="p">=</span> <span class="n">br</span><span class="p">.</span><span class="n">readLine</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">s</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
                    <span class="o">//</span> <span class="n">Try</span> <span class="n">to</span> <span class="n">load</span> <span class="n">first</span> <span class="n">non</span><span class="o">-</span><span class="n">empty</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">commented</span> <span class="n">line</span><span class="p">.</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="p">.</span><span class="nb">length</span><span class="p">()</span> <span class="o">&gt;</span> 0<span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">charAt</span><span class="p">(</span>0<span class="p">)</span> !<span class="p">=</span> <span class="s">&#39;#&#39;</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">FrameworkFactory</span><span class="p">)</span> <span class="n">Class</span><span class="p">.</span><span class="n">forName</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="n">newInstance</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">finally</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">br</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span> <span class="n">br</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">throw</span> <span class="n">new</span> <span class="n">Exception</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="nb">find</span> <span class="n">framework</span> <span class="n">factory</span><span class="p">.</span>&quot;<span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This launcher relies on the default behavior of <code>AutoProcessor</code> to automatically deploy the shell bundles. This simple, generic launcher provides a good starting point if the default Felix launcher is not sufficient. Since very few configuration properties are specified, the default values are used. For the bundle auto-deploy directory, "<code>bundle</code>" in the current directory is used, while for the framework bundle cache, "<code>felix-cache</code>" in the current directory is used.</p>
<p>By breaking down the above source code into small chunks, it is quite easy to see what is going on.</p>
<div class="codehilite"><pre>            <span class="n">m_fwk</span> <span class="p">=</span> <span class="n">getFrameworkFactory</span><span class="p">().</span><span class="n">newFramework</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>
            <span class="n">m_fwk</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>


<p>These steps get a the framework factory service and use it to create a framework instance with a default configuration. Once the framework instance is created, it is initialized with <code>init()</code>.</p>
<div class="codehilite"><pre>            <span class="n">AutoProcessor</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">m_fwk</span><span class="p">.</span><span class="n">getBundleContext</span><span class="p">());</span>
</pre></div>


<p>The <code>AutorProcessor</code> will automatically deploy bundles in the auto-deploy directory and any referenced from the auto-install/start properties. Since we are using an empty configuration, the auto-deploy directory is the <code>bundle</code> directory in the current directory and there are no auto properties. Therefore, in this case, the shell bundles will be installed.</p>
<div class="codehilite"><pre>            <span class="n">m_fwk</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
            <span class="n">m_fwk</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span>0<span class="p">);</span>
</pre></div>


<p>These final steps start the framework and cause the launching application thread to wait for the framework to stop and when it does the launching thread calls <code>System.exit()</code> to make sure the VM actually exits.</p>
<div class="codehilite"><pre>    <span class="n">private</span> <span class="n">static</span> <span class="n">FrameworkFactory</span> <span class="n">getFrameworkFactory</span><span class="p">()</span> <span class="n">throws</span> <span class="n">Exception</span>
    <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
</pre></div>


<p>This method retrieves the framework factory service by doing a META-INF/services resource lookup, which it can use to obtain the concrete class name for the factory. If you are using Java 6, then you can use the <code>ServiceLoader</code> API in the JRE to further simplify the factory service lookup.</p>
<p>The following command compiles the launcher when run from the root directory of the launcher project:</p>
<div class="codehilite"><pre><span class="n">javac</span> <span class="o">-</span><span class="n">d</span> <span class="p">.</span> <span class="o">-</span><span class="n">classpath</span> <span class="n">lib</span><span class="o">/</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">main</span><span class="o">-</span>3<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span> <span class="n">src</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">Main</span><span class="p">.</span><span class="n">java</span>
</pre></div>


<p>After executing this command, an <code>example/</code> directory is created in the current directory, which contains the generated class file. The following command executes the simple launcher when run from the root directory of the launcher project:</p>
<div class="codehilite"><pre><span class="n">java</span> <span class="o">-</span><span class="n">cp</span> <span class="p">.:</span><span class="n">lib</span><span class="o">/</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">main</span><span class="o">-</span>3<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span> <span class="n">example</span><span class="p">.</span><span class="n">Main</span>
</pre></div>


<p>After executing this command, a "<code>felix-cache/</code>" directory is created that contains the cached bundles, which were installed from the <code>bundle/</code> directory.</p>
<h1 id="embedding-the-felix-framework">Embedding the Felix Framework<a class="headerlink" href="#embedding-the-felix-framework" title="Permanent link">&para;</a></h1>
<p>Embedding the Felix framework into a host application is a simple way to provide a sophisticated extensibility mechanism (i.e., a plugin system) to the host application. Embedding the Felix framework is very similar to launching it as described above, the main difference is that the host application typically wants to interact with the framework instance and/or installed bundles/services from the outside. This is fairly easy to achieve, but there are some subtle issues to understand. This section presents the mechanisms for embedding Felix into a host application and the issues in doing so.</p>
<h2 id="hostfelix-interaction">Host/Felix Interaction<a class="headerlink" href="#hostfelix-interaction" title="Permanent link">&para;</a></h2>
<p>In the section on <a href="">launching</a> the framework above, the <code>Felix</code> class accepts a configuration property called <code>felix.systembundle.activators</code>, which is a list of bundle activator instances. These bundle activator instances provide a convenient way for host applications to interact with the Felix framework.</p>
<div class="warning" markdown="1">
**WARNING**
The `felix.systembundle.activators` configuration property is specific to the Felix framework implementation. If you want your code to work with other framework implementations, you should call `init()` on the framework instance and use `getBundleContext()` directly. Otherwise, the approach would be very similar.
</div>

<p>Each activator instance passed into the constructor effectively becomes part of the system bundle. This means that the <code>start()</code>/<code>stop()</code> methods of each activator instance in the list gets invoked when the system bundle's activator <code>start()</code>/<code>stop()</code> methods gets invoked, respectively. Each activator instance will be given the system bundle's <code>BundleContext</code> object so that they can interact with the framework. Consider following snippet of a bundle activator:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">HostActivator</span> <span class="n">implements</span> <span class="n">BundleActivator</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">BundleContext</span> <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">start</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">stop</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">Bundle</span><span class="p">[]</span> <span class="n">getBundles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_context</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">m_context</span><span class="p">.</span><span class="n">getBundles</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Given the above bundle activator, it is now possible to embed the Felix framework into a host application and interact with it as the following snippet illustrates:</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">HostApplication</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">HostActivator</span> <span class="n">m_activator</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Felix</span> <span class="n">m_felix</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">HostApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">property</span> <span class="n">map</span><span class="p">.</span>
        <span class="n">Map</span> <span class="n">config</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">();</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">host</span> <span class="n">activator</span><span class="p">;</span>
        <span class="n">m_activator</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HostActivator</span><span class="p">();</span>
        <span class="n">List</span> <span class="n">list</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="p">();</span>
        <span class="n">list</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">m_activator</span><span class="p">);</span>
        <span class="n">configMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">FelixConstants</span><span class="p">.</span><span class="n">SYSTEMBUNDLE_ACTIVATORS_PROP</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">create</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">framework</span> <span class="n">with</span>
            <span class="o">//</span> <span class="n">our</span> <span class="n">configuration</span> <span class="k">properties</span><span class="p">.</span>
            <span class="n">m_felix</span> <span class="p">=</span> <span class="n">new</span> <span class="n">Felix</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">start</span> <span class="n">Felix</span> <span class="n">instance</span><span class="p">.</span>
            <span class="n">m_felix</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="n">create</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
            <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">Bundle</span><span class="p">[]</span> <span class="n">getInstalledBundles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">system</span> <span class="n">bundle</span> <span class="n">activator</span> <span class="n">to</span> <span class="n">gain</span> <span class="n">external</span>
        <span class="o">//</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">set</span> <span class="n">of</span> <span class="n">installed</span> <span class="n">bundles</span><span class="p">.</span>
        <span class="k">return</span> <span class="n">m_activator</span><span class="p">.</span><span class="n">getBundles</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">shutdownApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Shut</span> <span class="n">down</span> <span class="n">the</span> <span class="n">felix</span> <span class="n">framework</span> <span class="n">when</span> <span class="n">stopping</span> <span class="n">the</span>
        <span class="o">//</span> <span class="n">host</span> <span class="n">application</span><span class="p">.</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Notice how the <code>HostApplication.getInstalledBundles()</code> method uses its activator instance to get access to the system bundle's context in order to interact with the embedded Felix framework instance. This approach provides the foundation for all interaction between the host application and the embedded framework instance.</p>
<h2 id="providing-host-application-services">Providing Host Application Services<a class="headerlink" href="#providing-host-application-services" title="Permanent link">&para;</a></h2>
<p>Providing services from the host application to bundles inside the embedded Felix framework instance follows the basic approach laid out in <a href="">above</a>. The main complication for providing a host application service to bundles is the fact that both the host application and the bundles must be using the same class definitions for the service interface classes. Since the host application cannot import classes from a bundle, this means that the service interface classes <em>must</em> be accessible on the class path, typically as part of the host application itself. The host application then must export the service interface package via the system bundle so that bundles installed into the embedded framework instance can import it. This is achieved using the <code>org.osgi.framework.system.packages.extra</code> configuration property previously presented.</p>
<p>Consider the follow simple property lookup service:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">lookup</span><span class="p">;</span>

<span class="n">public</span> <span class="n">interface</span> <span class="n">Lookup</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">Object</span> <span class="n">lookup</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>This package is simply part of the host application, which is potentially packaged into a JAR file and started with the "<code>java -jar</code>" command. Now consider the following host application bundle activator, which will be used to register/unregister the property lookup service when the embedded framework instance starts/stops:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">core</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Map</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">BundleActivator</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">BundleContext</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">ServiceRegistration</span><span class="p">;</span>
<span class="n">import</span> <span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">lookup</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">HostActivator</span> <span class="n">implements</span> <span class="n">BundleActivator</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">Map</span> <span class="n">m_lookupMap</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">BundleContext</span> <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">ServiceRegistration</span> <span class="n">m_registration</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">HostActivator</span><span class="p">(</span><span class="n">Map</span> <span class="n">lookupMap</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">the</span> <span class="n">service</span><span class="o">&#39;</span><span class="n">s</span> <span class="n">backing</span> <span class="n">store</span><span class="p">.</span>
        <span class="n">m_lookupMap</span> <span class="p">=</span> <span class="n">lookupMap</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">start</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">the</span> <span class="n">bundle</span> <span class="n">context</span><span class="p">.</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">property</span> <span class="n">lookup</span> <span class="n">service</span> <span class="n">implementation</span><span class="p">.</span>
        <span class="n">Lookup</span> <span class="n">lookup</span> <span class="p">=</span> <span class="n">new</span> <span class="n">Lookup</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">public</span> <span class="n">Object</span> <span class="n">lookup</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">m_lookupMap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="o">//</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">property</span> <span class="n">lookup</span> <span class="n">service</span> <span class="n">and</span> <span class="n">save</span>
        <span class="o">//</span> <span class="n">the</span> <span class="n">service</span> <span class="n">registration</span><span class="p">.</span>
        <span class="n">m_registration</span> <span class="p">=</span> <span class="n">m_context</span><span class="p">.</span><span class="n">registerService</span><span class="p">(</span>
            <span class="n">Lookup</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">stop</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Unregister</span> <span class="n">the</span> <span class="n">property</span> <span class="n">lookup</span> <span class="n">service</span><span class="p">.</span>
        <span class="n">m_registration</span><span class="p">.</span><span class="n">unregister</span><span class="p">();</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Given the above host application bundle activator, the following code snippet shows how the host application could create an embedded version of the Felix framework and provide the property lookup service to installed bundles:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">core</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">List</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Map</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">HashMap</span><span class="p">;</span>
<span class="n">import</span> <span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">lookup</span><span class="p">.</span><span class="n">Lookup</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">Felix</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">FelixConstants</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">Constants</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">HostApplication</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">HostActivator</span> <span class="n">m_activator</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Felix</span> <span class="n">m_felix</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Map</span> <span class="n">m_lookupMap</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">();</span>

    <span class="n">public</span> <span class="n">HostApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Initialize</span> <span class="n">the</span> <span class="n">map</span> <span class="k">for</span> <span class="n">the</span> <span class="n">property</span> <span class="n">lookup</span> <span class="n">service</span><span class="p">.</span>
        <span class="n">m_lookupMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>&quot;<span class="n">name1</span>&quot;<span class="p">,</span> &quot;<span class="n">value1</span>&quot;<span class="p">);</span>

        <span class="n">m_lookupMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>&quot;<span class="n">name2</span>&quot;<span class="p">,</span> &quot;<span class="n">value2</span>&quot;<span class="p">);</span>
        <span class="n">m_lookupMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>&quot;<span class="n">name3</span>&quot;<span class="p">,</span> &quot;<span class="n">value3</span>&quot;<span class="p">);</span>
        <span class="n">m_lookupMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>&quot;<span class="n">name4</span>&quot;<span class="p">,</span> &quot;<span class="n">value4</span>&quot;<span class="p">);</span>

        <span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">property</span> <span class="n">map</span><span class="p">.</span>
        <span class="n">Map</span> <span class="n">configMap</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">();</span>
        <span class="o">//</span> <span class="n">Export</span> <span class="n">the</span> <span class="n">host</span> <span class="n">provided</span> <span class="n">service</span> <span class="n">interface</span> <span class="n">package</span><span class="p">.</span>
        <span class="n">configMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">FRAMEWORK_SYSTEMPACKAGES_EXTRA</span><span class="p">,</span>
            &quot;<span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">lookup</span><span class="p">;</span> <span class="n">version</span><span class="p">=</span>1<span class="p">.</span>0<span class="p">.</span>0&quot;<span class="p">);</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">host</span> <span class="n">activator</span><span class="p">;</span>
        <span class="n">m_activator</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HostActivator</span><span class="p">(</span><span class="n">m_lookupMap</span><span class="p">);</span>
        <span class="n">List</span> <span class="n">list</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="p">();</span>
        <span class="n">list</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">m_activator</span><span class="p">);</span>
        <span class="n">configMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">FelixConstants</span><span class="p">.</span><span class="n">SYSTEMBUNDLE_ACTIVATORS_PROP</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">create</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">framework</span> <span class="n">with</span>
            <span class="o">//</span> <span class="n">our</span> <span class="n">configuration</span> <span class="k">properties</span><span class="p">.</span>
            <span class="n">m_felix</span> <span class="p">=</span> <span class="n">new</span> <span class="n">Felix</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">start</span> <span class="n">Felix</span> <span class="n">instance</span><span class="p">.</span>
            <span class="n">m_felix</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="n">create</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
            <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">shutdownApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Shut</span> <span class="n">down</span> <span class="n">the</span> <span class="n">felix</span> <span class="n">framework</span> <span class="n">when</span> <span class="n">stopping</span> <span class="n">the</span>
        <span class="o">//</span> <span class="n">host</span> <span class="n">application</span><span class="p">.</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Rather than having the host application bundle activator register the service, it is also possible for the the host application to simply get the bundle context from the bundle activator and register the service directly, but the presented approach is perhaps a little cleaner since it allows the host application to register/unregister the service when the system bundle starts/stops.</p>
<h2 id="using-services-provided-by-bundles">Using Services Provided by Bundles<a class="headerlink" href="#using-services-provided-by-bundles" title="Permanent link">&para;</a></h2>
<p>Using services provided by bundles follows the same general approach of using a host application bundle activator. The main complication for the host application using a service from a bundle is the fact that both the host application and the bundle must be using the same class definitions for the service interface classes. Since the host application cannot import classes from a bundle, this means that the service interface classes <em>must</em> be accessible on the class path, typically as part of the host application itself. The host application then must export the service interface package via the system bundle so that bundles installed into the embedded framework instance can import it. This is achieved using the <code>org.osgi.framework.system.packages.extra</code> configuration property previously presented.</p>
<p>Consider the following simple command service interface for which bundles provide implementations, such as might be used to create an extensible interactive shell:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">Command</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">getName</span><span class="p">();</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">getDescription</span><span class="p">();</span>
    <span class="n">public</span> <span class="n">boolean</span> <span class="n">execute</span><span class="p">(</span><span class="n">String</span> <span class="n">commandline</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>This package is simply part of the host application, which is potentially packaged into a JAR file and started with the "<code>java -jar</code>" command. Now consider the previously introduced host application bundle activator below, which simply provides access to the system bundle context:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">core</span><span class="p">;</span>

<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">BundleActivator</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">BundleContext</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">HostActivator</span> <span class="n">implements</span> <span class="n">BundleActivator</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">BundleContext</span> <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">start</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">stop</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_context</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">BundleContext</span> <span class="n">getContext</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">m_context</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>With this bundle activator, the host application can use command services provided by bundles installed inside its embedded Felix framework instance. The following code snippet illustrates one possible approach:</p>
<div class="codehilite"><pre><span class="n">package</span> <span class="n">host</span><span class="p">.</span><span class="n">core</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">List</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Map</span><span class="p">;</span>
<span class="n">import</span> <span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">Command</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">Felix</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">FelixConstants</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BundleCache</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">framework</span><span class="p">.</span><span class="n">Constants</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">osgi</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">tracker</span><span class="p">.</span><span class="n">ServiceTracker</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">HostApplication</span>
<span class="p">{</span>
    <span class="n">private</span> <span class="n">HostActivator</span> <span class="n">m_activator</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Felix</span> <span class="n">m_felix</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">ServiceTracker</span> <span class="n">m_tracker</span> <span class="p">=</span> <span class="n">null</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">HostApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">property</span> <span class="n">map</span><span class="p">.</span>
        <span class="n">Map</span> <span class="n">configMap</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">();</span>
        <span class="o">//</span> <span class="n">Export</span> <span class="n">the</span> <span class="n">host</span> <span class="n">provided</span> <span class="n">service</span> <span class="n">interface</span> <span class="n">package</span><span class="p">.</span>
        <span class="n">configMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">FRAMEWORK_SYSTEMPACKAGES_EXTRA</span><span class="p">,</span>
            &quot;<span class="n">host</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">command</span><span class="p">;</span> <span class="n">version</span><span class="p">=</span>1<span class="p">.</span>0<span class="p">.</span>0&quot;<span class="p">);</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">host</span> <span class="n">activator</span><span class="p">;</span>
        <span class="n">m_activator</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HostActivator</span><span class="p">();</span>
        <span class="n">List</span> <span class="n">list</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="p">();</span>
        <span class="n">list</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">m_activator</span><span class="p">);</span>
        <span class="n">configMap</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">FelixConstants</span><span class="p">.</span><span class="n">SYSTEMBUNDLE_ACTIVATORS_PROP</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">create</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">framework</span> <span class="n">with</span>
            <span class="o">//</span> <span class="n">our</span> <span class="n">configuration</span> <span class="k">properties</span><span class="p">.</span>
            <span class="n">m_felix</span> <span class="p">=</span> <span class="n">new</span> <span class="n">Felix</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
            <span class="o">//</span> <span class="n">Now</span> <span class="n">start</span> <span class="n">Felix</span> <span class="n">instance</span><span class="p">.</span>
            <span class="n">m_felix</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Could</span> <span class="n">not</span> <span class="n">create</span> <span class="n">framework</span><span class="p">:</span> &quot; <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
            <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">m_tracker</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ServiceTracker</span><span class="p">(</span>
            <span class="n">m_activator</span><span class="p">.</span><span class="n">getContext</span><span class="p">(),</span> <span class="n">Command</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">null</span><span class="p">);</span>
        <span class="n">m_tracker</span><span class="p">.</span><span class="n">open</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">boolean</span> <span class="n">execute</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">commandline</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">See</span> <span class="k">if</span> <span class="n">any</span> <span class="n">of</span> <span class="n">the</span> <span class="n">currently</span> <span class="n">tracked</span> <span class="n">command</span> <span class="n">services</span>
        <span class="o">//</span> <span class="n">match</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">command</span> <span class="n">name</span><span class="p">,</span> <span class="k">if</span> <span class="n">so</span> <span class="n">then</span> <span class="n">execute</span> <span class="n">it</span><span class="p">.</span>
        <span class="n">Object</span><span class="p">[]</span> <span class="n">services</span> <span class="p">=</span> <span class="n">m_tracker</span><span class="p">.</span><span class="n">getServices</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="nb">i</span> <span class="p">=</span> 0<span class="p">;</span> <span class="p">(</span><span class="n">services</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">i</span> <span class="o">&lt;</span> <span class="n">services</span><span class="p">.</span><span class="nb">length</span><span class="p">);</span> <span class="nb">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">Command</span><span class="p">)</span> <span class="n">services</span><span class="p">[</span><span class="nb">i</span><span class="p">]).</span><span class="n">getName</span><span class="p">().</span><span class="n">equals</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">Command</span><span class="p">)</span> <span class="n">services</span><span class="p">[</span><span class="nb">i</span><span class="p">]).</span><span class="n">execute</span><span class="p">(</span><span class="n">commandline</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="o">//</span> <span class="n">Since</span> <span class="n">the</span> <span class="n">services</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">the</span> <span class="n">tracker</span> <span class="n">could</span> <span class="n">become</span>
                <span class="o">//</span> <span class="n">invalid</span> <span class="n">at</span> <span class="n">any</span> <span class="n">moment</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="k">catch</span> <span class="n">all</span> <span class="n">exceptions</span><span class="p">,</span> <span class="nb">log</span>
                <span class="o">//</span> <span class="n">a</span> <span class="n">message</span><span class="p">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">ignore</span> <span class="n">faulty</span> <span class="n">services</span><span class="p">.</span>
                <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">shutdownApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Shut</span> <span class="n">down</span> <span class="n">the</span> <span class="n">felix</span> <span class="n">framework</span> <span class="n">when</span> <span class="n">stopping</span> <span class="n">the</span>
        <span class="o">//</span> <span class="n">host</span> <span class="n">application</span><span class="p">.</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
        <span class="n">m_felix</span><span class="p">.</span><span class="n">waitForStop</span><span class="p">(</span>0<span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The above example is overly simplistic with respect to concurrency issues and error conditions, but it demonstrates the overall approach for using bundle-provided services from the host application.</p>
<h3 id="using-bundle-services-via-reflection">Using Bundle Services via Reflection<a class="headerlink" href="#using-bundle-services-via-reflection" title="Permanent link">&para;</a></h3>
<p>It possible for the host application to use services provided by bundles without having access to the service interface classes and thus not needing to put the service interface classes on the class path. To do this, the host application uses the same general approach to acquire the system bundle context object, which it can use to look up service objects. Using either an LDAP filter or the service interface class name, the host application can retrieve the service object and then use standard Java reflection to invoke methods on the service object.</p>
<h3 id="other-approaches">Other Approaches<a class="headerlink" href="#other-approaches" title="Permanent link">&para;</a></h3>
<p>The <a href="http://code.google.com/p/transloader/">Transloader</a> project is another attempt at dealing with issues of classes loaded from different class loaders and may be of interest.</p>
<h1 id="caveat">Caveat<a class="headerlink" href="#caveat" title="Permanent link">&para;</a></h1>
<p>The code in this document has not been thoroughly tested nor even compiled and may be out of date with respect to the current Felix source code. If you find errors please report them so the that they can be corrected.</p>
<h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h2>
<p>Subscribe to the Felix users mailing list by sending a message to <a href="">users-subscribe@felix.apache.org</a>; after subscribing, email questions or feedback to [users@felix.apache.org|mailto:users@felix.apache.org].</p>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1712598 by cziegeler on Wed, 4 Nov 2015 17:48:20 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
