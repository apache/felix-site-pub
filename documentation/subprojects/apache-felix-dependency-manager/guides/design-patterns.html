<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Dependency Manager - Design Patterns</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="http://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="http://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><a href="/news.html">News</a>  <br />
<a href="/license.html">License</a>  <br />
<a href="/downloads.cgi">Downloads</a>  <br />
<a href="/documentation.html">Documentation</a>  <br />
<a href="/mailinglists.html">Mailing Lists</a>  <br />
<a href="/documentation/community/contributing.html">Contributing</a>  <br />
<a href="/sitemap.html">Site Map</a>  <br />
<a href="http://www.apache.org/">ASF</a>  <br />
<a href="http://www.apache.org/security/">Security</a>  <br />
<a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a>  <br />
<a href="http://www.apache.org/foundation/thanks.html">Sponsors</a>    </p>
<iframe
    src="http://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects.html">Apache Felix Subproject Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-dependency-manager.html">Apache Felix Dependency Manager</a>
      </div>

      <h1>Dependency Manager - Design Patterns</h1>
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p>This section lists a couple of design patterns as they can be applied in an OSGi context.</p>
<h2 id="singleton-service">Singleton Service<a class="headerlink" href="#singleton-service" title="Permanent link">&para;</a></h2>
<p>Provides a service as long as its dependencies are resolved.</p>
<h3 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h3>
<p>In a dynamic framework, services can come and go. Components that publish a service are often themselves dependent on other services to perform their task. In such cases, they have a dependency on those services and it makes sense to only publish their own services when these dependencies are available. Being able to declare such dependencies in code ensures consistent life cycle behavior.</p>
<h3 id="structure">Structure<a class="headerlink" href="#structure" title="Permanent link">&para;</a></h3>
<p><img src="./diagrams/singleton.png" alt="Singleton" style="width: 190px"/></p>
<h3 id="code-example">Code Example<a class="headerlink" href="#code-example" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">Activator</span> <span class="n">extends</span> <span class="n">DependencyActivatorBase</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">createComponent</span><span class="p">()</span>
            <span class="p">.</span><span class="n">setInterface</span><span class="p">(</span><span class="n">UserStore</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="n">new</span> <span class="n">Properties</span><span class="p">()</span> <span class="p">)</span>
            <span class="p">.</span><span class="n">setImplementation</span><span class="p">(</span><span class="n">UserStoreImpl</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">createServiceDependency</span><span class="p">()</span>
                <span class="p">.</span><span class="n">setService</span><span class="p">(</span><span class="n">Store</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
                <span class="p">.</span><span class="n">setRequired</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">createServiceDependency</span><span class="p">()</span>
                <span class="p">.</span><span class="n">setService</span><span class="p">(</span><span class="n">LogService</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
                <span class="p">.</span><span class="n">setRequired</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>


<h2 id="aspect-service">Aspect Service<a class="headerlink" href="#aspect-service" title="Permanent link">&para;</a></h2>
<p>Provides an aspect on top of a specific type of service.</p>
<h3 id="motivation_1">Motivation<a class="headerlink" href="#motivation_1" title="Permanent link">&para;</a></h3>
<p>In aspect oriented programming, supporting functions are isolated from the main application's business logic. This increases modularity at the source level by allowing the separation of cross-cutting concerns. In OSGi we want to extend this modularity to the runtime, therefore we implement aspects to work on certain services, where the aspect itself publishes that same service but (usually) with a higher priority. This allows you to dynamically add and remove aspects.</p>
<h3 id="structure_1">Structure<a class="headerlink" href="#structure_1" title="Permanent link">&para;</a></h3>
<p><img src="./diagrams/aspect.png" alt="Aspect" style="width: 190px"/></p>
<h3 id="code-example_1">Code Example<a class="headerlink" href="#code-example_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">Activator</span> <span class="n">extends</span> <span class="n">DependencyActivatorBase</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">createAspectService</span><span class="p">(</span><span class="n">Manageable</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> &quot;<span class="p">(</span><span class="n">monitor</span><span class="p">=</span><span class="n">true</span><span class="p">)</span>&quot;<span class="p">,</span> 50<span class="p">)</span>
            <span class="p">.</span><span class="n">setImplementation</span><span class="p">(</span><span class="n">ManageableMonitor</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">interface</span> <span class="n">Manageable</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">setProperty</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">ManageableMonitor</span> <span class="n">implements</span> <span class="n">Manageable</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">volatile</span> <span class="n">Manageable</span> <span class="n">m_manageable</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">setProperty</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span>&quot;<span class="n">Someone</span> <span class="n">set</span> &quot; <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> &quot; <span class="n">to</span> &quot; <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
        <span class="n">m_manageable</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="adapter-service">Adapter Service<a class="headerlink" href="#adapter-service" title="Permanent link">&para;</a></h2>
<p>Provides an adapter for a specific type of service.</p>
<h3 id="motivation_2">Motivation<a class="headerlink" href="#motivation_2" title="Permanent link">&para;</a></h3>
<p>Like with aspects, sometimes you want to create adapters for certain services, which add certain behavior that results in the publication of (in this case) a different service. Adapters can dynamically be added and removed and allow you to keep your basic services implementations clean and simple, adding extra features on top of them in a modular way. </p>
<h3 id="structure_2">Structure<a class="headerlink" href="#structure_2" title="Permanent link">&para;</a></h3>
<p><img src="./diagrams/adapter.png" alt="Adapter" style="width: 190px"/></p>
<h3 id="code-example_2">Code Example<a class="headerlink" href="#code-example_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">Activator</span> <span class="n">extends</span> <span class="n">DependencyActivatorBase</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">createAdapterService</span><span class="p">(</span><span class="n">Manageable</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> &quot;<span class="p">(</span><span class="n">publish</span><span class="p">=</span><span class="n">servlet</span><span class="p">)</span>&quot;<span class="p">)</span>
            <span class="p">.</span><span class="n">setInterface</span><span class="p">(</span><span class="n">HttpServlet</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">null</span><span class="p">)</span>
            <span class="p">.</span><span class="n">setImplementation</span><span class="p">(</span><span class="n">ManageableServlet</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">manager</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">interface</span> <span class="n">Manageable</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">setProperty</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">ManageableServlet</span> <span class="n">implements</span> <span class="n">HttpServlet</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">volatile</span> <span class="n">Manageable</span> <span class="n">m_manageable</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">doPost</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">key</span> <span class="p">=</span> <span class="n">req</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span>&quot;<span class="n">key</span>&quot;<span class="p">);</span>
        <span class="n">String</span> <span class="n">value</span> <span class="p">=</span> <span class="n">req</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span>&quot;<span class="n">value</span>&quot;<span class="p">);</span>
        <span class="n">m_manageable</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="resource-adapter-service">Resource Adapter Service<a class="headerlink" href="#resource-adapter-service" title="Permanent link">&para;</a></h2>
<p>Provides an adapter for a specific type of resource.</p>
<h3 id="motivation_3">Motivation<a class="headerlink" href="#motivation_3" title="Permanent link">&para;</a></h3>
<p>Resource adapters are similar to normal adapters, but instead of requiring a service, they require a resource and provide a service on top of it. Resources are an abstraction that is introduced by the dependency manager, represented as a URL. They can be implemented to serve resources embedded in bundles, somewhere on a file system or in a content repository or database.</p>
<h3 id="structure_3">Structure<a class="headerlink" href="#structure_3" title="Permanent link">&para;</a></h3>
<p><img src="./diagrams/resourceadapter.png" alt="Singleton" style="width: 180px"/></p>
<h2 id="temporal-dependency">Temporal Dependency<a class="headerlink" href="#temporal-dependency" title="Permanent link">&para;</a></h2>
<p>Provides a proxy that hides the service dynamics of a dependency, even if it disappears for a short time.</p>
<h3 id="motivation_4">Motivation<a class="headerlink" href="#motivation_4" title="Permanent link">&para;</a></h3>
<p>As a service consumer, you sometimes do not want to deal with the dynamics of services and the fact that they tend to go away for short periods of time whilst their hosting bundle gets updated. A temporal dependency provides you with a proxy that hides these dynamics and blocks your calls if you try to invoke a method on a service that is currently "updating". The maximum time to wait is configurable and you will get an exception if no new service becomes available before that time.</p>
<h3 id="structure_4">Structure<a class="headerlink" href="#structure_4" title="Permanent link">&para;</a></h3>
<h2 id="null-object">Null Object<a class="headerlink" href="#null-object" title="Permanent link">&para;</a></h2>
<p>Provides an implementation of an object that does nothing and can be used in the absence of the real object.</p>
<h3 id="motivation_5">Motivation<a class="headerlink" href="#motivation_5" title="Permanent link">&para;</a></h3>
<p>When a component depends on a service, but the dependency is optional, it means that it will use this service when available, but it can still operate if it's not. Constantly checking in your code if a service is actually available tends to lead to code with a lot of "<code>if (service != null) service.invoke();</code>" constructions which do not help with code readability. Instead, the dependency manager offers you a mechanism where it will inject null objects for services that are currently not available so you can simply invoke methods on them that "do nothing".</p>
<h3 id="structure_5">Structure<a class="headerlink" href="#structure_5" title="Permanent link">&para;</a></h3>
<h2 id="whiteboard">Whiteboard<a class="headerlink" href="#whiteboard" title="Permanent link">&para;</a></h2>
<p>Handles listeners by leveraging the OSGi service registry to publish and look them up.</p>
<h3 id="motivation_6">Motivation<a class="headerlink" href="#motivation_6" title="Permanent link">&para;</a></h3>
<p>The traditional model for dealing with listeners in Java needlessly complicates things in an OSGi context. Instead of having listeners registering themselves with the component that will invoke them on any change, a listener simply registers itself in the service registry and the component will do a lookup of all relevant services. This is explained in more detail on the OSGi.org wiki in the <a href="http://www.osgi.org/wiki/uploads/Links/whiteboard.pdf">"Listeners considered harmful: the 'whiteboard' pattern"</a> article.</p>
<h3 id="structure_6">Structure<a class="headerlink" href="#structure_6" title="Permanent link">&para;</a></h3>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1665812 by marrs on Wed, 11 Mar 2015 09:02:04 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
