<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Dependency Manager Lambda</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="http://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="http://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><a href="/news.html">News</a>  <br />
<a href="/license.html">License</a>  <br />
<a href="/downloads.cgi">Downloads</a>  <br />
<a href="/documentation.html">Documentation</a>  <br />
<a href="/mailinglists.html">Mailing Lists</a>  <br />
<a href="/documentation/community/contributing.html">Contributing</a>  <br />
<a href="/sitemap.html">Site Map</a>  <br />
<a href="http://www.apache.org/">ASF</a>  <br />
<a href="http://www.apache.org/security/">Security</a>  <br />
<a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a>  <br />
<a href="http://www.apache.org/foundation/thanks.html">Sponsors</a>    </p>
<iframe
    src="http://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects.html">Apache Felix Subproject Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-dependency-manager.html">Apache Felix Dependency Manager</a>
      </div>

      <h1>Dependency Manager Lambda</h1>
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<hr />
<p><strong>Welcome to Felix Dependency Manager Lambda.</strong></p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Since the R8 version, a new dm-lambda library has been introduced in the DM distribution. This new library allows to programmatically declare OSGi components
using a new style based on java8 lambda expressions and other goodies like method references.</p>
<p>The new library is based on the <code>builder</code> design pattern applied to java8 lambdas. Basically, you call a chain of methods from a 
fluent <code>builder</code>, and at the end of the chain, you call "<code>build()</code>" which returns the actual DM objects that you already know from 
the original DM API. 
We'll see later that using lambdas avoids to call the last "<code>build</code>" method and allows to automatically add the constructed DM Component into the 
DependencyManager object.</p>
<p>Please notice that using the dm-lambda library requires the usage of a recent Java8 jvm (the library has been tested with java version "1.8.0_71").</p>
<h2 id="comparing-two-activators-using-old-and-new-api">Comparing two activators using old and new API:<a class="headerlink" href="#comparing-two-activators-using-old-and-new-api" title="Permanent link">&para;</a></h2>
<p>Before presenting the new API, let's get a jump start and dive into a comparison between the old and new API: assume we have a <code>ServiceConsumer</code> which depends on the following services:</p>
<ul>
<li>a required dependency on <code>ServiceProvider</code> service  with a "<code>(p1=v1)</code>" filter. The dependency is injected in the "<code>ServiceConsumer.setProvider()</code>" method.</li>
<li>a Configuration with pid="<code>org.apache.felix.dm.lambda.samples.hello.ServiceConsumer</code>".</li>
</ul>
<p>Now assume we have <code>ServiceProvider</code> provided with p1="v1" and p2=123 service properties; and the provider also depends on:</p>
<ul>
<li>a required <code>LogService</code> service (injected in class fields).</li>
<li>a required <code>EventAdmin</code> service  (injected in class fields).</li>
</ul>
<p>Then we have the following typical Activator (we define both components in the same Activator for simplicity):</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.DependencyActivatorBase</span><span class="o">;</span>
<span class="o">...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyActivatorBase</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Declare our Consumer component</span>

        <span class="n">Component</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">createComponent</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setImplementation</span><span class="o">(</span><span class="n">ServiceConsumer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createServiceDependency</span><span class="o">().</span><span class="na">setService</span><span class="o">(</span><span class="n">ServiceProvider</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;(p1=v1)&quot;</span><span class="o">).</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">setCallbacks</span><span class="o">(</span><span class="s">&quot;setProvider&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createConfigurationDependency</span><span class="o">().</span><span class="na">setPid</span><span class="o">(</span><span class="n">ServiceConsumer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="n">dm</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>

       <span class="c1">// Declare our ServiceProvider service component</span>

       <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
       <span class="n">Properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;p1&quot;</span><span class="o">,</span> <span class="s">&quot;v1&quot;</span><span class="o">);</span>
       <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;p2&quot;</span><span class="o">,</span> <span class="mi">123</span><span class="o">);</span>
       <span class="n">Component</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">createComponent</span><span class="o">()</span>
           <span class="o">.</span><span class="na">setImplementation</span><span class="o">(</span><span class="n">ServiceProviderImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
           <span class="o">.</span><span class="na">setInterface</span><span class="o">(</span><span class="n">ServiceProvider</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">properties</span><span class="o">)</span>
           <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createServiceDependency</span><span class="o">().</span><span class="na">setService</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
           <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createServiceDependency</span><span class="o">().</span><span class="na">setService</span><span class="o">(</span><span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
       <span class="n">dm</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Now, let's rework the above example, using the new dm-lambda API:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>
<span class="o">...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Declare our Consumer component</span>

        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceConsumer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">ServiceProvider</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">required</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="s">&quot;(p1=v1)&quot;</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="nl">ServiceConsumer:</span><span class="o">:</span><span class="n">setProvider</span><span class="o">))</span>
            <span class="o">.</span><span class="na">withCnf</span><span class="o">(</span><span class="n">ServiceConsumer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>

        <span class="c1">// Declare our ServiceProvider service component:</span>

        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceProviderImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">provides</span><span class="o">(</span><span class="n">ServiceProvider</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">p1</span> <span class="o">-&gt;</span> <span class="s">&quot;v1&quot;</span><span class="o">,</span> <span class="n">p2</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>


<h1 id="principle">Principle<a class="headerlink" href="#principle" title="Permanent link">&para;</a></h1>
<p>The new API is provided by the <code>org.apache.felix.dependencymanager.lambda.jar</code> bundle. The following builders are currently supported:</p>
<ul>
<li>ComponentBuilder: it is used to build org.apache.felix.dm.Component from original DM API.</li>
<li>ServiceDependencyBuilder: builds org.apache.felix.dm.ServiceDependency from original DM API.</li>
<li>ConfigurationDependencyBuiler: builds org.apache.felix.dm.ConfigurationDependency from original DM API.</li>
<li>BundleAdapterBuilder: builds a bundle adapter component from the original DM API.</li>
<li>ServiceAdapterBuilder.java: builds a DM service adapter from the original DM API.</li>
<li>FactoryPidAdapterBuilder: builds a DM factory pid adapter from the original DM API.</li>
<li>FutureDependencyBuilder: it's a new feature allowing to "wait for" an asynchronous event represented by a standard jdk8 <code>CompletableFuture</code> object.</li>
</ul>
<p>(There is currently no builders for DM ResourceDependency and ResourceAdapter objects, but they will be supported soon).</p>
<p>There are two ways to use these builders:</p>
<p>You can first instantiate builders using some of the convenient factory methods available from the DependencyManagerActivator class, which is the new base class
for dm-lambda activators:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.ComponentBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.Component</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ComponentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">component</span><span class="o">();</span>
        <span class="n">Component</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="n">dm</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">comp</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The <code>component()</code> method returns a <code>ComponentBuilder</code> and the call to <code>build</code> at the end of the method calls chain returns the actual DM Component object.</p>
<p>Here is a shorter version:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.Component</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Component</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">component</span><span class="o">().</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">dm</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">comp</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Now, most of the time, in an Activator you usually create a Component and immediately add it to the <code>dm</code> object.
So, in order to reduce the code size, you can then use a component() method that accepts a lambda which takes as 
argument a <code>Consumer&lt;ComponentBuilder&gt;</code> parameter.
So, the lambda has just to invoke the chain of necessary methods from the builder, without having to call the last "<code>build</code>" method. 
The constructed Component is then automatically added to the <code>dm</code> object.</p>
<p>The following is the same as above, using a <code>consumer&lt;ComponentBuilder&gt;</code> lambda expression:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.ComponentBuilder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">((</span><span class="n">ComponentBuilder</span> <span class="n">comp</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Here is a more concise version where the type of the lambda parameter is not declared:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="dependency-default-mode-required-or-optional">Dependency default mode (required or optional ?)<a class="headerlink" href="#dependency-default-mode-required-or-optional" title="Permanent link">&para;</a></h2>
<p>When you declare a dependency without explicitly invoking <code>optional()</code>, <code>required()</code>, or <code>required(boolean)</code>, then by default,
the dependency is assumed to be optional. This is in line with the behavior of the Dependency Manager API.</p>
<p>Now, you can change this default behavior by configuring the "<code>org.apache.felix.dependencymanager.lambda.defaultRequiredDependency</code>"
system property. This property can be set with a list of java package prefixes (comma separated).
When a component implementation class starts with one of the package prefixes specified in the above property, then dependencies will be 
assumed to be required by default.</p>
<h2 id="adding-service-dependencies-injected-in-class-fields">Adding service dependencies injected in class fields.<a class="headerlink" href="#adding-service-dependencies-injected-in-class-fields" title="Permanent link">&para;</a></h2>
<p>You can add a dependency using the "<code>withSvc</code>" methods available from the ComponentBuilder interface.
Such methods accept a <code>Consumer&lt;ServiceDependencyBuilder&gt;</code> lambda expression, which may then configure the dependency using a chain of method calls (filter/callbacks,autoconfig, etc ...):
When you don't specify callbacks, services are injected in class fields with compatible service dependency type, but you can specify a field name.
Unavailable optional dependencies are injected as "<code>Null Objects</code>".</p>
<p>The following example adds a service dependency on a LogService with a service filter.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.ServiceDependencyBuilder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">ServiceDependencyBuilder</span> <span class="n">svc</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="s">&quot;(vendor=apache)&quot;</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Here is a more concise version where the type of the <code>svc</code> lambda parameter is not declared:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="s">&quot;(vendor=apache)&quot;</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>When injecting services in class fields (auto config mode), there are shotcuts that avoid using a lambda when defining a service dependency.
These shortcuts are available from the ComponentBuilder interface.</p>
<p>Examples:</p>
<h4 id="declaring-multiple-auto-config-dependencies-in-one-shot-using-varargs-of-interfaces">Declaring multiple auto config dependencies in one shot (using varargs of interfaces):<a class="headerlink" href="#declaring-multiple-auto-config-dependencies-in-one-shot-using-varargs-of-interfaces" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">ConfigurationAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MetatypeService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</pre></div>


<h4 id="declaring-multiple-auto-config-dependencies-in-one-shot-with-a-required-flag">Declaring multiple auto config dependencies in one shot with a <code>required</code> flag:<a class="headerlink" href="#declaring-multiple-auto-config-dependencies-in-one-shot-with-a-required-flag" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">ConfigurationAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MetatypeService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</pre></div>


<h4 id="declaring-an-autoconfig-dependency-with-a-required-flag">Declaring an autoconfig dependency with a <code>required</code> flag:<a class="headerlink" href="#declaring-an-autoconfig-dependency-with-a-required-flag" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">ConfigurationAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
</pre></div>


<h4 id="declaring-an-autoconfig-dependency-with-a-filter-and-required-flag">Declaring an autoconfig dependency with a <code>filter</code> and <code>required</code> flag:<a class="headerlink" href="#declaring-an-autoconfig-dependency-with-a-filter-and-required-flag" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">ConfigurationAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;(vendor=apache)&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
</pre></div>


<h4 id="declaring-a-autoconfig-dependency-with-a-filter-an-explicit-class-field-and-required-flag">Declaring a autoconfig dependency with a <code>filter</code>, an explicit class field, and <code>required</code> flag:<a class="headerlink" href="#declaring-a-autoconfig-dependency-with-a-filter-an-explicit-class-field-and-required-flag" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">ConfigurationAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;(vendor=apache)&quot;</span><span class="o">,</span> <span class="s">&quot;configadmin&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
</pre></div>


<p>Dependency services can be injected in the following kind of fields:</p>
<ul>
<li>a field having the same type as the dependency. If the field may be accessed by anythread, then the field should be declared 
volatile, in order to ensure visibility when the field is auto injected concurrently.</li>
<li>a field which is assignable to an <code>Iterable&lt;T&gt;</code> where T must match the dependency type. In this case, an Iterable will be 
injected by DependencyManager before the start callback is called. The Iterable field may then be traversed to inspect the 
currently available dependency services. The Iterable can possibly be set to a final value so you can choose the Iterable implementation of your choice (for example, a CopyOnWrite ArrayList, or a ConcurrentLinkedQueue).</li>
<li>a <code>Map&lt;K,V&gt;</code> where K must match the dependency type and V must exactly equals Dictionary class. In this case, a 
ConcurrentHashMap will be injected by DependencyManager before the start callback is called. 
The Map may then be consulted to lookup current available dependency services, including the dependency service properties 
(the map key holds the dependency services, and the map value holds the dependency service properties). 
The Map field may be set to a final value so you can choose a Map of your choice (Typically a ConcurrentHashMap). 
A ConcurrentHashMap is "weakly consistent", meaning that when traversing the elements, you may or may not see any concurrent 
updates made on the map. So, take care to traverse the map using an iterator on the map entry set, 
which allows to atomically lookup pairs of Dependency service/Service properties. </li>
</ul>
<h2 id="service-dependency-callbacks">Service Dependency callbacks<a class="headerlink" href="#service-dependency-callbacks" title="Permanent link">&para;</a></h2>
<p>You can specify callbacks on the component implementation class using the "<code>add/change/remove/swap</code>" <code>ServiceDependencyBuilder</code> methods:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;setLog&quot;</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Now you can also use a more type-safe callback using a Java 8 method reference:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">Hello:</span><span class="o">:</span><span class="n">setLog</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>or:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">Hello:</span><span class="o">:</span><span class="n">setLog</span><span class="o">).</span><span class="na">remove</span><span class="o">(</span><span class="nl">Hello:</span><span class="o">:</span><span class="n">unsetLog</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The following callback methods signatures are supported when using method references:</p>
<p>For add/change/remove method references:</p>
<div class="codehilite"><pre><span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">,</span> <span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">serviceRef</span><span class="o">),</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">serviceProperties</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">,</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">serviceProperties</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">,</span> <span class="n">Component</span> <span class="n">serviceComponent</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">service</span><span class="o">,</span> <span class="n">Component</span> <span class="n">serviceComponent</span><span class="o">,</span> <span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">serviceRef</span><span class="o">)</span>
</pre></div>


<p>and for swap method references:</p>
<div class="codehilite"><pre><span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">oldService</span><span class="o">,</span> <span class="n">S</span> <span class="n">newService</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">S</span> <span class="n">oldService</span><span class="o">,</span> <span class="n">S</span> <span class="n">newService</span><span class="o">,</span> <span class="n">Component</span> <span class="n">component</span><span class="o">))</span>
<span class="n">method</span><span class="o">(</span><span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">oldRef</span><span class="o">,</span> <span class="n">S</span> <span class="n">old</span><span class="o">,</span> <span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">newRef</span><span class="o">,</span> <span class="n">S</span> <span class="n">newService</span><span class="o">)</span>
<span class="n">method</span><span class="o">(</span><span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">oldRef</span><span class="o">,</span> <span class="n">S</span> <span class="n">old</span><span class="o">,</span> <span class="n">ServiceReference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">newRef</span><span class="o">,</span> <span class="n">S</span> <span class="n">newService</span><span class="o">,</span> <span class="n">Component</span> <span class="n">component</span><span class="o">)</span>
</pre></div>


<h2 id="defining-service-dependency-object-instance-callback">Defining Service Dependency Object instance callback<a class="headerlink" href="#defining-service-dependency-object-instance-callback" title="Permanent link">&para;</a></h2>
<p>Sometimes, you want to inject the dependency to a separate object that is not part of the component implementation classes.
For example, the following example injects a dependency in a DependencyHandler instance:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">DependencyHandler</span> <span class="n">depHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DependencyHandler</span><span class="o">();</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">depHandler</span><span class="o">,</span> <span class="s">&quot;setLog&quot;</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>or using method reference:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">DependencyHandler</span> <span class="n">depHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DependencyHandler</span><span class="o">();</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">depHandler:</span><span class="o">:</span><span class="n">setLog</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>You can chain multiple callbacks:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">DependencyHandler</span> <span class="n">depHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DependencyHandler</span><span class="o">();</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">Hello:</span><span class="o">:</span><span class="n">setLog</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="nl">depHandler:</span><span class="o">:</span><span class="n">setLog</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="providing-a-service">Providing a service<a class="headerlink" href="#providing-a-service" title="Permanent link">&para;</a></h2>
<p>When a component provides a service with some properties, so far it was necessary to create a Dictionary and pass it to the <code>Component.setInterface()</code> method.</p>
<p>Now you can pass properties directly to the <code>provides</code> method as varargs of properties (a suite of key-value properties):</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;p1&quot;</span><span class="o">,</span> <span class="s">&quot;v1&quot;</span><span class="o">,</span> <span class="s">&quot;p2&quot;</span><span class="o">,</span> <span class="mi">123</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>or if you build your application using the <code>-parameters</code> javac option, you can also use the "<code>FluentProperty</code>" lambda that allows to declare
service properties as a suite of "<code>key -&gt; value</code>" lambdas, like this:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">p1</span> <span class="o">-&gt;</span> <span class="s">&quot;v1&quot;</span><span class="o">,</span> <span class="n">p2</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="depending-on-a-configuration">Depending on a configuration.<a class="headerlink" href="#depending-on-a-configuration" title="Permanent link">&para;</a></h2>
<p>Configuration dependency can be defined using the "<code>withCnf</code>" ComponentBuilder method.
Two families of callbacks are supported:</p>
<ul>
<li>reflection based callbacks: you specify a callback method name</li>
<li>method reference callbacks: you specify a java8 method reference</li>
</ul>
<p>Callbacks may accept a Dictionary, a Component, or a user defined configuration type interface. If you only specify a pid, by default the callback method name is assumed to be "updated".</p>
<h3 id="configuration-types">configuration types<a class="headerlink" href="#configuration-types" title="Permanent link">&para;</a></h3>
<p>Configuration types are a new feature that allows you to specify an interface that is implemented by DM and such interface is then injected to your callback instead of the actual Dictionary. Using such configuration interface provides a way for creating type-safe configurations from a actual Dictionary that is normally injected by Dependency Manager. The callback accepts in argument an interface that you have to provide, and DM will inject a proxy that converts method calls from your configuration-type to lookups in the actual map or dictionary. The results of these lookups are then converted to the expected return type of the invoked configuration method.
As proxies are injected, no implementations of the desired configuration-type are necessary!</p>
<p>The lookups performed are based on the name of the method called on the configuration type. The method names are "mangled" to the following form: [lower case letter] [any valid character]*. Method names starting with get or is (JavaBean convention) are stripped from these prefixes. For example: given a dictionary with the key "foo" can be accessed from a configuration-type using the following method names: foo(), getFoo() and isFoo().</p>
<p>The return values supported are: primitive types (or their object wrappers), strings, enums, arrays of primitives/strings, Collection types, Map types, Classes and interfaces. When an interface is returned, it is treated equally to a configuration type, that is, it is returned as a proxy.</p>
<p>Arrays can be represented either as comma-separated values, optionally enclosed in square brackets. For example: [ a, b, c ] and a, b,c are both considered an array of length 3 with the values "a", "b" and "c". Alternatively, you can append the array index to the key in the dictionary to obtain the same: a dictionary with "arr.0" =&gt; "a", "arr.1" =&gt; "b", "arr.2" =&gt; "c" would result in the same array as the earlier examples.</p>
<p>Maps can be represented as single string values similarly as arrays, each value consisting of both the key and value separated by a dot. Optionally, the value can be enclosed in curly brackets. Similar to array, you can use the same dot notation using the keys. For example, a dictionary with</p>
<p>"map" =&gt; "{key1.value1, key2.value2}"</p>
<p>and a dictionary with</p>
<p>"map.key1" =&gt; "value1", "map2.key2" =&gt; "value2"</p>
<p>result in the same map being returned. Instead of a map, you could also define an interface with the methods getKey1() and getKey2 and use that interface as return type instead of a Map.</p>
<p>In case a lookup does not yield a value from the underlying map or dictionary, the following rules are applied:</p>
<ul>
<li>primitive types yield their default value, as defined by the Java Specification;</li>
<li>string, Classes and enum values yield null;</li>
<li>for arrays, collections and maps, an empty array/collection/map is returned;</li>
<li>for other interface types that are treated as configuration type a null-object is returned. </li>
</ul>
<h3 id="multiple-ways-to-define-a-configuration-dependency">multiple ways to define a configuration dependency<a class="headerlink" href="#multiple-ways-to-define-a-configuration-dependency" title="Permanent link">&para;</a></h3>
<p>You can first pass a configuration pid to the <code>withCnf</code> method. In this example, the Hello component has an "<code>updated(Dictionary properties)</code>" method called when configuration is available or updated.</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">))</span>
</pre></div>


<p>You can pass a "<code>configuration type</code>" to the <code>withCnf</code> method. The pid is assumed to be the fqdn of the type passed to the <code>withCnf</code> method, and the callback is assumed to be "<code>updated</code>"
and to accept as argument an implementation of the specified configuration type:</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">MyConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</pre></div>


<p>You can define the updated callback method explicitly using a ConfigurationDependencyBuilder lambda that you can pass to the "<code>withCnf</code>"
method:</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">((</span><span class="n">ConfigurationDependencyBuilder</span> <span class="n">cnf</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">cnf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;modified&quot;</span><span class="o">)));</span>
</pre></div>


<p>Here is shorter version which does not declare the type of the lambda passed to the <code>withCnf</code> method:</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">cnf</span> <span class="o">-&gt;</span> <span class="n">cnf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;modified&quot;</span><span class="o">)));</span>
</pre></div>


<p>You can also define the callback using a method reference:</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">cnf</span> <span class="o">-&gt;</span> <span class="n">cnf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="nl">Hello:</span><span class="o">:</span><span class="n">modified</span><span class="o">)));</span>
</pre></div>


<p>And finally, you can define a configuration type, and a callback using a method reference. Here, the updated callback has to take 
in argument the configuration type parameter (the pid is assumed to be the fqdn of the configuration type):</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">cnf</span> <span class="o">-&gt;</span> <span class="n">cnf</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">MyConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">Hello:</span><span class="o">:</span><span class="n">modified</span><span class="o">)));</span>

<span class="kd">class</span> <span class="nc">Hello</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">modified</span><span class="o">(</span><span class="n">MyConfiguration</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h4 id="configuration-dependency-examples-based-on-method-references">Configuration Dependency Examples based on method references:<a class="headerlink" href="#configuration-dependency-examples-based-on-method-references" title="Permanent link">&para;</a></h4>
<p>Code example with a component that defines a Configuration Dependency using a specific callback method reference, and the method accepts in argument a configuration type 
(the pid is assumed to be the fqdn of the configuration type):</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyConfig</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">getAddress</span><span class="o">();</span>
    <span class="kt">int</span> <span class="nf">getPort</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceImpl</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">MyConfig</span> <span class="n">cnf</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cnf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">conf</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">MyConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">ServiceImpl:</span><span class="o">:</span><span class="n">updated</span><span class="o">)));</span>  
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Same example, using a shortcut for the <code>withCnf</code> dependency, which is only defining the configuration type 
(the pid is assumed to be the fqdn of the config type, and the callback name is assumed to be "updated"):</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">Activator</span> <span class="n">extends</span> <span class="n">DependencyManagerActivator</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{</span> 
        <span class="n">component</span><span class="p">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="n">ServiceImpl</span><span class="p">.</span><span class="n">class</span><span class="p">).</span><span class="n">withCnf</span><span class="p">(</span><span class="n">MyConfig</span><span class="p">.</span><span class="n">class</span><span class="p">));</span>  
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Code example with a component that defines a Configuration Dependency using a specific callback method reference which accepts a Dictionary in argument:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span>
           <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
           <span class="o">.</span><span class="na">withCnf</span><span class="o">(</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">conf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="nl">ServiceImpl:</span><span class="o">:</span><span class="n">setProperties</span><span class="o">)));</span>
    <span class="o">}</span>
 <span class="o">}</span>
</pre></div>


<h4 id="configuration-dependency-examples-based-on-method-reflection">Configuration Dependency Examples based on method reflection:<a class="headerlink" href="#configuration-dependency-examples-based-on-method-reflection" title="Permanent link">&para;</a></h4>
<p>Code example which defines a configuration dependency injected in the "ServiceImpl.updated(Dictionary)" callback
(the pid is directly passed in argument to the <code>withCnf</code> method):</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Code example with a component that defines a Configuration Dependency using a specific callback method name:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">ServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">conf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;my.pid&quot;</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;modified&quot;</span><span class="o">)));</span>  
    <span class="o">}</span>
 <span class="o">}</span>
</pre></div>


<h2 id="managing-components-outside-of-activators">Managing components outside of Activators.<a class="headerlink" href="#managing-components-outside-of-activators" title="Permanent link">&para;</a></h2>
<p>You can manage Components outside of the Activator by using some static factory methods from the <code>DependencyManagerActivator</code> class.</p>
<p>For example, consider a use case where you want to retrieve some information from some already injected services, and you then want to dynamically add more dependencies from your
<code>init</code> component callback. First let's look at the Activator:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Pojo</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withCnf</span><span class="o">(</span><span class="s">&quot;pojo.pid&quot;</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Here, we define a Configuration dependency with a "pojo.pid" configuration pid. So, now, the Pojo will then for example be able to parse an xml from the configuration, and depending on
what it has parsed, it will possibly add more dependencies, like this:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">felix</span><span class="o">.</span><span class="na">dm</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">DependencyManagerActivator</span><span class="o">.*;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.Component</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pojo</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">Dictionary</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">parseXml</span><span class="o">(</span><span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;some.xml.configuration&quot;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Component</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// lifecycle dm callback that allows you to add more dependencies</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xmlConfigurationRequiresEventAdmin</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">component</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The available variety of factory methods allows you to also create some DM objects and add them manually, like:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">felix</span><span class="o">.</span><span class="na">dm</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">DependencyManagerActivator</span><span class="o">.*;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.ServiceDependency</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.DependencyManager</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pojo</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">Dictionary</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">parseXml</span><span class="o">(</span><span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;some.xml.configuration&quot;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Component</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// lifecycle dm callback that allows you to add more dependencies</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xmlConfigurationRequiresEventAdmin</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">DependencyManager</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDependencyManager</span><span class="o">();</span>
            <span class="n">ServiceDependency</span> <span class="n">dep</span> <span class="o">=</span> <span class="n">serviceDependency</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">filter</span><span class="o">(</span><span class="s">&quot;(vendor=felix)&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="n">dm</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>And an example where you create a new DM component from the code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">felix</span><span class="o">.</span><span class="na">dm</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">DependencyManagerActivator</span><span class="o">.*;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.DependencyManager</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pojo</span> <span class="o">{</span>
    <span class="kd">volatile</span> <span class="n">DependencyManager</span> <span class="n">m_dm</span><span class="o">;</span>

    <span class="kt">void</span> <span class="nf">createComponent</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">m_dm</span><span class="o">,</span> <span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">NewComponent</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">Class</span><span class="o">,</span> <span class="n">EventAdmin</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="component-lifecycle-callbacks">Component Lifecycle Callbacks<a class="headerlink" href="#component-lifecycle-callbacks" title="Permanent link">&para;</a></h2>
<p>Like with DM API, default lifecycle callbacks are the following:</p>
<ul>
<li>"init": the method is called on the component implementation class(es) once all required dependencies declared in the Activator 
have been injected. This method can then be used to possibly add more dependencies dynamically.</li>
<li>"start": the method is called on the component implementation class(es) once all required dependencies (including the ones added 
from the "init" callback) have been injected. Then the optional dependency callbacks are invoked (after the start callback).</li>
<li>"stop": the method is called on the component implementation class(es) when some required dependencies are being lost
or when the component's bundle is stopping.</li>
<li>"destroy": the component is destroyed and may be re-created and re-initialized in case some required dependencies comes up again.</li>
</ul>
<p>You can change the callback names using the "init"/"start"/"stop"/"destroy" methods from the ComponentBuilder interface. For example:</p>
<div class="codehilite"><pre><span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Pojo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="s">&quot;initialize&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&quot;activate&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="s">&quot;deactivate&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">destroy</span><span class="o">(</span><span class="s">&quot;shutdown&quot;</span><span class="o">));</span>
</pre></div>


<p>Same example, but with some specific callback instance on which the callback should be invoked:</p>
<div class="codehilite"><pre><span class="n">CallbackHandler</span> <span class="n">handler</span> <span class="p">=</span> <span class="n">new</span> <span class="n">CallbackHandler</span><span class="p">();</span>
<span class="n">component</span><span class="p">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="n">Pojo</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
    <span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> &quot;<span class="n">initialize</span>&quot;<span class="p">)</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> &quot;<span class="n">activate</span>&quot;<span class="p">)</span>
    <span class="p">.</span><span class="n">stop</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> &quot;<span class="n">deactivate</span>&quot;<span class="p">)</span>
    <span class="p">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> &quot;<span class="n">shutdown</span>&quot;<span class="p">));</span>
</pre></div>


<p>When using callback instances, you can also use method references using the callback instance object:</p>
<div class="codehilite"><pre><span class="n">CallbackHandler</span> <span class="n">handler</span> <span class="p">=</span> <span class="n">new</span> <span class="n">CallbackHandler</span><span class="p">();</span>
<span class="n">component</span><span class="p">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="p">.</span><span class="n">impl</span><span class="p">(</span><span class="n">Pojo</span><span class="p">.</span><span class="n">class</span><span class="p">)</span>
    <span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">handler</span><span class="p">::</span><span class="n">initialize</span><span class="p">)</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">handler</span><span class="p">::</span><span class="n">activate</span><span class="p">)</span>
    <span class="p">.</span><span class="n">stop</span><span class="p">(</span><span class="n">handler</span><span class="p">::</span><span class="n">deactivate</span><span class="p">)</span>
    <span class="p">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">handler</span><span class="p">::</span><span class="n">shutdown</span><span class="p">));</span>
</pre></div>


<p>Callbacks are empty-args, or may take a DM Component in argument.</p>
<p>Method Reference for Component implementations class are not supported.</p>
<h2 id="creating-aspect-components">Creating Aspect Components<a class="headerlink" href="#creating-aspect-components" title="Permanent link">&para;</a></h2>
<p>Like with the original DM API, you can create a chain of aspects (service interceptors) ordered by a ranking attribute, using the "<code>aspect</code>" factory method.
This method accepts in argument a ServiceAspectBuilder.</p>
<p>Code example which provides a "LogService" aspect that performs spell-checking of each log message. The aspect decorates a LogService. 
The aspect also depends on a DictionaryService that is internally used to perform log spell checking. 
The LogService and DictionaryService services are injected in the aspect implementation using reflection on class 
fields:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">aspect</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">ServiceAspectBuilder</span> <span class="n">asp</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">asp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">SpellCheckLogAspect</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">rank</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">DictionaryService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Same more concise example which does not declare the type of the lambda builder argument:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">aspect</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">asp</span> <span class="o">-&gt;</span> <span class="n">asp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">SpellCheckLogAspect</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">rank</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">withSvc</span><span class="o">(</span><span class="n">DictionaryService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Same example, but using callbacks for injecting LogService and DictionaryService in the aspect implementation class:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
       <span class="n">aspect</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">asp</span> <span class="o">-&gt;</span> <span class="n">asp</span>
          <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">SpellCheckLogAspect</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">rank</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
          <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">SpellCheckLogAspect:</span><span class="o">:</span><span class="n">setLogService</span><span class="o">)</span>
          <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">DictionaryService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">SpellCheckLogAspect:</span><span class="o">:</span><span class="n">setDictionary</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="creating-service-adapter-components">Creating Service Adapter Components<a class="headerlink" href="#creating-service-adapter-components" title="Permanent link">&para;</a></h2>
<p>DM service adapters allow to create adapter services when a given type of adapted service is found in the OSGI registry.
Using the "<code>adapter</code>" factory method, you can pass to it consumer of an <code>ServiceAdapterBuilder</code> that
can be used to construct a DM adapter component.</p>
<p>Code example that adapts a "Device" service to an HttpServlet service. The adapter is created using a ServiceAdapterBuilder that is passed to the lambda.</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">adapter</span><span class="o">(</span><span class="n">Device</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="n">ServiceAdapterBuilder</span> <span class="n">adapt</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">adapt</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">DeviceServlet</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">HttpServlet</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">properties</span><span class="o">(</span><span class="n">alias</span> <span class="o">-&gt;</span> <span class="s">&quot;/device&quot;</span><span class="o">);</span>                    
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Same more concise example which does not declare the type of lambda parameter:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">adapter</span><span class="o">(</span><span class="n">Device</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">adapt</span> <span class="o">-&gt;</span> <span class="n">adapt</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">DeviceServlet</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">HttpServlet</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">properties</span><span class="o">(</span><span class="n">alias</span> <span class="o">-&gt;</span> <span class="s">&quot;/device&quot;</span><span class="o">);</span>                    
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="creating-factory-configuration-adapter-components">Creating Factory Configuration Adapter Components<a class="headerlink" href="#creating-factory-configuration-adapter-components" title="Permanent link">&para;</a></h2>
<p>A Factory Configuration Adapter allows to create many instances of the same service, each time a configuration instance is created for a given factory pid.
To declare a factory pid configuration adapter, use the <code>factoryPid</code> method available from the DependencyManagerActivator class and pass to it
a lambda for the FactoryPidAdapterBuilder argument:</p>
<p>Example that defines a factory configuration adapter service for the "foo.bar" factory pid. For each factory pid instance, an instance of the DictionaryImpl component will be created:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
       <span class="n">factoryPidAdapter</span><span class="o">((</span><span class="n">FactoryPidAdapterBuilder</span> <span class="n">adapter</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">adapter</span>
          <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">DictionaryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">factoryPid</span><span class="o">(</span><span class="s">&quot;foo.bar&quot;</span><span class="o">).</span><span class="na">propagate</span><span class="o">().</span><span class="na">update</span><span class="o">(</span><span class="nl">ServiceImpl:</span><span class="o">:</span><span class="n">updated</span><span class="o">)</span>
          <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">log</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">optional</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Same more concise example that is not declaring the type of the lambda type:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
       <span class="n">factoryPidAdapter</span><span class="o">(</span><span class="n">adapter</span> <span class="o">-&gt;</span> <span class="n">adapter</span>
          <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">DictionaryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">factoryPid</span><span class="o">(</span><span class="s">&quot;foo.bar&quot;</span><span class="o">).</span><span class="na">propagate</span><span class="o">().</span><span class="na">update</span><span class="o">(</span><span class="nl">ServiceImpl:</span><span class="o">:</span><span class="n">updated</span><span class="o">)</span>
          <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">log</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">optional</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Example that defines a factory configuration adapter using a user defined configuration type (the pid is by default assumed to match the fqdn of the configuration type):</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DictionaryConfiguration</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLanguage</span><span class="o">();</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">getWords</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
        <span class="n">factoryPidAdapter</span><span class="o">(</span><span class="n">adapter</span> <span class="o">-&gt;</span> <span class="n">adapter</span>
            <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">DictionaryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">propagate</span><span class="o">().</span><span class="na">update</span><span class="o">(</span><span class="n">DictionaryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">ServiceImpl:</span><span class="o">:</span><span class="n">updated</span><span class="o">)</span>               
            <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">log</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">optional</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="creating-a-bundle-adapter-component">Creating a Bundle Adapter component<a class="headerlink" href="#creating-a-bundle-adapter-component" title="Permanent link">&para;</a></h2>
<p>A Bundle Adapter is used to create a Component when a bundle that matches a given filter is found.
To build a DM adapter, you can use the "<code>bundleAdapter</code>" factory method: it takes in argument a consumer of a
BundleAdapterBuilder object, which is used to construct a real DM BundleAdapter component.</p>
<p>Example that creates a BundleAdapter service for each started bundle (the bundle is added using a method reference):</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> 
       <span class="n">bundleAdapter</span><span class="o">(</span><span class="n">adapt</span> <span class="o">-&gt;</span> <span class="n">adapt</span>
           <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">BundleAdapterImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">BundleAdapter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">mask</span><span class="o">(</span><span class="n">Bundle</span><span class="o">.</span><span class="na">INSTALLED</span><span class="o">|</span><span class="n">Bundle</span><span class="o">.</span><span class="na">RESOLVED</span><span class="o">|</span><span class="n">Bundle</span><span class="o">.</span><span class="na">ACTIVE</span><span class="o">)</span>               
           <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nl">BundleAdapterImpl:</span><span class="o">:</span><span class="n">bundleStarted</span><span class="o">)</span>
           <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">LogService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;(vendor=apache)&quot;</span><span class="o">));</span>              
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="completablefuture-dependency">CompletableFuture dependency.<a class="headerlink" href="#completablefuture-dependency" title="Permanent link">&para;</a></h2>
<p>The new library provides a new feature which allows your component to depend on the result of a jdk8 <code>CompletableFuture</code>.
CompletableFuture java8 class provides an asynchronous event-driven model and you can now define dependencies on any asynchronous events,
like if they were service dependencies.</p>
<p>Let's explore this new dependency using an advanced example: assume you develop a component that needs to 
track any "Tracked" services registered in the Registry, using a classic whiteboard pattern. But before, you need to
download a web page at initialization, before you component is started. The downloaded webpage is required to be able to 
handle Tracked services. Now, you don't want to block the initialization of your component because in a reactive word,
it is forbidden to block on the current thread.</p>
<p>So, you use an <code>HttpClient</code> which allows to asynchronously download a web page: this service is assumed to provide a doGET() method
which does not block the current thread, but instead returns <code>CompletableFuture&lt;String&gt;</code>
which represents the future result of the asynchronously downloaded page.</p>
<p>From your component init() method, you can then declare a FutureDependency on the result of the <code>CompletableFuture&lt;String&gt;</code>.
A Future Dependency can be defined using the "withFuture" method available from the ComponentBuilder interface,  and this method takes as argument two args: a CompletableFuture, and a 
<code>consumer&lt;FutureDependencyBuilder&gt;</code>. The second arg is a lambda that can be used to configure the callback to invoke when the CF has completed.</p>
<p>And once the result completes, start() will be called, and at this point, the Tracked services will then
be injected (using DM, optional service callbacks are always invoked after the start() callback, never before).</p>
<p>So, the Activator looks like this:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.felix.dm.lambda.DependencyManagerActivator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activator</span> <span class="kd">extends</span> <span class="n">DependencyManagerActivator</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">DependencyManager</span> <span class="n">dm</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">(</span><span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="n">Pojo</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">provides</span><span class="o">(</span><span class="n">PojoService</span><span class="o">)</span>
           <span class="o">.</span><span class="na">withCnf</span><span class="o">(</span><span class="n">cnf</span> <span class="o">-&gt;</span> <span class="n">cnf</span><span class="o">.</span><span class="na">pid</span><span class="o">(</span><span class="s">&quot;foo.pid&quot;</span><span class="o">))</span>
           <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">HttpClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">required</span><span class="o">())</span>
           <span class="o">.</span><span class="na">withSvc</span><span class="o">(</span><span class="n">Tracked</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">svc</span> <span class="o">-&gt;</span> <span class="n">svc</span><span class="o">.</span><span class="na">optional</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="nl">Pojo:</span><span class="o">:</span><span class="n">bindTracked</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Now, here is the implementation for our component which downloads the URL from its init method. The init method will declare a "FutureDependency"
for the result of the <code>CompletableFuture&lt;String&gt;</code> returned by the HttpClient. And once the result is injected
in the setPage callback, then the start() callback will be called, and finally, any registered Tracked services will be
injected in the "bindTracked" method:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">felix</span><span class="o">.</span><span class="na">dm</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">DependencyManagerActivator</span><span class="o">.*;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.dm.Component</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pojo</span> <span class="kd">implements</span> <span class="n">PojoService</span> <span class="o">{</span>
    <span class="n">HttpClient</span> <span class="n">m_httpClient</span><span class="o">;</span> <span class="c1">// injected.</span>
    <span class="n">String</span> <span class="n">m_url</span><span class="o">;</span> <span class="c1">// the URL to download using the http client.</span>

    <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">m_url</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;download.url&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// lifecycle dm callback that allows you to add more dependencies. start will be called once the webpage has been downloaded.</span>
    <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Component</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Let&#39;s schedule a download for our web page.</span>
        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">futurePage</span> <span class="o">=</span> <span class="n">m_httpClient</span><span class="o">.</span><span class="na">doGET</span><span class="o">(</span><span class="n">m_url</span><span class="o">);</span>

        <span class="c1">// Add a required dependency to the result of the CF, and inject the result in our setPage method.</span>
        <span class="n">component</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">comp</span> <span class="o">-&gt;</span> <span class="n">comp</span><span class="o">.</span><span class="na">withFuture</span><span class="o">(</span><span class="n">futurePage</span><span class="o">,</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="n">future</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">setPage</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">setPage</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">// Called when the CompletableFuture has completed</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// We have downloaded the page, our component is starting and is about to be registered</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">bindTracked</span><span class="o">(</span><span class="n">Tracked</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// a Tracked service is injected, we can handle it because we are fully initialized.</span>
        <span class="c1">// (optional service callbacks are always invoked after the start callback).</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>So, using the Future Dependency we can nicely reuse the jdk CompletableFuture as a required dependency. Without using the FutureDependency
on the CompletableFuture returned by the HttpClient, we would then have to manually register our service using bundleContext.registerService (once the web page has been downloaded), and we 
would then have to check if the webpage has been downloaded each time a Tracked service is injected. And in case the page is not available, we would 
then have to cache the injected Tracked service and process it later, once the page has been downloaded.</p>
<p>Also, notice that when the page is injected in the setPage() method, you absolutely don't need to deal with
synchronization at all because in DM, all lifecycle and dependency callbacks are safely scheduled in a "serial queue" associated to the
component.</p>
<h2 id="sample-codes">Sample codes<a class="headerlink" href="#sample-codes" title="Permanent link">&para;</a></h2>
<p>many samples codes are available from the distribution source release: Please take a look at the following:</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasampleshello">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/hello/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasampleshello" title="Permanent link">&para;</a></h3>
<p>This sample provides a DM Activator declaring one service consumer and a service provider. The
ServiceConsumer is also depending on a configuration pid  (see org.apache.felix.dependencymanager.samples.hello.Configurator).</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplescompositefactory">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/compositefactory/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplescompositefactory" title="Permanent link">&para;</a></h3>
<p>This Activator is an example usage of DM composite components. A composite component is implemented
using a composition of multiple object instances, which are used to implement a given service.</p>
<p>The sample also uses a Factory approach in order to instantiate the composition of objects: A
"CompositionManager" is first injected with a Configuration that can possibly be used to create
and configure all the composites.</p>
<p>Dependencies are injected to some of the component implementation instances, using java8 method references. For instance,
the LogService is only injected in the ProviderImpl and the ProviderComposite1 class and not in the ProviderComposite2 class.</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesdevice">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/device/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesdevice" title="Permanent link">&para;</a></h3>
<p>This is an example showing a Dependency Manager "Adapter" in action. Two kinds of services are
registered in the registry: some Device, and some DeviceParameter services. For each Device (having
a given id), there is also a corresponding "DeviceParameter" service, having the same id.</p>
<p>Then a "DeviceAccessImpl" adapter service is defined: it is used to "adapt" the "Device" service to
a "DeviceAccess" service, which provides the union of each pair of Device/DeviceParameter having the
same device.id . The adapter also dynamically propagate the service properties of the adapted Device
service.</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesdictionary">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/dictionary/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesdictionary" title="Permanent link">&para;</a></h3>
<p>This sample shows a "SpellChecker" application which provides a
"dictionary:spellcheck" GOGO shell command. The GOGO "dictionary:spellcheck" command accepts a
string as parameter, which is checked for proper exactness. The SpellChecker class has a
required/multiple (1..N) dependency over every available "DictionaryService" services, which are
internally used by the SpellChecker command, when checking word exactness.</p>
<p>A DictionaryService is defined using a FactoryConfigurationAdapterService , allowing to instantiate
many "DictionaryService" instances for each configuration that are added to the
factory pid "Spell Checker Configuration" from web console.
The factory pid configuration metatypes are defined using the bnd "metatype" annotations
(see DictionaryConfiguration.java).</p>
<p>The DictionaryService is decorated with a DictionaryAspect, which you can instantiate by adding a
configuration to the "Spell Checker Aspect Dictionary" pid from web console. The
aspect configuration metatype is also declared using the bnd metatype annotations (see
DictionaryAspectConfiguration.java). </p>
<p>Before running this sample, go to webconsole, and add some words in the "<code>Spell Checker Configuration</code>" factory PID, and
in the "<code>Spell Checker Aspect Dictionary</code>" PID.</p>
<p>Then go to gogo shell, and type dm help. You will normally see the dictionary:spellcheck command.
Type dictionary:spellcheck with some words configured either in the spell checker configuration, or in the spell checker aspect configuration,
and the dictionary will check for proper word exactness.</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesfactory">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/factory/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesfactory" title="Permanent link">&para;</a></h3>
<p>This sample is an example usage of DM components that are created using a Factory object. 
The Factory is defined using java8 method references.</p>
<h3 id="orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesfuture">org.apache.felix.dependencymanager.lambda.samples/src/org/apache/felix/dm/lambda/samples/future/<a class="headerlink" href="#orgapachefelixdependencymanagerlambdasamplessrcorgapachefelixdmlambdasamplesfuture" title="Permanent link">&para;</a></h3>
<p>The purpose of this sample is to show an example usage of the new "CompletableFuture" dependency that has been
added in the dm-lambda library. CompletableFuture java8 class provides functional operations and promotes an asynchronous event-driven model.</p>
<p>In such model, you can use the new dm-lambda library to add dependencies on asynchronous events using the standard JDK CompletableFuture class.</p>
<p>In this example, the Activator first defines a PageLink component that is used to download a given page from the web. The service then parses 
the content of the page and returns all available hrefs (links) found from the web page.</p>
<p>The PageLink is initialized with the Felix web site URL, which is asynchronously downloaded from the PageLink::init method, using a CompletableFuture. 
The CF is then added as a "FutureDependency" in the PageLinkImpl.init() method, and when the CF completes, the PageLinkImpl.start() callback is invoked 
and the service is registered.</p>
<p>The Activator is then getting injected with the PageLink service, and displays the links (hrefs) found from the Felix web site.</p>
<p>Caution: if you are using a corporate http proxy, you have to fix the Activator in order to configure the ip addr and port number of your
http proxy.</p>
<h2 id="javadoc">Javadoc<a class="headerlink" href="#javadoc" title="Permanent link">&para;</a></h2>
<p>You can find the javadoc for the new Dependency Manager Lambda library <a href="../../../../apidocs/">here</a>.</p>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1733826 by pderop on Sun, 6 Mar 2016 18:46:17 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
