<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Dependency Manager - Factory Configuration Adapter Service</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="http://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="http://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <p><a href="/news.html">news</a>  <br />
<a href="/license.html">license</a>  <br />
<a href="/downloads.cgi">downloads</a>  <br />
<a href="/documentation.html">documentation</a>  <br />
<a href="/mailinglists.html">mailing lists</a>  <br />
<a href="/documentation/community/contributing.html">contributing</a>  <br />
<a href="/sitemap.html">site map</a>  <br />
<a href="http://www.apache.org/">asf</a>  <br />
<a href="http://www.apache.org/security/">security</a>  <br />
<a href="http://www.apache.org/foundation/sponsorship.html">sponsorship</a>  <br />
<a href="http://www.apache.org/foundation/thanks.html">sponsors</a>    </p>
<iframe
    src="http://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects.html">Apache Felix Subproject Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-dependency-manager.html">Apache Felix Dependency Manager</a>
      </div>

      <h1>Dependency Manager - Factory Configuration Adapter Service</h1>
      <p>A factory configuration adapter service creates an adapter for each matching configuration in Configuration Admin. For each new factory configuration matching the factoryPid, an adapter will be created based on the adapter implementation class. The adapter will be registered with the specified interface and with the specified adapter service properties. Depending on the propagate parameter, every public factory configuration properties (which don't start with ".") will be propagated along with the adapter service properties. It will also inherit all dependencies.</p>
<p>Usage Example:</p>
<div class="codehilite"><pre><span class="n">manager</span><span class="p">.</span><span class="n">createFactoryConfigurationAdapterService</span><span class="p">(</span>&quot;<span class="n">MyFactoryPid</span>&quot;<span class="p">,</span> &quot;<span class="n">update</span>&quot;<span class="p">,</span> <span class="n">true</span><span class="p">)</span>
    <span class="p">.</span><span class="n">setInterface</span><span class="p">(</span><span class="n">AdapterService</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">new</span> <span class="n">Hashtable</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="n">setImplementation</span><span class="p">(</span><span class="n">AdapterServiceImpl</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>
</pre></div>


<h2 id="factoryconfigurationadapterservice">@FactoryConfigurationAdapterService</h2>
<p>Annotates a class that acts as a Factory Configuration Adapter Service. 
For each new Config Admin factory configuration matching the specified 
factoryPid, an instance of this service will be created. The adapter will be 
registered with the specified interface, and with the specified adapter 
service properties. Depending on the propagate parameter, every public 
factory configuration properties (which don't start with ".") will be 
propagated along with the adapter service properties.</p>
<p>Like in @ConfigurationDependency, you can optionally specify the meta types of 
your configurations for Web Console GUI customization (configuration 
heading/descriptions/default values/etc ...). </p>
<h3 id="annotation-attributes">Annotation attributes:</h3>
<hr />
<p><strong><code>provides</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: all directly implemented interfaces.
The interface(s) to use when registering adapters. By default, directly implemented interfaces will be registered in the OSGi registry. </p>
<hr />
<p><strong><code>properties</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: --</p>
<p>Adapter Service properties. Notice that public factory configuration is also 
registered in service properties, (only if propagate is true). 
Public factory configuration properties are those which don't starts with a 
dot (".").</p>
<hr />
<p><strong><code>factoryPid</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: The class name, including the package.</p>
<p>Returns the factory pid whose configurations will instantiate the 
annotated service class. 
(By default, the pid is the service class name). </p>
<hr />
<p><strong><code>factoryClass</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: The class name, including the package.</p>
<p>Returns the factory pid from a class name. The full class name will be used as the 
configuration PID. You can use this method when you use an interface annoted with 
standard bndtols metatype annotations. (see http://www.aqute.biz/Bnd/MetaType).</p>
<hr />
<p><strong><code>updated</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: "updated"</p>
<p>The Update method to invoke (defaulting to "updated"), when a factory 
configuration is created or updated </p>
<hr />
<p><strong><code>propagate</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: false</p>
<p>Returns true if the configuration properties must be published 
along with the service. Any additional service properties specified directly 
are merged with these. </p>
<hr />
<p><strong><code>factoryMethod</code></strong>  <br />
<em>Required</em>: False  <br />
<em>Default</em>: --</p>
<p>Sets the static method used to create the adapter instance.</p>
<h3 id="usage-examples">Usage Examples</h3>
<p>Here, a "Dictionary" service instance is instantiated for each existing 
factory configuration instances matching the "DictionaryServiceFactory" 
factory pid:</p>
<div class="codehilite"><pre><span class="nd">@FactoryConfigurationAdapterService</span><span class="o">(</span><span class="n">factoryPid</span><span class="o">=</span><span class="s">&quot;DictionaryServiceFactory&quot;</span><span class="o">,</span> <span class="n">updated</span><span class="o">=</span><span class="s">&quot;updated&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DictionaryImpl</span> <span class="kd">implements</span> <span class="n">DictionaryService</span>
<span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">      * The key of our config admin dictionary language.</span>
<span class="cm">      */</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">LANG</span> <span class="o">=</span> <span class="s">&quot;lang&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">      * The key of our config admin dictionary values.</span>
<span class="cm">      */</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">WORDS</span> <span class="o">=</span> <span class="s">&quot;words&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">      * We store all configured words in a thread-safe data structure, because ConfigAdmin</span>
<span class="cm">      * may invoke our updated method at any time.</span>
<span class="cm">      */</span>
    <span class="kd">private</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">m_words</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

    <span class="cm">/**</span>
<span class="cm">      * Our Dictionary language.</span>
<span class="cm">      */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">m_lang</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">m_lang</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">config</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LANG</span><span class="o">);</span>
        <span class="n">m_words</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">words</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">[])</span> <span class="n">config</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">WORDS</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">m_words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="o">}</span>
     <span class="o">}</span>   
         <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>


<p>Here is the same example as above, but using meta types (the DM annotations metatype attributes are deprecated and 
it's better to use standard bnd metatype annotations, the following example are using bnd metatypes):</p>
<p>First, we declare our factory configuration metadata using standard bndtools metatype annotations (see http://www.aqute.biz/Bnd/MetaType):</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="n">sample</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">aQute.bnd.annotation.metatype.Meta.AD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">aQute.bnd.annotation.metatype.Meta.OCD</span><span class="o">;</span>

<span class="nd">@OCD</span><span class="o">(</span><span class="n">factory</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Declare here some Dictionary instances.&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DictionaryConfiguration</span> <span class="o">{</span>
   <span class="nd">@AD</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Describes the dictionary language.&quot;</span><span class="o">,</span> <span class="n">deflt</span> <span class="o">=</span> <span class="s">&quot;en&quot;</span><span class="o">)</span>
   <span class="n">String</span> <span class="nf">lang</span><span class="o">();</span>

   <span class="nd">@AD</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Declare here the list of words supported by this dictionary.&quot;</span><span class="o">)</span>
   <span class="n">List</span> <span class="nf">words</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>And here is the Dictionary service, and we instantiate our DictionaryConfiguration interface using the bndlib <em>Configurable</em> helper class.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">aQute.bnd.annotation.metatype.Configurable</span><span class="o">;</span>

<span class="nd">@FactoryConfigurationAdapterService</span><span class="o">(</span><span class="n">factoryPidClass</span><span class="o">=</span><span class="n">DictionaryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DictionaryImpl</span> <span class="kd">implements</span> <span class="n">DictionaryService</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updated</span><span class="o">(</span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">props</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// load configuration from the provided dictionary, or throw an exception of any configuration error.</span>
        <span class="n">DictionaryConfiguration</span> <span class="n">cnf</span> <span class="o">=</span> <span class="n">Configurable</span><span class="o">.</span><span class="na">createConfigurable</span><span class="o">(</span><span class="n">DictionaryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>

        <span class="n">m_lang</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">lang</span><span class="o">();</span>
        <span class="n">m_words</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">conf</span><span class="o">.</span><span class="na">words</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">m_words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1665812 by marrs on Wed, 11 Mar 2015 09:02:04 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
