<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - Configuration Handler</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="http://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="http://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <p><a href="/news.html">news</a>  <br />
<a href="/license.html">license</a>  <br />
<a href="/downloads.cgi">downloads</a>  <br />
<a href="/documentation.html">documentation</a>  <br />
<a href="/mailinglists.html">mailing lists</a>  <br />
<a href="/documentation/community/contributing.html">contributing</a>  <br />
<a href="/sitemap.html">site map</a>  <br />
<a href="http://www.apache.org/">asf</a>  <br />
<a href="http://www.apache.org/security/">security</a>  <br />
<a href="http://www.apache.org/foundation/sponsorship.html">sponsorship</a>  <br />
<a href="http://www.apache.org/foundation/thanks.html">sponsors</a>  <br />
</p>
<iframe
    src="http://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects.html">Apache Felix Subproject Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-ipojo.html">Apache Felix iPOJO</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-ipojo/apache-felix-ipojo-userguide.html">apache-felix-ipojo-userguide</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-ipojo/apache-felix-ipojo-userguide/describing-components.html">Describing components</a>
      </div>

      
      <div class="tip">
           This page is a translated version of <a href="/site/configuration-handler.html" target="felix_cwiki">/site/configuration-handler.html</a>. In case of
           doubt you might want to refer to the old page.
      </div>
      
      
      <h1>Configuration Handler</h1>
      <p>{include:apache-felix-ipojo-header}</p>
<div class="content">

# Configuration Handler

*This page presents how to configure component instances. This is managed by the configuration handler. This handler allows the configuration and dynamic reconfiguration of instances. A configuration is basically a set of couple (name, value). The name can be a field name or a property name associated to a field or/and a method. iPOJO also supports complex properties composed by maps, dictionaries, lists and arrays.*

{div:class=toc}
[TOC]
{div}

## Configurable Properties

To support configuration, the component type needs to declare which properties are configurable. These properties are not necessarily service properties but can be internal component properties.

## Examples
The following code depicts a simple configurable component. The 'm_foo' field will be injected using the 'foo' property, and will also be exposed as a service property. The `updateArray` method is a 'setter' method where the 'array' property will be injected. Properties injected into field are available in the constructor, setter method are available only after the constructor.

    @Component
    @Provides
    public class MyComponent implements MyService {
        @Property(name="foo")
        @ServiceProperty
        private String m_foo;

        @Property(name="array")
        public void updateArray(String[] array) {
         //...
        }
    }

The previous component can also be described using XML:

    <component classname="...MyComponent">
       <provides>
           <property name="foo" field="m_foo"/>
       </provides>
       <properties propagation="false"/>
           <Property name="foo" field="m_foo"/>
           <Property name="array" method="updateArray"/>
       </properties>
    </component>

The instance contains the configuration:

    <instance component="...MyComponent">
       <property name="foo" value="bar"/>
       <property name="array" value="{1, 2, 3}"/>
    </instance>

In the previous snippet, you can see three configurable properties. The first is a configurable property attached to the field 'foo' that is a service property too. The second is an array property attached to a method (updatArray). These three properties are configured by the instance configuration.

By setting the attribute *propagation* to *"true"*, you allow the property propagation to the service registration. It means that at each time that the configuration of the instance is updated; all properties contained in the configuration are propagated to the service registrations. For example, in the previous example, not only `foo` will be published but `array` are also published. To enable propagation use:

    @Component(propagation=true)

If a property has a method, this method is invoked each time that the property value changes (the method is called to push the initial value just after the constructor). The method receives one argument of the type of the property (an integer array in the example).

When an instance is reconfigured, an updated callback can also be called:

    @Updated
    public void updated() {
      // The instance was reconfigured
    }

    // OR
    @Updated
    public void updated(Dictionary conf) {
      // The instance was reconfigured, conf is the new configuration.
    }

## Exposing a Managed Service
The ManagedService is a service specified in the OSGi Compendium. It allows reconfiguring an instance with the Configuration Admin. There is two way for an iPOJO instance to expose a Managed Service.
* In the `@Component` annotation the `managedservice` attribute defines the managed service PID. In XML this is done using the `pid` attribute in the properties element (XML)
* In the instance configuration by configuring the `managed.service.pid` property

So, using annotation, you should use the `managedservice` attribute as follow:

    @Component(managedservice="my.pid")
    public class MyComponent {

    }

In XML, the `pid` attribute of the `properties` element does the same job.

    <component classname="...MyComponent">
       <!-- ... -->
       <properties pid="my.pid"/>
           <!-- ... -->
       </properties>
    </component>

Finally, instance may configure the managed service using the `managed.service.pid` configuration property:

    <instance component="...MyComponent">
      <property name="managed.service.pid" value="my.pid.2"/>
    </instance>

<div class="info" markdown="1">
**Type vs. Instance configuration**
If the managed service pid is specified both in the component type and in the instance configuration, the instance configuration is used.
</div>

The managed service pid is the identifier used by the Configuration Admin to attach configuration to Managed Services. First this pid must be unique (as any pid in OSGi). Moreover, this pid cannot be the same one that the pid used in the Managed Service Factory to create the instance (if you use this way to create your instance).

When an instance is reconfigured with the Managed Service, the configuration is propagated if the propagation is enabled.

## Dynamic Reconfiguration using Factories or ManagedServiceFactories
iPOJO instances support dynamic reconfiguration. To reconfigure an instance you can use both iPOJO `Factory` and the `ManagedServiceFactory` services exposed by the factory of the targeted instance. By calling the method *reconfigure* or *update* (according of the service you use), the handler receive the new configuration and apply it. If the propagation is activated, the service registrations are updated too. If there is an  `updated` callback, the callback is invoked.

## Being notified when a reconfiguration is completed
Sometimes you need to be notified when a reconfiguration is done (all setter method called). This can be done thanks to the `updated` attribute. This attribute specifies a method claeed when a configuration/reconfiguration is completed. This method receives a `Dictionary` containing the properties (pair <key,value>). Properties with no value are not in the received configuration.

Updated callback are declared as follow using annotations:

    @Updated
    public void updated() {
      // The instance was reconfigured
    }

    // OR
    @Updated
    public void updated(Dictionary conf) {
      // The instance was reconfigured, conf is the new configuration.
    }

    In XML, the method name is given as an attribute of the  element.
    {code:xml}
    <component className="...MyComponent">
       <!-- ... -->
       <properties updated="updated"/>
           <!-- ... -->
       </properties>
    </Component>

The callback is called *AFTER* the successful application of the reconfiguration.

{include:apache-felix-ipojo-footer}
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1422427 by fmeschbe on Sun, 16 Dec 2012 00:36:51 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
