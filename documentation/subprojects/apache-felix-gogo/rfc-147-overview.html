<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       https://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
  <head>
    <title>Apache Felix - RFC 147 Overview</title>
    <link rel="icon" href="/res/favicon.ico">
    <link rel="stylesheet" href="/res/site.css" type="text/css" media="all">
    <link rel="stylesheet" href="/res/codehilite.css" type="text/css" media="all">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <a href="https://felix.apache.org/">
          <img border="0" alt="Apache Felix" src="/res/logo.png">
        </a>
      </div>
      <div class="header">
        <a href="https://www.apache.org/">
          <img border="0" alt="Apache" src="/res/apache.png">
        </a>
      </div>
    </div>
    
    <div class="menu"> 
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p><a href="/news.html">News</a>  <br />
<a href="/license.html">License</a>  <br />
<a href="/downloads.cgi">Downloads</a>  <br />
<a href="/documentation.html">Documentation</a>  <br />
<a href="/documentation/community/project-info.html">Project Info</a>  <br />
<a href="/documentation/community/contributing.html">Contributing</a>  <br />
<a href="/sitemap.html">Site Map</a>  <br />
<a href="https://www.apache.org/">ASF</a>  <br />
<a href="https://www.apache.org/security/">Security</a>  <br />
<a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>  <br />
<a href="https://www.apache.org/foundation/thanks.html">Sponsors</a>    </p>
<iframe
    src="https://www.apache.org/ads/button.html"
    style="border-width:0; float: left"
    frameborder="0"
    scrolling="no"
    width="135"
    height="135">
</iframe>
    </div>
    
    <div class="main">
      <div class="breadcrump" style="font-size: 80%;">
        <a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/documentation.html">Documentation</a>&nbsp;&raquo&nbsp;<a href="/documentation/subprojects/apache-felix-gogo.html">Apache Felix Gogo</a>
      </div>

      <h1>RFC 147 Overview</h1>
      <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<p>The RFC-147 draft is not yet publicly available. It used to be called RFC-132, which can be found in an <a href="http://www.osgi.org/download/osgi-4.2-early-draft.pdf">early specification draft</a></p>
<p>This is an overview of its main features:</p>
<div class="toc">
<ul>
<li><a href="#standard-way-to-implement-and-run-commands-for-any-osgi-42-framework">Standard way to implement and run commands for any OSGi 4.2 framework</a><ul>
<li><a href="#commands-can-have-any-signature">Commands can have any signature</a></li>
<li><a href="#easy-to-use-interactively-no-unnecessary-syntax">Easy to use interactively - no unnecessary syntax</a></li>
<li><a href="#lists-maps-pipes-and-closures">Lists, maps, pipes and closures</a></li>
<li><a href="#leverages-existing-java-capabilities-via-reflection">Leverages existing Java capabilities, via reflection</a></li>
<li><a href="#easy-to-implement-and-test-commands-without-needing-osgi">Easy to implement and test commands without needing OSGi</a></li>
<li><a href="#normal-commands-can-provide-control-primitives">Normal commands can provide control primitives</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="standard-way-to-implement-and-run-commands-for-any-osgi-42-framework">Standard way to implement and run commands for any OSGi 4.2 framework<a class="headerlink" href="#standard-way-to-implement-and-run-commands-for-any-osgi-42-framework" title="Permanent link">&para;</a></h2>
<p>Commands are registered via service attributes, you don't have to register a specific service. This allows commands to be registered by existing services, just by adding the new attributes:</p>
<div class="codehilite"><pre><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">dict</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
<span class="n">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_SCOPE</span><span class="o">,</span> <span class="s">&quot;shell&quot;</span><span class="o">);</span>
<span class="n">dict</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_FUNCTION</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">&quot;sleep&quot;</span><span class="o">,</span> <span class="s">&quot;grep&quot;</span><span class="o">});</span>
<span class="n">context</span><span class="o">.</span><span class="na">registerService</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">dict</span><span class="o">);</span>
</pre></div>


<p>Scope is used to provide a namespace for commands. The commands above can be invoked as <code>shell:sleep</code> and <code>shell:grep</code>. If the scope is omitted (e.g. <code>sleep</code> and <code>grep</code>) then the first matching command is invoked.</p>
<h3 id="commands-can-have-any-signature">Commands can have any signature<a class="headerlink" href="#commands-can-have-any-signature" title="Permanent link">&para;</a></h3>
<p>Arguments are coerced to call the best matching method using reflection. A <code>CommandSession</code> argument is inserted if required:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">millis</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">grep</span><span class="o">(</span><span class="n">CommandSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</pre></div>


<p>The <code>CommandSession</code> interface provides methods for executing commands and getting and setting session variables:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">felix</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">command</span><span class="o">.</span><span class="na">CommandSession</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">commandline</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
    <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>


<h3 id="easy-to-use-interactively-no-unnecessary-syntax">Easy to use interactively - no unnecessary syntax<a class="headerlink" href="#easy-to-use-interactively-no-unnecessary-syntax" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>basic commands</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">echo</span> <span class="n">hello</span> <span class="n">world</span>
<span class="n">hello</span> <span class="n">world</span>
</pre></div>


</li>
<li>
<p>session variables</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">msg</span> <span class="p">=</span> &quot;<span class="n">hello</span> <span class="n">world</span>&quot;
<span class="n">g</span>! <span class="n">echo</span> $<span class="n">msg</span>
<span class="n">hello</span> <span class="n">world</span>
</pre></div>


</li>
<li>
<p>execution quotes <code>()</code> - similar to bash backquotes</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="p">(</span><span class="n">bundle</span> 1<span class="p">)</span> <span class="n">location</span>
<span class="n">file</span><span class="p">:</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">derek</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">felix</span><span class="o">-</span><span class="n">framework</span><span class="o">-</span>3<span class="p">.</span>0<span class="p">.</span>0<span class="o">/</span><span class="n">bundle</span><span class="o">/</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">bundlerepository</span><span class="o">-</span>1<span class="p">.</span>6<span class="p">.</span>2<span class="p">.</span><span class="n">jar</span>
</pre></div>


</li>
</ul>
<h3 id="lists-maps-pipes-and-closures">Lists, maps, pipes and closures<a class="headerlink" href="#lists-maps-pipes-and-closures" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>lists - <code>[]</code></p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">list</span> <span class="p">=</span> <span class="p">[</span>1 2 <span class="n">a</span> <span class="n">b</span><span class="p">]</span>
1
2
<span class="n">a</span>
<span class="n">b</span>
</pre></div>


</li>
<li>
<p>maps - <code>[]</code></p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">map</span> <span class="p">=</span> <span class="p">[</span><span class="n">Jan</span><span class="p">=</span>1 <span class="n">Feb</span><span class="p">=</span>2 <span class="n">Mar</span><span class="p">=</span>3<span class="p">]</span>
<span class="n">Jan</span>                 1
<span class="n">Feb</span>                 2
<span class="n">Mar</span>                 3
</pre></div>


</li>
<li>
<p>pipes - <code>|</code></p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">bundles</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">gogo</span>
    2<span class="o">|</span><span class="n">Active</span>     <span class="o">|</span>    1<span class="o">|</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">command</span> <span class="p">(</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">)</span>
    3<span class="o">|</span><span class="n">Active</span>     <span class="o">|</span>    1<span class="o">|</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span> <span class="p">(</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">)</span>
    4<span class="o">|</span><span class="n">Active</span>     <span class="o">|</span>    1<span class="o">|</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">shell</span> <span class="p">(</span>0<span class="p">.</span>6<span class="p">.</span>0<span class="p">)</span>
</pre></div>


</li>
<li>
<p>closures - <code>{}</code></p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">echo2</span> <span class="p">=</span> <span class="p">{</span> <span class="n">echo</span> <span class="n">xxx</span> $<span class="n">args</span> <span class="n">yyy</span> <span class="p">}</span>
<span class="n">g</span>! <span class="n">echo2</span> <span class="n">hello</span> <span class="n">world</span>
<span class="n">xxx</span> <span class="n">hello</span> <span class="n">world</span> <span class="n">yyy</span>
</pre></div>


</li>
</ul>
<h3 id="leverages-existing-java-capabilities-via-reflection">Leverages existing Java capabilities, via reflection<a class="headerlink" href="#leverages-existing-java-capabilities-via-reflection" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>exception handling - console shows summary, but full context available</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">start</span> <span class="n">xxx</span>
<span class="n">E</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">coerce</span> <span class="n">start</span><span class="p">[</span><span class="n">xxx</span><span class="p">]</span> <span class="n">to</span> <span class="n">any</span> <span class="n">of</span> <span class="p">[(</span><span class="n">Bundle</span><span class="p">)]</span>
<span class="n">g</span>! $<span class="n">exception</span> <span class="n">printstacktrace</span>
<span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">IllegalArgumentException</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">coerce</span> <span class="n">start</span><span class="p">[</span><span class="n">xxx</span><span class="p">]</span> <span class="n">to</span> <span class="n">any</span> <span class="n">of</span> <span class="p">[(</span><span class="n">Bundle</span><span class="p">)]</span>
        <span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">shell</span><span class="p">.</span><span class="n">Reflective</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">Reflective</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>162<span class="p">)</span>
        <span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">shell</span><span class="p">.</span><span class="n">Command</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Command</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>40<span class="p">)</span>
        <span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">shell</span><span class="p">.</span><span class="n">Closure</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Closure</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>211<span class="p">)</span>
        <span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">shell</span><span class="p">.</span><span class="n">Closure</span><span class="p">.</span><span class="n">executeStatement</span><span class="p">(</span><span class="n">Closure</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>146<span class="p">)</span>
        <span class="n">at</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">gogo</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">shell</span><span class="p">.</span><span class="n">Pipe</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">Pipe</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>91<span class="p">)</span>
<span class="p">...</span>
</pre></div>


</li>
<li>
<p>add all public methods on <code>java.lang.System</code> as commands:</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">addcommand</span> <span class="n">system</span> <span class="p">(</span><span class="n">loadClass</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">System</span><span class="p">)</span>
<span class="n">g</span>! <span class="n">system</span><span class="p">:</span><span class="n">getproperties</span>
<span class="n">sun</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">unicode</span><span class="p">.</span><span class="n">encodingUnicodeLittle</span>
<span class="n">java</span><span class="p">.</span><span class="n">version</span>        1<span class="p">.</span>5<span class="p">.</span>0<span class="n">_19</span>
<span class="n">java</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">path</span>     <span class="n">bin</span><span class="o">/</span><span class="n">felix</span><span class="p">.</span><span class="n">jar</span>
<span class="n">java</span><span class="p">.</span><span class="n">awt</span><span class="p">.</span><span class="n">graphicsenvapple</span><span class="p">.</span><span class="n">awt</span><span class="p">.</span><span class="n">CGraphicsEnvironment</span>
<span class="n">user</span><span class="p">.</span><span class="n">language</span>       <span class="n">en</span>
<span class="n">sun</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">level</span>  <span class="n">unknown</span>
<span class="n">os</span><span class="p">.</span><span class="n">version</span>          10<span class="p">.</span>6<span class="p">.</span>2
<span class="p">[</span><span class="n">snip</span><span class="p">]</span>
</pre></div>


</li>
</ul>
<h3 id="easy-to-implement-and-test-commands-without-needing-osgi">Easy to implement and test commands without needing OSGi<a class="headerlink" href="#easy-to-implement-and-test-commands-without-needing-osgi" title="Permanent link">&para;</a></h3>
<p>Command implementations don't need to reference any OSGi interfaces. They can use <code>System.in</code>, <code>System.out</code> and <code>System.err</code>, just as you would in a trivial Java application. The <code>ThreadIO</code> service transparently manages the singleton <code>System.out</code> etc, so that each thread sees the appropriate stream:</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">cat</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IOUtil</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="normal-commands-can-provide-control-primitives">Normal commands can provide control primitives<a class="headerlink" href="#normal-commands-can-provide-control-primitives" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">each</span><span class="o">(</span><span class="n">CommandSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">Function</span> <span class="n">closure</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">x</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">closure</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>then</p>
<div class="codehilite"><pre><span class="n">g</span>! <span class="n">each</span> <span class="p">[</span><span class="n">Jan</span> <span class="n">Feb</span> <span class="n">Mar</span><span class="p">]</span> <span class="p">{</span> <span class="n">echo</span> $<span class="n">it</span> <span class="o">|</span> <span class="n">grep</span> <span class="p">.</span> <span class="p">}</span>
<span class="n">Jan</span>
<span class="n">Feb</span>
<span class="n">Mar</span>
</pre></div>


<p><strong>Note:</strong> The default <em>echo</em> command <em>returns</em> a String and does not write to System.out. Also, by default, the console prints the results of each command, so <em>echo</em> appears to behave as you would expect.
However, the console does not see the <em>each</em> closure above, so the result of echo would not be seen. This is why it is piped into <em>grep</em>, as the <em>result</em> of the command as well as its output is written to a pipeline.</p>
      <div class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
        Rev. 1842619 by rotty3000 on Tue, 2 Oct 2018 13:27:49 +0000
      </div>
      <div class="trademarkFooter"> 
        Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project
        logo are trademarks of The Apache Software Foundation. All other marks mentioned
        may be trademarks or registered trademarks of their respective owners.
      </div>
    </div>
  </body>
</html>
