
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - Release Management</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="license.html" title="license">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<DIV class="panelMacro"><TABLE class="warningMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="http://cwiki.apache.org/confluence/images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Warning</B><BR>This document has been <B>DEPRECATED</B> by <A href="release-management-nexus.html" title="Release Management (Nexus)">Release Management &#40;Nexus&#41;</A>. Please follows the <B>NEW</B> releasing instructions <A href="release-management-nexus.html" title="Release Management (Nexus)">Release Management &#40;Nexus&#41;</A>.</TD></TR></TABLE></DIV> 

<P>This is a draft for a how to about releasing artifacts from Apache Felix:</P>

<P>Most of the work is done by Maven.</P>

<H2><A name="ReleaseManagement-Prerequisites"></A>Prerequisites</H2>

<P>To prepare or perform a release you <B>MUST BE</B> at least a Apache Felix Committer</P>

<P>Each and every release must be signed; therefore the public key should be cross signed by other Apache committers (not required but suggested).<BR>
The public key should be added to <A href="http://www.apache.org/dist/felix/KEYS" class="external-link" rel="nofollow">http://www.apache.org/dist/felix/KEYS</A> (See Appendix A)</P>

<P>When preparing the release on Mac OS X, check out Appendix F before trying the steps in the next chapter.</P>

<H2><A name="ReleaseManagement-BuildingtheReleaseCandidates"></A>Building the Release Candidates</H2>

<UL>
	<LI>Make sure that an appropriate version for the release is entered in Jira</LI>
	<LI>Build the release artifacts with Maven (the following instructions work on Unix systems, for Windows use a different path than /tmp)
	<UL>
		<LI><DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>mvn -Prelease -Darguments=&quot;-Prelease -DaltDeploymentRepository=local::default::file:///tmp&quot; -DaltDeploymentRepository=local::default::file:///tmp  release:prepare</PRE>
</DIV></DIV></LI>
		<LI><DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>mvn -Prelease -Darguments=&quot;-Prelease -DaltDeploymentRepository=local::default::file:///tmp&quot; -DaltDeploymentRepository=local::default::file:///tmp  release:perform</PRE>
</DIV></DIV></LI>
	</UL>
	</LI>
	<LI>The above commands created a tag in svn, deployed the release candidates into your /tmp directory, signed the binaries and created the md5/sha1 files.</LI>
	<LI>Beautify the checksums (see Appendix B)</LI>
	<LI>Upload these files to people.apache.org into your home folder and put them there together with the KEYS file containing your public key so we can verify the signatures.</LI>
	<LI>Start the vote thread, wait 72 hours.</LI>
	<LI>If the vote fails (easy case first) remove the tag from svn - done</LI>
	<LI>If the vote is successful, publish the release (see below)</LI>
	<LI>Create a new version for the artifact in jira.</LI>
</UL>


<H2><A name="ReleaseManagement-PublishingtheRelease"></A>Publishing the Release</H2>

<P>If the vote is successful:</P>
<UL>
	<LI>copy the released artifacts to the dist directory on www.apache.org/dist/felix</LI>
	<LI>delete the old release there (its archived)</LI>
	<LI>deploy the release to the maven repository</LI>
	<LI>Update the news section on the website</LI>
	<LI>Update the download page on the website to point to the new release.</LI>
	<LI>If you're releasing bundles, you can add it to the Felix Release OBR (see below the Appendix E).</LI>
</UL>


<P>For the last two tasks, it's better to give the mirrors some time to distribute the uploaded artifacts (one day should be fine). This ensures that once the website (news and download page) is updated, people can actually download the artifacts.</P>

<H2><A name="ReleaseManagement-RelatedLinks"></A>Related Links</H2>
<OL>
	<LI><A href="http://www.apache.org/dev/release-signing.html" class="external-link" rel="nofollow">http://www.apache.org/dev/release-signing.html</A></LI>
	<LI><A href="http://wiki.apache.org/incubator/SigningReleases" class="external-link" rel="nofollow">http://wiki.apache.org/incubator/SigningReleases</A></LI>
</OL>


<H2><A name="ReleaseManagement-AppendixA%3ACreateandAddyourkeyto"></A>Appendix A: Create and Add your key to <A href="http://www.apache.org/dist/felix/KEYS" class="external-link" rel="nofollow">http://www.apache.org/dist/felix/KEYS</A></H2>

<P>Considering that you are using a *nix system with a working OpenSSH, GnuPG, and bash you can create and add your own key with the following command:</P>
<OL>
	<LI><EM>Create a public/private pair key</EM>:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
gpg --gen-key
</PRE>
</DIV></DIV>
<P>  When gpg asks for e-mail linked the key you  <B>MUST USE</B> the &lt;committer&gt;@apache.org one<BR>
  When gpg asks for comment linked the key you <EM>SHOULD USE</EM> &quot;CODE SIGNING KEY&quot;</P></LI>
	<LI><EM>Add the key to</EM> <A href="http://www.apache.org/dist/felix/KEYS:" class="external-link" rel="nofollow">http://www.apache.org/dist/felix/KEYS:</A> type the following command replacing the word e-mail with your Apache's one (&lt;committer&gt;@apache.org).
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
(gpg --list-sigs e-mail &amp;&amp; gpg --export --armor e-mail) &gt; toadd.key
scp toadd.key people.apache.org:
ssh people.apache.org <SPAN class="code-quote">&quot;cat toadd.key &gt;&gt; /x1/www/www.apache.org/dist/felix/KEYS&quot;</SPAN>
</PRE>
</DIV></DIV></LI>
	<LI>You are <B>DONE</B>, but to see the changes on <A href="http://www.apache.org/dist/felix/KEYS" class="external-link" rel="nofollow">http://www.apache.org/dist/felix/KEYS</A> you must wait 2 hours</LI>
</OL>


<H2><A name="ReleaseManagement-AppendixB%3ABeautifyingthechecksums"></A>Appendix B: Beautifying the checksums</H2>

<P>The checksum files generated by Maven are not directly usable with all tools. So the following scripts beautify these:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
   <SPAN class="code-keyword">for</SPAN> f in *.md5 ; <SPAN class="code-keyword">do</SPAN> g=`echo $f | sed <SPAN class="code-quote">&quot;s/\.md5<SPAN class="code-comment">//&quot;</SPAN>` ; echo <SPAN class="code-quote">&quot;  $g&quot;</SPAN> &gt;&gt; $f ;
</SPAN>done
   <SPAN class="code-keyword">for</SPAN> f in *.sha1 ; <SPAN class="code-keyword">do</SPAN> g=`echo $f | sed <SPAN class="code-quote">&quot;s/\.sha1<SPAN class="code-comment">//&quot;</SPAN>` ; echo <SPAN class="code-quote">&quot;  $g&quot;</SPAN> &gt;&gt; $f ;
</SPAN>done
</PRE>
</DIV></DIV>

<H2><A name="ReleaseManagement-AppendixC%3AScripttocheckreleases"></A>Appendix C: Script to check releases</H2>
<P>Felix Meschberger has developed a set of script aim at testing the file to release. You can find them here:
<A href="http://people.apache.org/~fmeschbe/release_helpers/" class="external-link" rel="nofollow">http://people.apache.org/~fmeschbe/release_helpers/</A></P>

<P>For those, using the Felix's script to create their releases, the last maven-release-plugin has changed. So, it doesn't work anymore. You have to add the </P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">-DmavenExecutorId=forked-path</PRE>
</DIV></DIV>
<P> property to have the former behavior. If not, you won't be able to enter your GPG passphrase.</P>

<P>I'm sure there is others turn around, but at least this one works.</P>

<P>So, for mac users, it is something like:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
mvn -Prelease -Darguments=<SPAN class="code-quote">&quot;-Prelease ${REPO}&quot;</SPAN> ${REPO} -DmavenExecutorId=forked-path release:prepare -Dusername=clement -Dpassword=*********
svn up -r head
mvn release:prepare -Dresume
mvn -Prelease -Darguments=<SPAN class="code-quote">&quot;-Prelease ${REPO}&quot;</SPAN> ${REPO} -DmavenExecutorId=forked-path release:perform
</PRE>
</DIV></DIV>

<H2><A name="ReleaseManagement-AppendixD%3AControlthereleaseprocessmanually"></A>Appendix D: Control the release process manually</H2>

<P>The release process is a two-step process. First the release is prepared and the release candidates are performed. <BR>
However, for some dark reasons  (☺), you would like to manage the preparation process with more control. Then, you can to the creation of the RC with maven. However, the explained process follows exactly what maven does.</P>

<H3><A name="ReleaseManagement-Preparationsteps"></A>Preparation steps</H3>
<OL>
	<LI>Check that there's no uncommitted changes in the sources</LI>
	<LI>Check that there's no SNAPSHOT dependencies<BR>
 -&gt; Both for plugins and dependencies<BR>
 -&gt; Change the version in the poms from x-SNAPSHOT to a new version </LI>
	<LI>Compile your artifact from scratch
  <DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">mvn clean install</PRE>
</DIV></DIV></LI>
	<LI>Update your pom file to add SCM information:<BR>
  -&gt; The TAG_NAME must be under the form $ARTIFACT_ID&#45;$VERSION</LI>
	<LI>Add the following element at the end of your pom file (before &lt;/project&gt;:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;scm&gt; 
&lt;connection&gt;scm:svn:https:<SPAN class="code-comment">//svn.apache.org/repos/asf/felix/releases/YOUR_TAG&lt;/connection&gt;
</SPAN>&lt;developerConnection&gt;scm:svn:https:<SPAN class="code-comment">//svn.apache.org/repos/asf/felix/releases/YOUR_TAG&lt;/developerConnection&gt;
</SPAN>&lt;url&gt;scm:svn:https:<SPAN class="code-comment">//svn.apache.org/repos/asf/felix/releases/YOUR_TAG&lt;/url&gt;
</SPAN>&lt;/scm&gt;
</PRE>
</DIV></DIV></LI>
	<LI>Try to create assemblies and to sign them (dry run)
 <DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">mvn verify -Prelease</PRE>
</DIV></DIV>
<P> -&gt; This command creates assemblies and sign them according to the 'release' profile set in the Felix global pom file.</P></LI>
	<LI>You can also test your project to check that everything works as expected<BR>
 -&gt; Test your project<BR>
 -&gt; Check that RC files contains the correct LICENSE and NOTICE<BR>
 -&gt; Run arat to check missing header file<BR>
 -&gt; Check that the changelog.txt file are available in the doc folder<BR>
 -&gt; ...</LI>
	<LI>Commit the changes<BR>
 -&gt; Commit message is generally something like:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">   
prepare release YOUR_TAG
</PRE>
</DIV></DIV></LI>
	<LI>Creates the tag<BR>
 -&gt; The tag must be creates in <A href="https://svn.apache.org/repos/asf/felix/releases/TAG_NAME" class="external-link" rel="nofollow">https://svn.apache.org/repos/asf/felix/releases/TAG_NAME</A><BR>
 -&gt; The TAG_NAME must be under the form: $ARTIFACT_ID&#45;$VERSION</LI>
</OL>


<H3><A name="ReleaseManagement-Performthereleasecandidates"></A>Perform the release candidates</H3>
<P>You must create the release candidates from the created tags. You can do it by executing the following command:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
mvn -Prelease -Dtag=TAG_NAME -DtagBase=https:<SPAN class="code-comment">//svn.apache.org/repos/asf/felix/releases -DconnectionUrl=scm:svn:https://svn.apache.org/repos/asf/felix/releases/ -Darguments=<SPAN class="code-quote">&quot;-Prelease -DaltDeploymentRepository=local::<SPAN class="code-keyword">default</SPAN>::file:///tmp&quot;</SPAN> -DaltDeploymentRepository=local::<SPAN class="code-keyword">default</SPAN>::file:///tmp release:perform</SPAN>
</PRE>
</DIV></DIV>
<P>Update the 'altDeploymentRepository' path (twice) to fit with your configuration (this works on Linux and MacOS X)<BR>
The perform phase does the following actions:</P>
<OL>
	<LI>Checkout the tagged version</LI>
	<LI>Compile it</LI>
	<LI>Create assemblies (project and bin)</LI>
	<LI>Sign artifacts (assemblies)</LI>
	<LI>Copy those artifacts in the 'altDeploymentRepository'</LI>
</OL>


<P>Don't forget to beautify .md5 and .sha1 files and check signatures of the generated files. Then you can upload those files on people.apache.org and call the vote...</P>

<H3><A name="ReleaseManagement-Preparetothenextdevelopmentiteration"></A>Prepare to the next development iteration</H3>
<P>Go back to your working copy of the trunk code. Edit the pom files to update the version number to the next development iteration version (don't forget the -SNAPSHOT).<BR>
Then remove the &lt;scm&gt;&lt;/scm&gt; element added at the end of your pom file.<BR>
Commit the resulting file. Commit message is generally something like:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
Prepares <SPAN class="code-keyword">for</SPAN> next development iteration (NEW_VERSION)
</PRE>
</DIV></DIV>

<P>That's all. Now you can control more finely how to prepare your release and demystify the maven-release-plugin.</P>

<H2><A name="ReleaseManagement-AppendixE%3ADeploybundlesontheFelixOBR"></A>Appendix E: Deploy bundles on the Felix OBR</H2>

<P>If you're releasing bundles, you can add it to the Felix Release OBR. To do this, you execute the following command:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
mvn clean install \
    org.apache.felix:maven-bundle-plugin:deploy \
    -DprefixUrl=http:<SPAN class="code-comment">//repo1.maven.org/maven2 \
</SPAN>    -DremoteOBR=releases.xml \
    -DaltDeploymentRepository=apache.releases::<SPAN class="code-keyword">default</SPAN>::scp:<SPAN class="code-comment">//people.apache.org/www/felix.apache.org/obr</SPAN>
</PRE>
</DIV></DIV>
<P>The <A href="http://felix.apache.org/obr/releases.xml" class="external-link" rel="nofollow">http://felix.apache.org/obr/releases.xml</A> page is updated during the web site synchronization.<BR>
<B>Note</B>: the project building the bundle must use the <A href="apache-felix-maven-bundle-plugin-bnd.html" title="Apache Felix Maven Bundle Plugin (BND)">maven-bundle-plugin</A> and use a version superior or equals to 1.4.2.</P>

<H2><A name="ReleaseManagement-AppendixF%3AReleasingonMacOSX"></A>Appendix F: Releasing on Mac OS X</H2>

<P>When running the mvn release:prepare command, you might get the following error:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">[INFO] Executing: svn --non-interactive commit --file /tmp/maven-scm-802409492.commit --targets /tmp/maven-scm-18804-targets
[INFO] Working directory: /homedir/dev/felix/dependencymanager
[INFO] ------------------------------------------------------------------------
[ERROR] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Unable to commit files
Provider message:
The svn command failed.
Command output:
svn: Commit failed (details follow):
svn: MKACTIVITY of '/repos/asf/!svn/act/4f11ad5d-9161-0410-b4dd-cb727141ea8c': authorization failed (https:<SPAN class="code-comment">//svn.apache.org)</SPAN></PRE>
</DIV></DIV>

<P>There is a bug in svn on the Mac, as described by <A href="http://blogs.exist.com/bporter/2008/02/25/working-around-non-interactive-problems-in-leopards-subversion/" class="external-link" rel="nofollow">Brett Porter in his blog</A>. He proposes to put a &quot;svn&quot; script at the head of your path to fix the issue. That solved the issue for me so I'm mentioning it here to save people the lookup.</P>

    </DIV>
  </BODY>
</HTML>
