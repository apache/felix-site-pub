
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - iPOJO Advanced Tutorial</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/superfish.css); 
</STYLE>

<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/style.css); 
</STYLE>

<P>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shCore.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushCSharp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPhp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJScript.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushVb.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushSql.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushXml.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushShell.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushDelphi.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPython.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJava.js"></SCRIPT>

<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/jquery-1.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/hoverIntent.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/superfish.js"></SCRIPT> 
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/supersubs.js"></SCRIPT> 

<SCRIPT type="text/javascript"> 
 
    $(document).ready(function(){ 
        $("ul.sf-menu").supersubs({ 
            minWidth:    14,   // minimum width of sub-menus in em units 
            maxWidth:    30,   // maximum width of sub-menus in em units 
            extraWidth:  1     // extra width can ensure lines don't sometimes turn over 
                               // due to slight rounding differences and font-family 
        }).superfish();  // call supersubs first, then superfish, so that subs are 
                         // not display:none when measuring. Call before initialising 
                         // containing tabs for same reason. 
    }); 
 
</SCRIPT>
<DIV class="main">
<DIV class="page-header">
<IMG src="http://felix.apache.org/ipojo/site/header.png" class="header">
<A href="http://ipojo.org/"><IMG src="http://felix.apache.org/ipojo/site/ipojo.png" width="225" class="header-logo"></A>
<UL class="sf-menu sf-js-enabled sf-shadow" id="ipojo-menu">
<LI class="current">
<!-- Menu Overview -->
<A href="" class="sf-with-ul">Overview<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
	<LI>
	<A href="apache-felix-ipojo.html" title="Apache Felix iPOJO">Home</A>							
	</LI>
	<LI>
	<A href="apache-felix-ipojo-why-choose-ipojo.html" title="apache-felix-ipojo-why-choose-ipojo">Why choose iPOJO</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-successstories.html" title="apache-felix-ipojo-successstories">Success stories</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-feature-overview.html" title="Apache Felix iPOJO Feature Overview">Features</A>
	</LI>
</UL>
</LI>	

<LI class="">			
<!-- Menu download -->
<LI>
<A href="download.html" title="Download">Download </A>
</LI>

<LI class="">					
<!-- Menu Documentation -->
<A href="" class="sf-with-ul">Documentation<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
    <!-- sub- menu : getting started -->
    <LI class="">
    <A href="" class="sf-with-ul">Getting Started<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
    <UL>
     <LI><A href="ipojo-in-10-minutes.html" title="iPOJO in 10 minutes">iPOJO in 10 minutes</A></LI>
     <LI><A href="how-to-use-ipojo-annotations.html" title="How to use iPOJO Annotations">Using Annotations</A></LI>
     <LI><A href="ipojo-hello-word-maven-based-tutorial.html" title="iPOJO Hello Word (Maven-Based) tutorial">Maven tutorial</A></LI>
     <LI><A href="" title="iPOJO Advanced Tutorial">Advanced tutorial</A></LI>
     <LI><A href="apache-felix-ipojo-dosgi.html" title="apache-felix-ipojo-dosgi">Using Distributed OSGi</A></LI>
     <LI><A href="ipojo-composition-tutorial.html" title="iPOJO Composition Tutorial">Application Composition</A></LI>
    </UL>
    </LI> <!-- end of getting started -->
    <!-- sub menu : Describing Components -->
     <LI class="">
        <A href="http://felix.apache.org/site/describing-components.html" class="sf-with-ul">Describing components<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="service-requirement-handler.html" title="Service Requirement Handler">Requiring a service</A></LI>
        <LI><A href="providing-osgi-services.html" title="Providing OSGi services">Providing a service</A></LI>
        <LI><A href="lifecycle-callback-handler.html" title="Lifecycle Callback Handler">Lifecycle management</A></LI>
        <LI><A href="configuration-handler.html" title="Configuration Handler">Configuration</A></LI>
        <LI><A href="architecture-handler.html" title="Architecture Handler">Introspection</A></LI>
        <LI><A href="controller-lifecycle-handler.html" title="Controller Lifecycle Handler">Impacting the lifecycle</A></LI>
        <LI><A href="event-admin-handlers.html" title="Event Admin Handlers">Asynchronous communication</A></LI>
        <LI><A href="ipojo-jmx-handler.html" title="iPOJO JMX Handler">JMX management</A></LI>
        <LI><A href="extender-pattern-handler.html" title="Extender Pattern Handler">Extender pattern</A></LI>
        <LI><A href="white-board-pattern-handler.html" title="White Board Pattern Handler">Whiteboard pattern</A></LI>
        <LI><A href="temporal-service-dependency.html" title="Temporal Service Dependency">Temporal dependencies</A></LI>
        </UL>
     </LI> <!-- End of describing components -->
    <!-- sub- menu : User Guide -->
    <LI class="">
    <A href="" class="sf-with-ul">User Guide<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="combining-ipojo-and-configuration-admin.html" title="Combining iPOJO and Configuration Admin">iPOJO and config admin</A></LI>
        <LI><A href="how-to-use-ipojo-factories.html" title="How-to use iPOJO factories">Factories and Instances</A></LI>
        <LI><A href="using-xml-schemas.html" title="Using XML Schemas">XML Schemas</A></LI>
        <LI><A href="apache-felix-ipojo-api.html" title="apache-felix-ipojo-api">API</A></LI>
        <LI><A href="apache-felix-ipojo-testing-components.html" title="apache-felix-ipojo-testing-components">Testing components</A></LI>
        <LI><A href="apache-felix-ipojo-eclipse-integration.html" title="apache-felix-ipojo-eclipse-integration">Eclipse Integration</A></LI>
        <LI><A href="ipojo-faq.html" title="iPOJO FAQ">FAQ</A></LI>
        <LI><A href="ipojo-reference-card.html" title="iPOJO-Reference-Card">Reference Card</A></LI>
        </UL>
    </LI> <!-- end of user guide -->
    <!-- sub- menu : Dev Guide -->
    <LI> 
    <A href="" class="sf-with-ul">Advanced Topics<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
       <UL>
        <LI><A href="http://felix.apache.org/ipojo/api/1.6.0" class="external-link" rel="nofollow">Javadoc</A></LI>
        <LI><A href="how-to-write-your-own-handler.html" title="How to write your own handler">Handler development</A></LI>
        <LI><A href="how-to-use-ipojo-manipulation-metadata.html" title="How to use iPOJO Manipulation Metadata">Manipulation Metadata </A></LI>
        <LI><A href="dive-into-the-ipojo-manipulation-depths.html" title="Dive into the iPOJO Manipulation depths">Dive into the iPOJO Manipulation depths</A></LI>
       </UL>
    </LI> <!-- End of Dev guide -->
</UL> 
</LI> <!-- End of doc -->
<!-- Menu 4 : Tools -->
<LI class="">
<A href="" class="sf-with-ul">Tools<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="ipojo-ant-task.html" title="iPOJO Ant Task">Ant Task</A></LI>
   <LI><A href="ipojo-eclipse-plug-in.html" title="iPOJO Eclipse Plug-in">Eclipse Plugin</A></LI>
   <LI><A href="ipojo-maven-plug-in.html" title="iPOJO Maven Plug-in">Maven Plugin</A></LI>
   <LI><A href="ipojo-arch-command.html" title="iPOJO-Arch-Command"><TT>arch</TT> shell command</A></LI>
   <LI><A href="apache-felix-ipojo-online-manipulator.html" title="apache-felix-ipojo-online-manipulator">Online Manipulator</A></LI>
   <LI><A href="ipojo-webconsole-plugin.html" title="iPOJO Webconsole Plugin">Webconsole plugin</A></LI>
   <LI><A href="apache-felix-ipojo-junit4osgi.html" title="apache-felix-ipojo-junit4osgi">Junit4OSGi</A></LI>
</UL>   
</LI><!-- End of tools -->	
<!-- Menu 5 : Support -->
<LI>
<A href="ipojo-support.html" title="ipojo-support">Support </A>
</LI>
<!-- End of the menu 5 -->			
<!-- Menu 6 : Misc -->
<LI class="">
<A href="" class="sf-with-ul">Misc<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="apache-felix-ipojo-supportedvms.html" title="apache-felix-ipojo-supportedVMs">Supported JVMs</A></LI>
   <LI><A href="apache-felix-ipojo-supportedosgi.html" title="apache-felix-ipojo-supportedOSGi">Supported OSGi Implementations</A></LI>
   <LI><A href="http://ipojo-dark-side.blogspot.com/" class="external-link" rel="nofollow">iPOJO's Dark Side Blog</A></LI>
   <LI><A href="article-presentations.html" title="Article & Presentations">Article &amp; Presentations</A></LI>
   <LI><A href="http://www.apache.org/">ASF</A></LI>
   <LI><A href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</A></LI>
   <LI><A href="http://www.apache.org/foundation/thanks.html">Sponsors</A></LI>
</UL>
</LI><!-- End of misc -->
</UL> <!-- End of the menu -->
</DIV> <!-- Page header -->
</P>

<DIV class="content">

<H1><A name="iPOJOAdvancedTutorial-TheiPOJOSnackBar"></A>The iPOJO Snack Bar</H1>

<P><EM>This tutorial illustrates some advanced features of iPOJO</EM></P>

<DIV class="toc"><DIV>
<UL>
    <LI><A href="#iPOJOAdvancedTutorial-Context">Context</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Preparingthetutorial">Preparing the tutorial</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Writingacomponentprovidingtwoservices">Writing a component providing two services</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Publishingserviceproperties">Publishing service properties</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Publishing%2527dynamic%2527properties">Publishing 'dynamic' properties</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Configuringinstances">Configuring instances</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Usingfilterinservicerequirements">Using filter in service requirements</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Immediatecomponentinstance">Immediate component instance</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Creatinginstancesfromanexternalcomponenttype">Creating instances from an external component type</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Deployingtheapplication">Deploying the application</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Usingthelifecyclecontroller">Using the lifecycle controller</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Reconfiguringaninstance">Reconfiguring an instance</A></LI>
    <LI><A href="#iPOJOAdvancedTutorial-Conclusion">Conclusion</A></LI>
</UL></DIV></DIV>

<H2><A name="iPOJOAdvancedTutorial-Context"></A>Context</H2>
<P>This tutorial is based on a very simple application; customers are using a vendor service to buy hot dog or pop corn according to the availability of appropriate providers. Both of the vendors implement (and provide) the vendor service. The hot dog vendor depends on two others services to get the ingredients (buns and wiener). To sell pop corn, the pop corn vendor requires having enough corn in stock.<BR>
<SPAN class="image-wrap" style=""><IMG src="ipojo-advanced-tutorial.data/vendor.png" style="border: 0px solid black"></SPAN></P>
<H2><A name="iPOJOAdvancedTutorial-Preparingthetutorial"></A>Preparing the tutorial</H2>
<P>The tutorial archive is available <A href="http://people.apache.org/~clement/ipojo/tutorials/advanced/advanced.tutorial.zip" class="external-link" rel="nofollow">here</A>. This archive contains both the source code and a pre-configured version of Felix. First, unzip the archive. Then, launch <TT>ant</TT> to compile the bundles composing this tutorial. Once compiled, you can launch Felix and start the tutorial. To launch, Felix launch the following command from the <TT>felix</TT> directory:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
java -jar bin/felix.jar
</PRE>
</DIV></DIV>

<H2><A name="iPOJOAdvancedTutorial-Writingacomponentprovidingtwoservices"></A>Writing a component providing two services</H2>
<P>The sources of this project are inside the <EM>vendor.buns-and-wieners</EM> directory.<BR>
The hot dog vendor requires at the same time the bun service and the wiener service. In our application these services are provided by the same component. This component can be implemented as follows (src\org\apache\felix\ipojo\example\vendor\provider\BunWienerProvider.java):</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"> 
<SPAN class="code-keyword">public</SPAN> class BunWienerProvider <SPAN class="code-keyword">implements</SPAN> BunService, WienerService {
    
    <SPAN class="code-keyword">public</SPAN> void getBun() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Get a bun&quot;</SPAN>);
    }

    <SPAN class="code-keyword">public</SPAN> void getWiener() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Get a wiener&quot;</SPAN>);
    }
}
</PRE>
</DIV></DIV>
<P>This class just implements the two service interfaces. Its descriptor (contained in the metadata.xml file) is:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
    classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.provider.BunWienerProvider&quot;</SPAN> 
    name=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>In the descriptor, we declare a component type for this vendor which contains the implementation class. The &quot;classname&quot; attribute contains the qualified name of the component implementation. The &quot;name&quot; attribute is the component type name. It is only used to refer to this type.</P>

<P>The &quot;public=false&quot; attribute disables factory exposition. A component type publishing a factory provides a way to create instance of this type from outside this descriptor. In our case, we want to guarantee that only one instance (singleton) can be created, so we disable the factory mechanism.</P>

<P>iPOJO manages service publication and providing automatically at runtime. The &quot;&lt;provides/&gt;&quot; element means that the component provides services. If this element is not present, iPOJO will publish all implemented interfaces by the implementation class (and parent class too). In our case, it will publish the BunService and WienerService interfaces.</P>

<P>Finally, we create one instance of our component. The instance contains the component attribute describing the component type to use. We use the component type name to target the wanted component type. </P>

<P>At runtime, the bundle containing this component will create an instance which provides the BunService and the WienerService.</P>


<H2><A name="iPOJOAdvancedTutorial-Publishingserviceproperties"></A>Publishing service properties</H2>
<P>The sources of this project are inside the <EM>vendor.hotdog</EM> directory.<BR>
The hot dog vendor only provides the Vendor service. To provide this service, it uses a bun service and a wiener service. The following code (contained in the <EM>src/org/apache/felix/ipojo/example/vendor/hotdog/HotDogVendor.java</EM> file) shows a very simple implementation of this component:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class HotDogVendor <SPAN class="code-keyword">implements</SPAN> Vendor {
    
    /**
     * Bun provider (required service).
     */
    <SPAN class="code-keyword">private</SPAN> Bun bunProvider;
    
    /**
     * Wiener provider (required service). 
     */
    <SPAN class="code-keyword">private</SPAN> Wiener wienerProvider;
    
    /**
     * Sell method.
     * To provide an hotdog, the vendor consume a bun and a wiener.
     * This method is <SPAN class="code-keyword">synchronized</SPAN> to avoid serving to client 
     * at the same time.
     * @<SPAN class="code-keyword">return</SPAN> a hotdog.
     * @see org.apache.felix.ipojo.example.vendor.service.Vendor#sell()
     */
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">synchronized</SPAN> Product sell() {
        bunProvider.getBun();
        wienerProvider.getWiener();
        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">new</SPAN> HotDog();
    }
</PRE>
</DIV></DIV>

<P>Once implemented, we need to describe this component type. The descriptor file is the <EM>metadata.xml</EM> file. The field attributes in the &quot;requires&quot; elements are used to inject the required services. At runtime, iPOJO injects automatically a BunService provider in the &quot;bunProvider&quot; field and a WienerService provider in the &quot;wienerProvider&quot; field. The implementation uses these fields the same way it would have used any other fields (as illustrated in the sell method).</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
   classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.hotdog.HotDogVendor&quot;</SPAN>
   name=<SPAN class="code-quote">&quot;HD&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides/&gt;</SPAN>
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;bunProvider&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;wienerProvider&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;HD&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The component type declares a provided service (the Vendor Service). Then, the component declares the two service dependencies (using the &quot;requires&quot; element). However, we would like to add a service property on the Vendor service describing the sold product (here, &quot;hotdog&quot;). To achieve this, we just need to add a property element in the &quot;provides&quot; tags: </P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
   classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.hotdog.HotDogVendor&quot;</SPAN> 
   name=<SPAN class="code-quote">&quot;HD&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;product&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> value=<SPAN class="code-quote">&quot;hotdog&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/provides&gt;</SPAN>
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;bunProvider&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;wienerProvider&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;HD&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>iPOJO then publishes the &quot;product&quot; property in the &quot;vendor&quot; service registration. This property has the &quot;hotdog&quot; value.</P>

<H2><A name="iPOJOAdvancedTutorial-Publishing%27dynamic%27properties"></A>Publishing 'dynamic' properties</H2>

<P>The bun service and the wiener service can also expose service properties. In our case, these service properties will describe the stock of ingredients. Each time the service is used, the property value is decreased.<BR>
To achieve this, we modify the current implementation to add a field representing the property:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class BunWienerProvider <SPAN class="code-keyword">implements</SPAN> BunService, WienerService {
    
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">int</SPAN> bunStock;
    
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">int</SPAN> wienerStock;

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">synchronized</SPAN> void getBun() {
        bunStock = bunStock - 1;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">synchronized</SPAN> void getWiener() {
        wienerStock = wienerStock - 1;
    }
}
</PRE>
</DIV></DIV>

<P>The stock accesses are synchronized to avoid multiple accesses at the same time. The component type metadata must also be modified in order to describe this property:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
   classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.provider.BunProvider&quot;</SPAN> 
   name=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;buns&quot;</SPAN> field=<SPAN class="code-quote">&quot;bunStock&quot;</SPAN> value=<SPAN class="code-quote">&quot;10&quot;</SPAN>/&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;wieners&quot;</SPAN> field=<SPAN class="code-quote">&quot;wienerStock&quot;</SPAN> value=<SPAN class="code-quote">&quot;10&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/provides&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>In the &quot;provides&quot; element, two properties are added. This property contains a &quot;field&quot; attribute aiming to attach the service property with a field of the implementation class. Then a default value is given. In the code, the property fields will obtain the initial value (10). Then each time the fields are modified, the service property is updated (as well as the OSGi&trade; service registration). Notice that iPOJO support method injection for property too. In this case, a getter method is called to inject the property value.</P>

<H2><A name="iPOJOAdvancedTutorial-Configuringinstances"></A>Configuring instances</H2>

<P>In the previous example, the properties were configured in the component type description. It is also possible to customize any property value in the instance declaration. This way, each instance can obtain different values.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
   classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.provider.BunProvider&quot;</SPAN>
   name=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;buns&quot;</SPAN> field=<SPAN class="code-quote">&quot;bunStock&quot;</SPAN> value=<SPAN class="code-quote">&quot;10&quot;</SPAN>/&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;wieners&quot;</SPAN> field=<SPAN class="code-quote">&quot;wienerStock&quot;</SPAN> value=<SPAN class="code-quote">&quot;10&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/provides&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;buns_and_wieners&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;buns&quot;</SPAN> value=<SPAN class="code-quote">&quot;9&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;wieners&quot;</SPAN> value=<SPAN class="code-quote">&quot;8&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The previous metadata shows how to push a configuration in instance declarations. The instance declaration contains two property elements containing the name of the value of the property. Instance configuration override component type initial value. Properties are optional by default ; that's means that they do not need to receive a value. In this case, default values are the same as the Java default fields values (boolean : false, int : 0, double : 0.0d, ...). You can specify that a property must receive a default value from either the component type description or the instance configuration by setting the <TT>mandatory</TT> attribute to 'true'. </P>


<H2><A name="iPOJOAdvancedTutorial-Usingfilterinservicerequirements"></A>Using filter in service requirements</H2>

<P>Now that bun and wiener providers publish their remaining stock, the hot dog provider can look for a bun service and a wiener service with a non empty stock. To achieve this, we must describe an LDAP filter in the service requirement description. The following XML snipped shows this metadata:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
   classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.hotdog.HotDogVendor&quot;</SPAN>
   name=<SPAN class="code-quote">&quot;HD&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;product&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> value=<SPAN class="code-quote">&quot;hotdog&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/provides&gt;</SPAN>
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;bunProvider&quot;</SPAN> filter=<SPAN class="code-quote">&quot;(buns&gt;</SPAN>=1)&quot;</SPAN>/&gt;
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;wienerProvider&quot;</SPAN> filter=<SPAN class="code-quote">&quot;(wieners&gt;</SPAN>=1)&quot;</SPAN>/&gt;
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;HD&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>When a provider does no more matches with the LDAP filter, the provider is no more used, and another (matching with the filter) is tracked. If no provider fulfilling the constraint is found, the instance becomes invalid and waits a matching provider.</P>


<DIV class="box">
	<DIV class="box-blue-header">
	<DIV class="box-blue-title">
		<IMG src="http://people.apache.org/~clement/ipojo/site/information.gif"> <B>Instance invalidation and services</B>
	</DIV>
	</DIV>
	<DIV class="box-blue-content">
When an instance becomes invalid, all its provided services are withdrawn from the service registry. So, this instance is no more _accessible_ from the service registry.
	</DIV>
	<DIV class="box-blue-footer"></DIV>
</DIV>


<H2><A name="iPOJOAdvancedTutorial-Immediatecomponentinstance"></A>Immediate component instance</H2>

<P>Now that we get the hot dog provider, we are going to implement customers. Customers are implemented in the <EM>vendor.customer</EM> project). A customer simply looks for a vendor service and buys a product:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class Customer {
    
    <SPAN class="code-keyword">private</SPAN> VendorService vendor;
    
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> name;
    
    <SPAN class="code-keyword">public</SPAN> Customer() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Customer &quot;</SPAN> + name + <SPAN class="code-quote">&quot; bought &quot;</SPAN> 
           +  vendor.sell() + <SPAN class="code-quote">&quot; from &quot;</SPAN> + vendor.getName());
    }
</PRE>
</DIV></DIV>

<P>The previous code shows a possible implementation of a customer. However, the &quot;sell&quot; method is called in a constructor, and the constructor can only be called only if an object of the class is created. With iPOJO there are two different way to &quot;activate&quot; an instance as soon as it becomes valid. <BR>
The first one uses the lifecycle callback (described in the previous tutorial).  The second one is by declaring the component as an immediate component. An immediate component instance creates an object of its implementation as soon as it becomes valid. </P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
    classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.customer.Customer&quot;</SPAN> 
    name=<SPAN class="code-quote">&quot;customer&quot;</SPAN> immediate=<SPAN class="code-quote">&quot;true&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;requires field=<SPAN class="code-quote">&quot;vendor&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;properties&gt;</SPAN>
		<SPAN class="code-tag">&lt;property field=<SPAN class="code-quote">&quot;name&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/properties&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>To declare a component immediate, just add &quot;immediate=true&quot; in the component descriptor. Then as soon as the vendor service is available, the object is created. Moreover, this type declares a property (to give a name to the customers). This property is not a service property, but just an internal property. As for service properties, the name field will be injected by a value necessary given during the instance creation (i.e. contained inside the instance configuration).</P>

<P>By default, all all components that do not provide any service are immediate. Other components create call their constructors when they are used for the first time. </P>


<DIV class="box">
	<DIV class="box-blue-header">
	<DIV class="box-blue-title">
		<IMG src="http://people.apache.org/~clement/ipojo/site/information.gif"> <B>Difference between 'validate' and 'immediate'</B>
	</DIV>
	</DIV>
	<DIV class="box-blue-content">
There is a difference between immediate components and components with a 'validate' lifecycle callback. Indeed, the callback is call at each time the instance becomes valid and calls the constructor only if no object already exists. On the other side, the immediate component's constructor is call only once.
        </DIV>
	<DIV class="box-blue-footer"></DIV>
</DIV>


<H2><A name="iPOJOAdvancedTutorial-Creatinginstancesfromanexternalcomponenttype"></A>Creating instances from an external component type</H2>

<P>In the previous section we have declared a customer component type, which does not have the &quot;public=false&quot; attribute. This feature allows separate deployment from instance creation. Moreover, we didn't declare instances in the descriptor. <BR>
Another metadata file can be used to declare instances from the customer type, this descriptor being contained in another bundle. The following descriptor creates 10 customer instances (look at the <EM>vendor.customer.creator\metadata.xml</EM> file):</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-1&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-2&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-3&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-4&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-5&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-6&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-7&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-8&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-9&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;customer&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;name&quot;</SPAN> value=<SPAN class="code-quote">&quot;customer-10&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>Once deployed, this bundle looks for the required factory. If it's not available the bundle waits for the factory. As soon as the required factory is available, all instances are created. When this bundle is stopped, all instances are destroyed. </P>
<H2><A name="iPOJOAdvancedTutorial-Deployingtheapplication"></A>Deploying the application</H2>
<P>Compile the bundles, by launching ant at the root of the tutorial. Then launch Felix is indicated above. <BR>
Once started, launch the following commands </P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-none">
start file:../vendor.services/output/vendor.services.jar
start file:../vendor.buns-and-wieners/output/vendor.buns-and-wieners.jar
start file:../vendor.hotdog/output/vendor.hotdog.jar
start file:../vendor.customer/output/vendor.customer.jar
start file:../vendor.customer.creator/output/vendor.customer.creator.jar
</PRE>
</DIV></DIV>
<P>Something like this should appear:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-none">
Customer customer-1 bought Hotdog from Fenway Park
Customer customer-2 bought Hotdog from Fenway Park
Customer customer-3 bought Hotdog from Fenway Park
Customer customer-4 bought Hotdog from Fenway Park
Customer customer-5 bought Hotdog from Fenway Park
Customer customer-6 bought Hotdog from Fenway Park
Customer customer-7 bought Hotdog from Fenway Park
Customer customer-8 bought Hotdog from Fenway Park
</PRE>
</DIV></DIV>
<P>Only 8 customers can buy a hot-dog, as the stock of wieners and buns can't supply more hot-dog. The remainder of this tutorial will try to solve the problem of these two hungry customers.</P>
<H2><A name="iPOJOAdvancedTutorial-Usingthelifecyclecontroller"></A>Using the lifecycle controller</H2>
<P>Sometimes you want to invalidate your instance in the code (for example: to unregister a service). That's possible with the lifecycle controller handler.<BR>
Let's take the popcorn vendor with a corn stock from the <EM>vendor.popcorn</EM> project. Each time it sells some popcorn, its stock is decreased. When the stock reaches 0, it cannot sell popcorns any more (so the vendor service needs to be withdrawn).</P>

<P>The following implementation (<EM>src\org\apache\felix\ipojo\example\vendor\popcorn\PopCornVendor.java</EM>) uses a field to control the lifecycle.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
/**
     * The corn stock.
     */
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">int</SPAN> m_corn_stock;
    
    /**
     * Lifecycle controller.
     * If set to <SPAN class="code-keyword">false</SPAN>, the instance becomes invalid. 
     */
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">boolean</SPAN> m_can_sell = <SPAN class="code-keyword">true</SPAN>;

    /**
     * The sell method.
     * To provide popcorn, the vendor needs to decrease its corn stock level.
     * This method is <SPAN class="code-keyword">synchronized</SPAN> to avoid to client being serve at 
     * the same time. 
     * @<SPAN class="code-keyword">return</SPAN>
     * @see org.apache.felix.ipojo.example.vendor.service.Vendor#sell()
     */




    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">synchronized</SPAN> Product sell() {
        m_corn_stock--;
        <SPAN class="code-keyword">if</SPAN> (m_corn_stock == 0 &amp;&amp; m_can_sell) { <SPAN class="code-comment">// Last pop corn
</SPAN>            m_can_sell = <SPAN class="code-keyword">false</SPAN>;
            <SPAN class="code-object">System</SPAN>.out.println(&quot;Stop selling popcorn 
                  ... Run out of stock&quot;);
            <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">new</SPAN> PopCorn();
        } <SPAN class="code-keyword">else</SPAN> <SPAN class="code-keyword">if</SPAN> (m_corn_stock &gt; 0) { <SPAN class="code-comment">// Normal <SPAN class="code-keyword">case</SPAN>
</SPAN>            <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">new</SPAN> PopCorn();
        } <SPAN class="code-keyword">else</SPAN> { <SPAN class="code-comment">// Cannot serve.
</SPAN>            <SPAN class="code-keyword">return</SPAN> PopCorn.NO_MORE_POPCORN;
        }
    }
</PRE>
</DIV></DIV>

<P>Once the field is set to &quot;false&quot;, the instance is invalidated (the vendor service is no more available). To configure the controller, you can use the following metadata:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
    classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.popcorn.PopCornVendor&quot;</SPAN>
    name=<SPAN class="code-quote">&quot;popcorn&quot;</SPAN> public=<SPAN class="code-quote">&quot;false&quot;</SPAN> architecture=<SPAN class="code-quote">&quot;true&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides/&gt;</SPAN>
	<SPAN class="code-tag">&lt;controller field=<SPAN class="code-quote">&quot;m_can_sell&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;popcorn&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>The instance can be re-validated by setting the field to true.<BR>
So, no deploy the pop corn vendor.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-none">
-&gt; start file:../vendor.popcorn/output/vendor.popcorn.jar
Customer customer-10 bought popcorn from D &amp; P
Customer customer-9 bought popcorn from D &amp; P
</PRE>
</DIV></DIV>
<P>Our two last customers are no more hungry. However, new customers arrives, we have the following situation:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-none">
-&gt; update 10
Customer customer-1 bought popcorn from D &amp; P
Customer customer-2 bought popcorn from D &amp; P
Stop selling popcorn ... Run out of stock
Customer customer-3 bought popcorn from D &amp; P
</PRE>
</DIV></DIV>
<P>To recreate new customers, just update the customer.creator bundle (bundle 10). So, now we have 7 customers hungry! There is neither popcorn nor hotdog!</P>
<H2><A name="iPOJOAdvancedTutorial-Reconfiguringaninstance"></A>Reconfiguring an instance</H2>
<P>OSGi specified the Configuration Admin mechanism aiming to handler service and bundle configuration. This section will describe how you can use the Configuration Admin and iPOJO to add corn inside our popcorn vendor.<BR>
First, we will change the pop corn vendor to add a method reinjecting the new stock:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
/**
     * A transporter refills the stock of corn.
     * This method is <SPAN class="code-keyword">synchronized</SPAN> to avoid to client being served 
     * during the update.
     * @param newStock : the stock of corn to add to the current stock.
     */
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">synchronized</SPAN> void refillStock(<SPAN class="code-object">int</SPAN> newStock) {
        m_corn_stock += newStock;
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Refill the stock : &quot;</SPAN> + m_corn_stock);
        <SPAN class="code-keyword">if</SPAN> (m_corn_stock &gt; 0) {
            m_can_sell = <SPAN class="code-keyword">true</SPAN>;
        }
    }
</PRE>
</DIV></DIV>
<P>Once added, we need to update the component type descriptor to use this method:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ipojo&gt;</SPAN>
&lt;component 
    classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.example.vendor.popcorn.PopCornVendor&quot;</SPAN> 
    name=<SPAN class="code-quote">&quot;popcorn&quot;</SPAN> architecture=<SPAN class="code-quote">&quot;true&quot;</SPAN>&gt;
	<SPAN class="code-tag">&lt;provides/&gt;</SPAN>
	<SPAN class="code-tag">&lt;controller field=<SPAN class="code-quote">&quot;m_can_sell&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;properties&gt;</SPAN>
		<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;stock&quot;</SPAN> method=<SPAN class="code-quote">&quot;refillStock&quot;</SPAN> value=<SPAN class="code-quote">&quot;5&quot;</SPAN>/&gt;</SPAN>
	<SPAN class="code-tag">&lt;/properties&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>

<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;popcorn&quot;</SPAN> name=<SPAN class="code-quote">&quot;SuperPopCorn&quot;</SPAN>&gt;</SPAN>
	<SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;managed.service.pid&quot;</SPAN> value=<SPAN class="code-quote">&quot;Super.PopCorn.Stock&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
<SPAN class="code-tag">&lt;/ipojo&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>We add two different things. First we add a &quot;stock&quot; property attached to the <EM>refillStock</EM> method. When this instance is configured or reconfigured, this method is called to push the new stock value. Then we add the <EM>managed.service.pid</EM> property inside the instance creation. This property will be used by the Configuration Admin to attach configuration to instances. The property value must be unique.<BR>
So now, our popcorn vendor can be reconfigured dynamically to get increments its corn stock.<BR>
However, we need to create something refilling the stock ... a corn transporter !<BR>
Inside the <EM>vendor.corn.transporter</EM> project, we have a component dealing with the ConfigurationAdmin to push the new pop corn vendor configuration.<BR>
The implementation is contained in the <EM>src\org\apache\felix\ipojo\example\vendor\corn\transporter\CornTransporter.java</EM> file.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class CornTransporter {
    
    <SPAN class="code-keyword">private</SPAN> ConfigurationAdmin m_configAdmin;
    
    
    /**
     * Reconfigure the popcorn vendor with the configuration admin. 
     */
    <SPAN class="code-keyword">public</SPAN> void refillStock() {
        <SPAN class="code-keyword">try</SPAN> {
            <SPAN class="code-comment">// Retrieve or Create the instance configuration
</SPAN>            <SPAN class="code-comment">// from the configuration admin
</SPAN>            Configuration configuration = 
                 m_configAdmin.getConfiguration(<SPAN class="code-quote">&quot;Super.PopCorn.Stock&quot;</SPAN>, 
                 <SPAN class="code-quote">&quot;file:../vendor.popcorn/output/vendor.popcorn.jar&quot;</SPAN>);
            configuration.setBundleLocation(
                 <SPAN class="code-quote">&quot;file:../vendor.popcorn/output/vendor.popcorn.jar&quot;</SPAN>);
            Properties props = <SPAN class="code-keyword">new</SPAN> Properties();
            props.put(<SPAN class="code-quote">&quot;stock&quot;</SPAN>, <SPAN class="code-keyword">new</SPAN> <SPAN class="code-object">Integer</SPAN>(15)); <SPAN class="code-comment">// Delivered corn
</SPAN>            configuration.update(props);
            <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Update the configuration of &quot;</SPAN> 
                  + configuration.getPid() + <SPAN class="code-quote">&quot;(&quot;</SPAN> 
                  + configuration.getBundleLocation() + <SPAN class="code-quote">&quot;)&quot;</SPAN>);
            configuration.delete();
        } <SPAN class="code-keyword">catch</SPAN> (IOException e) {
            e.printStackTrace();
        }
    }
}
</PRE>
</DIV></DIV>
<P>Create a new configuration from the configuration admin and configure this configuration to add corn. Then, we update this configuration. This will reconfigured our popcorn vendor. More information on the Configuration Admin is available in the OSGi R4 Compendium.<BR>
So, now if we deploy this bundle, we will provide enough corn to feed all the customers:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-none">
-&gt; start file:../vendor.corn.transporter/output/vendor.corn.transporter.jar
Update configuration of Super.PopCorn.Stock(
       file:../vendor.popcorn/output/vendor.popcorn.jar)
Refill the stock : 5
Customer customer-10 bought popcorn from D &amp; P
Customer customer-9 bought popcorn from D &amp; P
Customer customer-8 bought popcorn from D &amp; P
Customer customer-7 bought popcorn from D &amp; P
Customer customer-6 bought popcorn from D &amp; P
Customer customer-5 bought popcorn from D &amp; P
Customer customer-4 bought popcorn from D &amp; P
</PRE>
</DIV></DIV>
<P>That's it!</P>

<H2><A name="iPOJOAdvancedTutorial-Conclusion"></A>Conclusion</H2>
<P>This small tutorial has presented some of of the iPOJO features. Subscribe to the Felix users mailing list by sending a message to <A href="mailto:users-subscribe@felix.apache.org" class="external-link" rel="nofollow">users-subscribe@felix.apache.org</A>; after subscribing, email questions or feedback to <A href="mailto:users@felix.apache.org" class="external-link" rel="nofollow">users@felix.apache.org</A>.
<BR class="atl-forced-newline">
<BR class="atl-forced-newline"></P>

 </DIV>
        <IMG src="http://felix.apache.org/ipojo/site/footer.png" class="footer">
</DIV>

<SCRIPT type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</SCRIPT>
<SCRIPT type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-1518442-4");
pageTracker._trackPageview();
} catch(err) {}
</SCRIPT>

        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by clement.escoffier on 2010-04-30 03:20:13.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
