
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - UPnP Writing CD and CP</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<H1><A name="UPnPWritingCDandCP-WritingUPnPDevicesandControlPoints"></A>Writing UPnP Devices and Control Points</H1>

<P>The <A href="http://www.osgi.org/Specifications/HomePage" class="external-link" rel="nofollow">OSGi UPnP Specification (v 1.1)</A> dedicates section 111.6 &quot;Working with a UPnP Device&quot; to describe the details of implementing UPnP Devices on OSGi. Here we provide some hints on the main differences you may encounter working with OSGi with respect to the <A href="http://www.upnp.org/resources/documents/CleanUPnPDA101-20031202s.pdf" class="external-link" rel="nofollow">UDA 1.0 Specification</A> .</P>

<P>The first peculiarity is that OSGi provides a centralized register for discovering of UPnP devices as opposed to the distributed mechanism of the UPnP protocol stack. Thus, while in the UPnP networks the steps for subscribing the services of some device are typically 1) <B>discover</B> the required device and 2) <B>subscribe</B> the service, within the OSGi platform a Control Point may register an interest in receiving notify events even before the device is really plugged on the network. This is possible because the subscription mechanism is based on the <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPEventListener.html" class="external-link" rel="nofollow">UPnPEventListener</A>interface that is used for registering OSGi services, which ultimately handles the notify messages sent by the producers of the events. The base driver (importer) keeps track of such UPnPEventListener services and as soon as a matching service is discovered on the UPnP network, a subscription is made on behalf of the registered listeners.</P>

<P>On the other hand, even if it is enough to register a service implementing the <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPDevice.html" class="external-link" rel="nofollow">UPnPDevice</A>interface to expose it as UPnP devices on the network, the developers have to implement on their own the event management required by the UPnP technology. From this point of view, for each evented state variable declared by the UPnP device, the developers have to monitor UPnPEventListenerservices that is error prone[1]. The correct implementation of the UPnP eventing phase is left entirely to developers. In particular, in UDA 1.0, the first time a Control Point subscribes a service, the current value of its state variables should soon be delivered to it. To manage this situation in a standard way, the last OSGi UPnP specification defined the extended interface <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPLocalStateVariable.html" class="external-link" rel="nofollow">UPnPLocalStateVariable</A>. In fact, the previous basic interface UPnPStateVariable provided only a descriptive interface which did not enable to get the value of a state variable without knowing the final implementation class. Every developer should use this new interface in order to allow the specification of helper classes that ease the subscription/notify management (see <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/extra/src/main/java/org/apache/felix/upnp/extra/util/UPnPSubscriber.java?view=markup" class="external-link" rel="nofollow">UPnPEventNotifier</A> below).</P>

<P>We have factorized and released part of the code used by the UPnP examples with the <EM>org.apache.felix.upnp.extra</EM> bundle.</P>

<H2><A name="UPnPWritingCDandCP-TheExtrabundleandthedriverinterfaces"></A>The Extra bundle and the driver interfaces</H2>

<P>We provide some utility classes and services through the extra bundle and the services registered by the UPnP Base Driver.</P>

<P>In the Extra bundle the class <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/extra/src/main/java/org/apache/felix/upnp/extra/util/UPnPSubscriber.java?view=markup" class="external-link" rel="nofollow">org.apache.felix.upnp.extra.util.UPnPSubscriber</A> can be instantiated to subscribe one or more services. The constructor takes two parameters a <A href="http://www.osgi.org/javadoc/r4/org/osgi/framework/BundleContext.html" class="external-link" rel="nofollow">BundleContext </A> reference and a <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPEventListener.html" class="external-link" rel="nofollow">UPnPEventListener </A> reference. In this class the method subscribe(Filter aFilter) is a general and powerful way to subscribe to any service by using an <A href="http://www.osgi.org/javadoc/r4/org/osgi/framework/Filter.html" class="external-link" rel="nofollow">LDAP filter</A>. For example by using the string :</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-quote">&quot;(&amp; (UPnP.device.type=urn:schemas-upnp-org:device:BinaryLight:1) (UPnP.service.type= urn:schemas-upnp-org:service:SwitchPower:1))&quot;</SPAN>
</PRE>
</DIV></DIV>
<P>we would subscribe to the SwitchPower service offered by any device implementing the BinaryLight profile. Looking at the Felix UPnP TV sample code, the UPnPSubscriber class is used in the file <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/samples/tv/src/main/java/org/apache/felix/upnp/sample/tv/TvDevice.java?view=markup" class="external-link" rel="nofollow">org.apache.felix.upnp.sample.tv.TVDevice</A> to subscribe to the different service types offered by the Cyberlink sample devices. However, in this case, the utility method <FONT color="black"><B>subscribeEveryServiceType</B></FONT> is used to provide just the device and service types.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> CLOCK_DEVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:device:clock:1&quot;</SPAN>;
<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> TIME_SERVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:service:timer:1&quot;</SPAN>;

<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> LIGHT_DEVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:device:light:1&quot;</SPAN>;
<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> POWER_SERVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:service:power:1&quot;</SPAN>;

<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> AIRCON_DEVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:device:aircon:1&quot;</SPAN>;
<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> TEMP_SERVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:service:temp:1&quot;</SPAN>;

<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> WASHER_DEVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:device:washer:1&quot;</SPAN>;
<SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> STATUS_SERVICE_TYPE = <SPAN class="code-quote">&quot;urn:schemas-upnp-org:service:state:1&quot;</SPAN>;

<SPAN class="code-keyword">public</SPAN> void doSubscribe() {
  subscriber = <SPAN class="code-keyword">new</SPAN> UPnPSubscriber(Activator.context, <SPAN class="code-keyword">this</SPAN>);
  subscriber.subscribeEveryServiceType(CLOCK_DEVICE_TYPE, TIME_SERVICE_TYPE);
  subscriber.subscribeEveryServiceType(AIRCON_DEVICE_TYPE, TEMP_SERVICE_TYPE);
  subscriber.subscribeEveryServiceType(LIGHT_DEVICE_TYPE, POWER_SERVICE_TYPE);
  subscriber.subscribeEveryServiceType(WASHER_DEVICE_TYPE, STATUS_SERVICE_TYPE);
}

<SPAN class="code-keyword">public</SPAN> void undoSubscribe(){
       subscriber.unsubscribeAll();}
</PRE>
</DIV></DIV>
<P>The class <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/extra/src/main/java/org/apache/felix/upnp/extra/util/UPnPEventNotifier.java?view=markup" class="external-link" rel="nofollow">org.apache.felix.upnp.extra.util.UPnPEventNotifier</A> is a utility class that manages the delivery of notifications for you. There are two constructors. The first one takes a <A href="http://www.osgi.org/javadoc/r4/org/osgi/framework/BundleContext.html" class="external-link" rel="nofollow">BundleContext</A>, a <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPDevice.html" class="external-link" rel="nofollow">UPnPDevice</A> , and a <A href="http://www.osgi.org/javadoc/r4/org/osgi/service/upnp/UPnPService.html" class="external-link" rel="nofollow">UPnPService </A> reference. They are internally used to keep trace of all the registered UPnPEvenListener that are interested in monitoring events generated by your UPnP service. UPnPEventNotifier implements the java beans <A href="http://java.sun.com/j2se/1.4.2/docs/api/java/beans/PropertyChangeListener.html" class="external-link" rel="nofollow">PropertyChangeListener </A> interface; once changes of the service state variables occurs you should call the method propertyChange(PropertyChangeEvent evt). Alternatively, you may use the second constructor to pass a reference to a model implementing the interface: <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/extra/src/main/java/org/apache/felix/upnp/extra/util/EventSource.java?view=markup" class="external-link" rel="nofollow">EventSource </A> defined in the Extra bundle. This model should use the <A href="http://java.sun.com/j2se/1.4.2/docs/api/java/beans/PropertyChangeSupport.html" class="external-link" rel="nofollow">PropertyChangeSupport </A> to keep trace of PropertyChangeListener, <FONT color="">and the related method firePropertyChange</FONT> to notify changes. The <FONT color="black">EventSource</FONT> interface is used internally by the UPnPEventNotifier to register itself as propertychangeListener of the model. Thus, in this case, you don't have to call propertyChange()directly: it is a duty of your model. As an example, take a look at <A href="http://svn.apache.org/viewvc/felix/trunk/upnp/samples/binarylight/src/main/java/org/apache/felix/upnp/sample/binaryLight/LightModel.java?view=markup" class="external-link" rel="nofollow">LightModel </A> class in the BinaryLight bundle<FONT color="black">.</FONT></P>

<P>The Felix UPnP base driver registers a non standard service implementing two interfaces:</P>

<P><A href="http://svn.apache.org/viewvc/felix/trunk/upnp/basedriver/src/main/java/org/apache/felix/upnp/basedriver/controller/DevicesInfo.java?view=markup" class="external-link" rel="nofollow">org.apache.felix.upnp.basedriver.controller.DevicesInfo</A>;<BR>
<A href="http://svn.apache.org/viewvc/felix/trunk/upnp/basedriver/src/main/java/org/apache/felix/upnp/basedriver/controller/DriverController.java?view=markup" class="external-link" rel="nofollow">org.apache.felix.upnp.basedriver.controller.DriverController</A>;</P>

<P>The former can be used to retrieve the XML description of both devices and services. Other than be used for debugging purpose, it allows access to the UPnP schema extensions defined by UPnP Vendors. According to the UDA 1.0 they consist of elements inserted in different points of the XML description and by convention starting with the prefix &quot;X_&quot;. This interface is used by the context menu handler of the UPnP Tester bundle.</P>

<P>The latter interface can be used to change the log messages of the base driver at runtime. Two different methods are available to modify the log level of the base driver or to enable the visualization of low level messages related to the UPnP stack protocol (CyberDomo). Furthermore, the interface allows developers to send an M-SEARCH discovery message to the UPnP networks, thus refreshing the list of imported devices.</P>


<H5><A name="UPnPWritingCDandCP-TheFelixUPnPExamplesUPnPExamples%3C%3C%5C%3E%3EKnownIssuesUPnPKnownIssues"></A><A href="upnp-examples.html" title="UPnP Examples">The Felix UPnP Examples</A> &lt;&lt; &#124; &gt;&gt; <A href="upnp-known-issues.html" title="UPnP Known Issues">Known Issues</A></H5>
<HR>
<P>[1] Developers should monitor UPnpEventListener services with a filter matching either the own service Id or service type, either the own device Id or device type and even a empty filter which are usually used to express interest for every UPnP device.</P>
        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by francesco.furfari@isti.cnr.it on 2008-04-21 08:06:23.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
