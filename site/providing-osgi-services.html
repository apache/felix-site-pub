
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - Providing OSGi services</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/superfish.css);
</STYLE>

<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/style.css);
</STYLE>

<P>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shCore.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushCSharp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPhp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJScript.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushVb.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushSql.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushXml.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushShell.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushDelphi.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPython.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJava.js"></SCRIPT>

<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/jquery-1.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/hoverIntent.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/superfish.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/supersubs.js"></SCRIPT>

<SCRIPT type="text/javascript">

    $(document).ready(function(){
        $("ul.sf-menu").supersubs({
            minWidth:    14,   // minimum width of sub-menus in em units
            maxWidth:    30,   // maximum width of sub-menus in em units
            extraWidth:  1     // extra width can ensure lines don't sometimes turn over
                               // due to slight rounding differences and font-family
        }).superfish();  // call supersubs first, then superfish, so that subs are
                         // not display:none when measuring. Call before initialising
                         // containing tabs for same reason.
    });

</SCRIPT>
<DIV class="main">
<DIV class="page-header">
<IMG src="http://felix.apache.org/ipojo/site/header.png" class="header">
<A href="http://ipojo.org/"><IMG src="http://felix.apache.org/ipojo/site/ipojo.png" width="225" class="header-logo"></A>
<UL class="sf-menu sf-js-enabled sf-shadow" id="ipojo-menu">
<LI class="current">
<!-- Menu Overview -->
<A href="" class="sf-with-ul">Overview<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
	<LI>
	<A href="apache-felix-ipojo.html" title="Apache Felix iPOJO">Home</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-why-choose-ipojo.html" title="apache-felix-ipojo-why-choose-ipojo">Why choose iPOJO</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-successstories.html" title="apache-felix-ipojo-successstories">Success stories</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-feature-overview.html" title="Apache Felix iPOJO Feature Overview">Features</A>
	</LI>
</UL>
</LI>

<LI class="">
<!-- Menu download -->
<LI>
<A href="download.html" title="Download">Download </A>
</LI>

<LI class="">
<!-- Menu Documentation -->
<A href="" class="sf-with-ul">Documentation<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
    <!-- sub- menu : getting started -->
    <LI class="">
    <A href="" class="sf-with-ul">Getting Started<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
    <UL>
     <LI><A href="ipojo-in-10-minutes.html" title="iPOJO in 10 minutes">iPOJO in 10 minutes</A></LI>
     <LI><A href="how-to-use-ipojo-annotations.html" title="How to use iPOJO Annotations">Using Annotations</A></LI>
     <LI><A href="ipojo-hello-word-maven-based-tutorial.html" title="iPOJO Hello Word (Maven-Based) tutorial">Maven tutorial</A></LI>
     <LI><A href="ipojo-advanced-tutorial.html" title="iPOJO Advanced Tutorial">Advanced tutorial</A></LI>
     <LI><A href="apache-felix-ipojo-dosgi.html" title="apache-felix-ipojo-dosgi">Using Distributed OSGi</A></LI>
     <LI><A href="ipojo-composition-tutorial.html" title="iPOJO Composition Tutorial">Application Composition</A></LI>
    </UL>
    </LI> <!-- end of getting started -->
    <!-- sub menu : Describing Components -->
     <LI class="">
        <A href="http://felix.apache.org/site/describing-components.html" class="sf-with-ul">Describing components<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="service-requirement-handler.html" title="Service Requirement Handler">Requiring a service</A></LI>
        <LI><A href="" title="Providing OSGi services">Providing a service</A></LI>
        <LI><A href="lifecycle-callback-handler.html" title="Lifecycle Callback Handler">Lifecycle management</A></LI>
        <LI><A href="configuration-handler.html" title="Configuration Handler">Configuration</A></LI>
        <LI><A href="architecture-handler.html" title="Architecture Handler">Introspection</A></LI>
        <LI><A href="controller-lifecycle-handler.html" title="Controller Lifecycle Handler">Impacting the lifecycle</A></LI>
        <LI><A href="event-admin-handlers.html" title="Event Admin Handlers">Asynchronous communication</A></LI>
        <LI><A href="ipojo-jmx-handler.html" title="iPOJO JMX Handler">JMX management</A></LI>
        <LI><A href="extender-pattern-handler.html" title="Extender Pattern Handler">Extender pattern</A></LI>
        <LI><A href="white-board-pattern-handler.html" title="White Board Pattern Handler">Whiteboard pattern</A></LI>
        <LI><A href="temporal-service-dependency.html" title="Temporal Service Dependency">Temporal dependencies</A></LI>
        </UL>
     </LI> <!-- End of describing components -->
    <!-- sub- menu : User Guide -->
    <LI class="">
    <A href="" class="sf-with-ul">User Guide<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="combining-ipojo-and-configuration-admin.html" title="Combining iPOJO and Configuration Admin">iPOJO and config admin</A></LI>
        <LI><A href="how-to-use-ipojo-factories.html" title="How-to use iPOJO factories">Factories and Instances</A></LI>
        <LI><A href="using-xml-schemas.html" title="Using XML Schemas">XML Schemas</A></LI>
        <LI><A href="apache-felix-ipojo-api.html" title="apache-felix-ipojo-api">API</A></LI>
        <LI><A href="apache-felix-ipojo-testing-components.html" title="apache-felix-ipojo-testing-components">Testing components</A></LI>
        <LI><A href="apache-felix-ipojo-eclipse-integration.html" title="apache-felix-ipojo-eclipse-integration">Eclipse Integration</A></LI>
        <LI><A href="ipojo-faq.html" title="iPOJO FAQ">FAQ</A></LI>
        <LI><A href="ipojo-reference-card.html" title="iPOJO-Reference-Card">Reference Card</A></LI>
        </UL>
    </LI> <!-- end of user guide -->
    <!-- sub- menu : Dev Guide -->
    <LI>
    <A href="" class="sf-with-ul">Advanced Topics<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
       <UL>
        <LI><A href="http://felix.apache.org/ipojo/api/1.6.0" class="external-link" rel="nofollow">Javadoc</A></LI>
        <LI><A href="how-to-write-your-own-handler.html" title="How to write your own handler">Handler development</A></LI>
        <LI><A href="how-to-use-ipojo-manipulation-metadata.html" title="How to use iPOJO Manipulation Metadata">Manipulation Metadata </A></LI>
        <LI><A href="dive-into-the-ipojo-manipulation-depths.html" title="Dive into the iPOJO Manipulation depths">Dive into the iPOJO Manipulation depths</A></LI>
       </UL>
    </LI> <!-- End of Dev guide -->
</UL>
</LI> <!-- End of doc -->
<!-- Menu 4 : Tools -->
<LI class="">
<A href="" class="sf-with-ul">Tools<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="ipojo-ant-task.html" title="iPOJO Ant Task">Ant Task</A></LI>
   <LI><A href="ipojo-eclipse-plug-in.html" title="iPOJO Eclipse Plug-in">Eclipse Plugin</A></LI>
   <LI><A href="ipojo-maven-plug-in.html" title="iPOJO Maven Plug-in">Maven Plugin</A></LI>
   <LI><A href="ipojo-arch-command.html" title="iPOJO-Arch-Command"><TT>arch</TT> shell command</A></LI>
   <LI><A href="apache-felix-ipojo-online-manipulator.html" title="apache-felix-ipojo-online-manipulator">Online Manipulator</A></LI>
   <LI><A href="ipojo-webconsole-plugin.html" title="iPOJO Webconsole Plugin">Webconsole plugin</A></LI>
   <LI><A href="apache-felix-ipojo-junit4osgi.html" title="apache-felix-ipojo-junit4osgi">Junit4OSGi</A></LI>
</UL>
</LI><!-- End of tools -->
<!-- Menu 5 : Support -->
<LI>
<A href="ipojo-support.html" title="ipojo-support">Support </A>
</LI>
<!-- End of the menu 5 -->
<!-- Menu 6 : Misc -->
<LI class="">
<A href="" class="sf-with-ul">Misc<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="apache-felix-ipojo-supportedvms.html" title="apache-felix-ipojo-supportedVMs">Supported JVMs</A></LI>
   <LI><A href="apache-felix-ipojo-supportedosgi.html" title="apache-felix-ipojo-supportedOSGi">Supported OSGi Implementations</A></LI>
   <LI><A href="http://ipojo-dark-side.blogspot.com/" class="external-link" rel="nofollow">iPOJO's Dark Side Blog</A></LI>
   <LI><A href="article-presentations.html" title="Article & Presentations">Article &amp; Presentations</A></LI>
   <LI><A href="http://www.apache.org/">ASF</A></LI>
   <LI><A href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</A></LI>
   <LI><A href="http://www.apache.org/foundation/thanks.html">Sponsors</A></LI>
</UL>
</LI><!-- End of misc -->
</UL> <!-- End of the menu -->
</DIV> <!-- Page header -->
</P>

<DIV class="content">

    <div style="
    background-color: #fdf7f7;
    border-color: #d9534f;
    margin: 40px 0;
    padding: 20px;
    border-left: 5px solid #d9534f;">
        <h4 style="margin-top: 0;
        font-size: 18px;
        margin-bottom: 5px;
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 500;
        line-height: 1.1;
        color: inherit;">The iPOJO documentation has moved </h4>
        <p style="margin-top: 0px; padding-top: 0px; margin-bottom: 0px;">
            The new web site is <a href="http://ipojo.org">here</a>, update your bookmark.</p>
    </div>

<H1><A name="ProvidingOSGiservices-ProvidingOSGiservices"></A>Providing OSGi services</H1>

<P><EM>This pages explains how to publish OSGi services with iPOJO. It presents:</EM></P>
<UL>
	<LI><EM>service publication</EM></LI>
	<LI><EM>service properties publication and management</EM></LI>
	<LI><EM>service object creation and creation strategies</EM></LI>
	<LI><EM>service un-registration</EM></LI>
	<LI><EM>configuration property propagation</EM></LI>
	<LI><EM>the management of the exposition from the implementation class</EM></LI>
</UL>


<DIV class="toc"><DIV>
<UL>
    <LI><A href="#ProvidingOSGiservices-Asimpleexample">A simple example</A></LI>
    <LI><A href="#ProvidingOSGiservices-ServicePublication">Service Publication</A></LI>
    <LI><A href="#ProvidingOSGiservices-ServiceProperties">Service Properties</A></LI>
    <LI><A href="#ProvidingOSGiservices-Advancedfeatures">Advanced features</A></LI>
<UL>
    <LI><A href="#ProvidingOSGiservices-ServiceServing%2526ObjectCreation">Service Serving &amp; Object Creation</A></LI>
    <LI><A href="#ProvidingOSGiservices-ProvidingSeveralServices%2528XMLonly%2529">Providing Several Services (XML only)</A></LI>
    <LI><A href="#ProvidingOSGiservices-ServicePropertyPropagation">Service Property Propagation</A></LI>
    <LI><A href="#ProvidingOSGiservices-Instancereconfiguration">Instance reconfiguration</A></LI>
    <LI><A href="#ProvidingOSGiservices-PublishinganabstractorconcreteclassasaService">Publishing an abstract or concrete class as a Service</A></LI>
    <LI><A href="#ProvidingOSGiservices-Controllingtheserviceexpositionfromtheimplementationclass">Controlling the service exposition from the implementation class</A></LI>
    <LI><A href="#ProvidingOSGiservices-Beingnotifiedoftheserviceregistrationandunregistration">Being notified of the service registration and unregistration</A></LI>
</UL>
</UL></DIV></DIV>

<H2><A name="ProvidingOSGiservices-Asimpleexample"></A>A simple example</H2>

<P>The following code snippet shows a simple class implementing the <TT>FooService</TT> interface:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class FooProviderType1 <SPAN class="code-keyword">implements</SPAN> FooService {
            <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> m_foo = <SPAN class="code-quote">&quot;foo&quot;</SPAN>;

            <SPAN class="code-keyword">public</SPAN> void foo() {
                        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;foo  &quot;</SPAN> + m_foo);
            }

}
</PRE>
</DIV></DIV>
<P>To provide a service, the implementation class <B>MUST</B> implement the service interface. </P>

<P>In XML, to provide the service, the component type needs to contain the <TT>&lt;provides/&gt;</TT> element:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;component className=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
        <SPAN class="code-tag">&lt;provides/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>
<P><SPAN class="image-wrap" style=""><IMG src="providing-osgi-services.data/ps-foo.png" style="border: 0px solid black"></SPAN></P>

<P>The <TT>&lt;provides/&gt;</TT> or <TT>@Provides</TT> suffice to declare that each instance of this type will provide the FooService (for more info about instances see <A href="how-to-use-ipojo-factories.html" title="How-to use iPOJO factories">How&#45;to use iPOJO factories</A>). The provided specifications can be discovered by analyzing the implementation class. By default, all implemented interface are published in the same service registration. iPOJO looks down the entire inheritance tree.</P>

<H2><A name="ProvidingOSGiservices-ServicePublication"></A>Service Publication</H2>

<P>The provided service handler manages service publication. For each declared <TT>&lt;provides/&gt;</TT>, the handler registers a service. Since the <TT>@Provides</TT> annotation can be used only once, only one service is registered that provides all interfaces. The service is published as long as the instance is valid. If the instance becomes invalid, the service is removed from the service registry.</P>

<P>By default, it publishes all interfaces implemented by the implementation class of the component class. It collects all super-interfaces (interfaces implemented by implemented interfaces and by the super class). However, it is possible to explicitly declare which service specifications are published with the <TT>specifications</TT> attribute, such as:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides(specifications={FooService.class})
<SPAN class="code-keyword">public</SPAN> class FooProviderType1 <SPAN class="code-keyword">implements</SPAN> FooService, <SPAN class="code-object">Runnable</SPAN> {
    <SPAN class="code-comment">// ...
</SPAN>}
</PRE>
</DIV></DIV>

<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Change in the 1.2.0</B><BR>In the 1.0.0 version and before, the <TT>specifications</TT> attribute was named <TT>interface</TT>.</TD></TR></TABLE></DIV>

<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Specification checking</B><BR>If you use the <TT>specifications</TT> attribute, the handler checks that all declared interfaces are really implemented by the implementation class. If an interface is not implemented, the handler logs a warning.</TD></TR></TABLE></DIV>

<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>No service</B><BR>If the implementation class does not implement any interface, you cannot provide a service. In this case, the handler throws an error.</TD></TR></TABLE></DIV>

<H2><A name="ProvidingOSGiservices-ServiceProperties"></A>Service Properties</H2>

<P>You can also attach properties to a service registration. Service properties are attached to published service and allow consumer filtering/selecting providers. A property can be attached to a field (contained in the component implementation class), and so can be handle dynamically.</P>

<P>Let's take a new example very closed of the last one:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class FooProviderType1 <SPAN class="code-keyword">implements</SPAN> FooService {

    @ServiceProperty(name=<SPAN class="code-quote">&quot;foo&quot;</SPAN>, value=<SPAN class="code-quote">&quot;Foo&quot;</SPAN>)
	<SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> m_foo;

	<SPAN class="code-keyword">public</SPAN> void foo() {
		<SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;foo  &quot;</SPAN> + m_foo);
        m_foo = <SPAN class="code-quote">&quot;bar&quot;</SPAN>;
	}
}
</PRE>
</DIV></DIV>
<P>Using XML, it gives:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;component classname=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
            <SPAN class="code-tag">&lt;provides&gt;</SPAN>
                        <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;foo&quot;</SPAN> field=<SPAN class="code-quote">&quot;m_foo&quot;</SPAN> value=<SPAN class="code-quote">&quot;Foo&quot;</SPAN>/&gt;</SPAN>
            <SPAN class="code-tag">&lt;/provides&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The declared property is attached to the <TT>m_foo</TT> field. This property is published with the name <TT>foo</TT>. This property has a default value &quot;Foo&quot;. This value will be injected into the <TT>m_foo</TT> field, when this field asks for a value. A property with a field attribute does not need to declare a type (the type can be discovered by analyzing the implementation class).</P>

<P>The implementation class set a new value to the <TT>m_foo</TT> field in the code. When this action occurs, the service publication is updated. If a published property value becomes <TT>null</TT>, the property is unpublished since it has a new value.</P>


<P>You can also publish 'static' properties (not attached to a field):</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides(properties= {
			@StaticServiceProperty(name=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">static</SPAN>&quot;</SPAN>, type=<SPAN class="code-quote">&quot;java.lang.<SPAN class="code-object">String</SPAN>&quot;</SPAN>, value=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">this</SPAN> is a <SPAN class="code-keyword">static</SPAN> property&quot;</SPAN>)
	})
<SPAN class="code-keyword">public</SPAN> class FooProviderType1 <SPAN class="code-keyword">implements</SPAN> FooService {

    @ServiceProperty(name=<SPAN class="code-quote">&quot;foo&quot;</SPAN>, value=<SPAN class="code-quote">&quot;Foo&quot;</SPAN>)
	<SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> m_foo;

	<SPAN class="code-keyword">public</SPAN> void foo() {
		<SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;foo  &quot;</SPAN> + m_foo);
        m_foo = <SPAN class="code-quote">&quot;bar&quot;</SPAN>;
	}
}
</PRE>
</DIV></DIV>

<P>The second property (<TT>Static</TT>) is published as a static property. This property is not attached to a field, so, we need to declare the property type. All primitive types or objects can be used has property type (for object, the qualified name of the class is used as java.lang.String).</P>

<P>In XML, this can also be done:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;component classname=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
            <SPAN class="code-tag">&lt;provides&gt;</SPAN>
                        <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;foo&quot;</SPAN> field=<SPAN class="code-quote">&quot;m_foo&quot;</SPAN> value=<SPAN class="code-quote">&quot;Foo&quot;</SPAN>/&gt;</SPAN>
                        <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;static&quot;</SPAN> type=<SPAN class="code-quote">&quot;java.lang.String&quot;</SPAN> value=<SPAN class="code-quote">&quot;this is a static property&quot;</SPAN>/&gt;</SPAN>
            <SPAN class="code-tag">&lt;/provides&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>Properties may have a default value (set using the <TT>value</TT> attribute). This value will be used as initial value. The value can be given in the instance configuration. The default value will be overridden in this case:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
   <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;foo&quot;</SPAN> value=<SPAN class="code-quote">&quot;My New Foo Value&quot;</SPAN>/&gt;</SPAN>
   <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;static&quot;</SPAN> value=<SPAN class="code-quote">&quot;My Value For Static&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>Properties can also be 'mandatory'. Mandatories properties must receive a value from the instance configuration. If the instance configuration <EM>forgets</EM> a mandatory properties, the configuration is rejected. Mandatory attribute let you be sure to receive the complete set of initialization values:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class MyComponent <SPAN class="code-keyword">implements</SPAN> MyService {

    @ServiceProperty(name=<SPAN class="code-quote">&quot;username&quot;</SPAN>, mandatory=<SPAN class="code-keyword">true</SPAN>)
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> m_username;

    @Property(name=<SPAN class="code-quote">&quot;password&quot;</SPAN>, mandatory=<SPAN class="code-keyword">true</SPAN>)
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> m_password;

    <SPAN class="code-comment">//...
</SPAN>}
</PRE>
</DIV></DIV>

<P>For the previous components:</P>
<UL>
	<LI><TT>(name=myname, password=****)</TT> is a valid configuration</LI>
	<LI><TT>(password=****)</TT> is an invalid configuration that will be rejected by iPOJO</LI>
</UL>



<H2><A name="ProvidingOSGiservices-Advancedfeatures"></A>Advanced features</H2>

<H3><A name="ProvidingOSGiservices-ServiceServing%26ObjectCreation"></A>Service Serving &amp; Object Creation</H3>

<P>When a consumer requires the published service, the handler sends an object (from the component class) of the implementation class. By default, it is always the same POJO object. If no objects already exists, an instance is created.</P>

<P>However, the handler supports the OSGi <EM>Service Factory</EM>. In this case, for each requester bundle, the handler sends a new object. To activate this policy, add the <TT>strategy</TT> attribute in the <TT>provides</TT> element:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides(strategy=<SPAN class="code-quote">&quot;SERVICE&quot;</SPAN>)
<SPAN class="code-keyword">public</SPAN> class MyComponent <SPAN class="code-keyword">implements</SPAN> MyService {
    <SPAN class="code-comment">//...
</SPAN>}
</PRE>
</DIV></DIV>
<P>or:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;provides strategy=<SPAN class="code-quote">&quot;SERVICE&quot;</SPAN>/&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>Other strategies are available:</P>
<UL>
	<LI><TT>strategy=&quot;instance&quot;</TT> allows creating one service object per iPOJO instance using the service</LI>
	<LI>it is possible to create your own creation strategy by extending the <TT>org.apache.felix.ipojo.handlers.providedservice.CreationStrategy</TT> class and by indicating the qualified class name in the <TT>strategy</TT> attribute:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides(strategy=<SPAN class="code-quote">&quot;org.acme.foo.MyCreationStrategy&quot;</SPAN>)
<SPAN class="code-keyword">public</SPAN> class MyComponent <SPAN class="code-keyword">implements</SPAN> MyService {
    <SPAN class="code-comment">//...
</SPAN>}
</PRE>
</DIV></DIV></LI>
</UL>


<H3><A name="ProvidingOSGiservices-ProvidingSeveralServices%28XMLonly%29"></A>Providing Several Services (XML only)</H3>
<P>In XML, you can declare several <TT>provides</TT> inside the same component. All those provided services will be managed individually, so will be published using several publication (i.e. <TT>org.osgi.frameowrk.ServiceRegistration</TT>). This case is useful when service properties are different for the different services.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;component classname=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
                <SPAN class="code-tag">&lt;provides specifications=<SPAN class="code-quote">&quot;...Foo&quot;</SPAN>/&gt;</SPAN>
                <SPAN class="code-tag">&lt;provides specifications=<SPAN class="code-quote">&quot;...Bar&quot;</SPAN>&gt;</SPAN>
                               <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;foo&quot;</SPAN> value=<SPAN class="code-quote">&quot;baz&quot;</SPAN>/&gt;</SPAN>
                <SPAN class="code-tag">&lt;/provides&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>
<P><SPAN class="image-wrap" style=""><IMG src="providing-osgi-services.data/ps-foobar2.png" style="border: 0px solid black"></SPAN></P>

<H3><A name="ProvidingOSGiservices-ServicePropertyPropagation"></A>Service Property Propagation</H3>

<P>The configuration handler has the possibility to propagate received properties to service publication. So, when the propagation is activated (on the <TT>properties</TT> element or on the <TT>@Component</TT> annotation), all properties received by the configuration handler will be propagated to all published services. If some properties are mapped on methods, these methods are invoked with the new value in argument.</P>

<P><SPAN class="image-wrap" style=""><IMG src="providing-osgi-services.data/ps-propagation.png" style="border: 0px solid black"></SPAN></P>

<P>If an instance configuration contains properties starting with <TT>service.</TT>, they are automatically propagated. In the following example, the <TT>service.pid</TT> is automatically propagated.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;instance component=<SPAN class="code-quote">&quot;...&quot;</SPAN>&gt;</SPAN>
    <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;service.pid&quot;</SPAN> value=<SPAN class="code-quote">&quot;my.pid&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/instance&gt;</SPAN>
</PRE>
</DIV></DIV>

<H3><A name="ProvidingOSGiservices-Instancereconfiguration"></A>Instance reconfiguration</H3>

<P>iPOJO supports instance reconfiguration. When an instance is dynamically reconfigured and if the instance published service properties, the values are updated with the new configuration. For example, let's take the following component.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Instantiate
@Provides
<SPAN class="code-keyword">public</SPAN> class MyComponent <SPAN class="code-keyword">implements</SPAN> MyService {

    @ServiceProperty(name=<SPAN class="code-quote">&quot;prop&quot;</SPAN>, value=<SPAN class="code-quote">&quot;initial&quot;</SPAN>)
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">String</SPAN> myProp;

    <SPAN class="code-comment">//...
</SPAN>
}
</PRE>
</DIV></DIV>

<P>The previous code also declares an instance (created without any configuration). This instance registers <TT>MyService</TT> with the service property <TT>prop</TT>=<TT>initial</TT>. If this instance is reconfigured using a configuration like: {<TT>prop=&quot;my value&quot;</TT>}, the published properties will be updated with the new value, so <TT>prop</TT>=<TT>my value</TT>.</P>

<H3><A name="ProvidingOSGiservices-PublishinganabstractorconcreteclassasaService"></A>Publishing an abstract or concrete class as a Service</H3>

<P>It is also possible to expose an abstract or concrete class as a service. To to this, just specify the published class in the <TT>specifications</TT> attribute:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides(specifications=MyComponent.class)
<SPAN class="code-keyword">public</SPAN> class MyComponent {
    <SPAN class="code-comment">// ...
</SPAN>}
</PRE>
</DIV></DIV>
<P>or in XML:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;component classname=<SPAN class="code-quote">&quot;...FooProviderType1&quot;</SPAN>&gt;</SPAN>
                <SPAN class="code-tag">&lt;provides specifications=<SPAN class="code-quote">&quot;...AbstractFoo&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
<SPAN class="code-tag">&lt;component classname=<SPAN class="code-quote">&quot;...FooBarProviderType1&quot;</SPAN>&gt;</SPAN>
                <SPAN class="code-tag">&lt;provides specifications=<SPAN class="code-quote">&quot;[...AbstractFoo, ...Bar]&quot;</SPAN>/&gt;</SPAN>
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>As illustrated with the example using annotation, the component can also publish itself as a service. However, such practice is not recommended.</P>

<H3><A name="ProvidingOSGiservices-Controllingtheserviceexpositionfromtheimplementationclass"></A>Controlling the service exposition from the implementation class</H3>

<P>To control the exposition of the published service, you can use a <TT>service controller</TT>. A service controller is a boolean field of the component class. The injected boolean field allows the code to impact the service publication. Setting the field to <TT>false</TT> unregisters the service from the service registry. Setting it back to <TT>true</TT> re-publishes the service.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class ControllerCheckService <SPAN class="code-keyword">implements</SPAN> FooService, CheckService {

    @ServiceController
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">boolean</SPAN> controller; <SPAN class="code-comment">// Service Controller
</SPAN>
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> foo() {
        <SPAN class="code-keyword">return</SPAN> controller;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> check() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Before : &quot;</SPAN> + controller);
        controller = ! controller; <SPAN class="code-comment">// Change the publication
</SPAN>        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;After : &quot;</SPAN> + controller);
        <SPAN class="code-keyword">return</SPAN> controller;
    }

}
</PRE>
</DIV></DIV>

<P>Using XML, the previous component description is:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
  &lt;component classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.component.controller.ControllerCheckService&quot;</SPAN>
    name=<SPAN class="code-quote">&quot;PS-Controller-1-default&quot;</SPAN>&gt;
    <SPAN class="code-tag">&lt;provides&gt;</SPAN>
      <SPAN class="code-tag">&lt;controller field=<SPAN class="code-quote">&quot;controller&quot;</SPAN>/&gt;</SPAN>
    <SPAN class="code-tag">&lt;/provides&gt;</SPAN>
  <SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The <TT>controller</TT> may have a value attribute setting the initial value. Setting this value to <TT>false</TT> disables the initial service registration:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class ControllerCheckService <SPAN class="code-keyword">implements</SPAN> FooService, CheckService {

    @ServiceController(value=<SPAN class="code-keyword">false</SPAN>)
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">boolean</SPAN> controller; <SPAN class="code-comment">// Service Controller
</SPAN>
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> foo() {
        <SPAN class="code-keyword">return</SPAN> controller;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> check() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Before : &quot;</SPAN> + controller);
        controller = ! controller; <SPAN class="code-comment">// Change the publication
</SPAN>        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;After : &quot;</SPAN> + controller);
        <SPAN class="code-keyword">return</SPAN> controller;
    }

}
</PRE>
</DIV></DIV>

<P>If several interfaces are exposed, the controller may have a <TT>specification</TT> attribute indicating the impacted service:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@Component
@Provides
<SPAN class="code-keyword">public</SPAN> class ControllerCheckService <SPAN class="code-keyword">implements</SPAN> FooService, CheckService {

    @ServiceController(value=<SPAN class="code-keyword">false</SPAN>, specification=FooService.class)
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-object">boolean</SPAN> controller; <SPAN class="code-comment">// Service Controller
</SPAN>
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> foo() {
        <SPAN class="code-keyword">return</SPAN> controller;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> check() {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Before : &quot;</SPAN> + controller);
        controller = ! controller; <SPAN class="code-comment">// Change the publication
</SPAN>        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;After : &quot;</SPAN> + controller);
        <SPAN class="code-keyword">return</SPAN> controller;
    }

}
</PRE>
</DIV></DIV>

<P>In XML, each <TT>provides</TT> can have one <TT>controller</TT> element.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
  &lt;component classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.component.controller.ControllerCheckService&quot;</SPAN>
    name=<SPAN class="code-quote">&quot;PS-Controller-1-false&quot;</SPAN>&gt;
    <SPAN class="code-tag">&lt;provides&gt;</SPAN>
      <SPAN class="code-tag">&lt;controller field=<SPAN class="code-quote">&quot;controller&quot;</SPAN> value=<SPAN class="code-quote">&quot;false&quot;</SPAN>/&gt;</SPAN>
    <SPAN class="code-tag">&lt;/provides&gt;</SPAN>
  <SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>

<H3><A name="ProvidingOSGiservices-Beingnotifiedoftheserviceregistrationandunregistration"></A>Being notified of the service registration and unregistration</H3>
<P>You can also be notified when the service is published and unpublished. This is done by specifying the two callbacks in the <TT>&lt;provides/&gt;</TT> element:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
&lt;component
     classname=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.component.callbacks.CallbacksCheckService&quot;</SPAN>
     name=<SPAN class="code-quote">&quot;PS-Callbacks-both-1&quot;</SPAN>&gt;
    &lt;provides
	specifications=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.ps.service.FooService&quot;</SPAN>
	post-unregistration=<SPAN class="code-quote">&quot;unregistered&quot;</SPAN> post-registration=<SPAN class="code-quote">&quot;registered&quot;</SPAN>/&gt;
    &lt;provides
	specifications=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.ps.service.CheckService&quot;</SPAN>
	post-unregistration=<SPAN class="code-quote">&quot;unregistered&quot;</SPAN> post-registration=<SPAN class="code-quote">&quot;registered&quot;</SPAN>/&gt;
<SPAN class="code-tag">&lt;/component&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>Or by using the @PostRegistration and @PostUnregistration annotations:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	@PostRegistration
	<SPAN class="code-keyword">public</SPAN> void registered(ServiceReference ref) {
		<SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Registered&quot;</SPAN>);
	}

        @PostUnregistration
	<SPAN class="code-keyword">public</SPAN> void unregistered(ServiceReference ref) {
		<SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Unregistered&quot;</SPAN>);
	}
</PRE>
</DIV></DIV>

<UL>
	<LI>The <TT>post-registration</TT> callback is called after the service publication</LI>
	<LI>The <TT>post-unregistration</TT> callback is called after the service unpublication</LI>
</UL>


<P>Those callback methods must have the following signature: <TT>public void name(ServiceReference ref)</TT>. So they receive the published / unpublished service reference. The callbacks are called in the <B>same thread</B> as the publication / unpublication itself. </P>

<P><BR class="atl-forced-newline">
<BR class="atl-forced-newline"></P>

 </DIV>
        <IMG src="http://felix.apache.org/ipojo/site/footer.png" class="footer">
</DIV>

<SCRIPT type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</SCRIPT>
<SCRIPT type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-1518442-4");
pageTracker._trackPageview();
} catch(err) {}
</SCRIPT>

        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by clement.escoffier on 2011-02-07 11:19:25.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
