
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - Dependency Manager Usage</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<H1><A name="DependencyManagerUsage-Usage"></A>Usage</H1>

<P>Let's look at how to use this implementation. When developing an OSGi bundle that uses and possibly registers services, there are two classes in particular we need to implement. The first one is the bundle activator which controls the life-cycle of the bundle. The second one is the actual service implementation.</P>

<P>When using the dependency manager, your bundle activator is a subclass of DependencyActivatorBase. The following paragraphs will explain how to specify a service and its dependencies. Subsequently, some more advanced scenarios will be covered that involve listening to dependency and service state changes and interacting with the OSGi framework from within your service implementation.</P>

<H2><A name="DependencyManagerUsage-Registeringaservice"></A>Registering a service</H2>

<P>Registering a service is done using a custom implementation of the bundle activator, DependencyActivatorBase, which requires you to implement two methods: init and destroy.</P>

<P>Each bundle can specify zero or more services in the init method. Services can optionally have an interface and properties with which they're registered into the service registry. Registering a service involves creating a new service and adding it to the dependency manager. You then specify the interface as well as the implementation, as shown in the example.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> HttpActivator <SPAN class="code-keyword">extends</SPAN> DependencyActivatorBase {
  <SPAN class="code-keyword">public</SPAN> void init(BundleContext ctx, DependencyManager manager)
                                  <SPAN class="code-keyword">throws</SPAN> Exception {
    Properties props = <SPAN class="code-keyword">new</SPAN> Properties();
    props.put(<SPAN class="code-quote">&quot;port&quot;</SPAN>, <SPAN class="code-quote">&quot;8080&quot;</SPAN>);
    manager.add(createService()
      .setInterface(WebService.class.getName(), props)
      .setImplementation(WebServiceImpl.class));
  }
  <SPAN class="code-keyword">public</SPAN> void destroy(BundleContext ctx, DependencyManager manager)
                                  <SPAN class="code-keyword">throws</SPAN> Exception {
    <SPAN class="code-comment">// cleaned up automatically
</SPAN>  }
}
</PRE>
</DIV></DIV>

<P>There are a couple of alternatives that need some clarification. First of all, you might not have a public interface at all, so the setInterface call is optional. Like in OSGi itself, you can also specify multiple service interfaces in an array of strings. For the implementation you have two choices. You can either specify the class of the implementation, in which case this class needs to have a default, no-args constructor and the dependency manager will use lazy instantiation or you can specify an instance you've already created. More on the life-cycle of the service implementation can be found in the next paragraph.</P>

<H2><A name="DependencyManagerUsage-Specifyingservicedependencies"></A>Specifying service dependencies</H2>

<P>Dependencies can either be required or optional. Required dependencies need to be resolved before the service can even become active. Optional dependencies can appear and disappear while the service is active. The example demonstrates how both are specified in the activator.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    manager.add(createService()
      .setInterface(WebService.class.getName(), <SPAN class="code-keyword">null</SPAN>)
      .setImplementation(WebServiceImpl.class)
      .add(createServiceDependency()
        .setService(ConfigurationAdmin.class, <SPAN class="code-keyword">null</SPAN>)
        .setRequired(<SPAN class="code-keyword">true</SPAN>))
      .add(createServiceDependency()
        .setService(LogService.class, <SPAN class="code-keyword">null</SPAN>)
        .setRequired(<SPAN class="code-keyword">false</SPAN>))
</PRE>
</DIV></DIV>

<H2><A name="DependencyManagerUsage-Specifyingconfigurationdependencies"></A>Specifying configuration dependencies</H2>

<P>Configuration dependencies specified here are by definition required. The reason for this is that if you need an optional configuration, simply registering as a ManagedService(Factory) and implementing updated(Dictionary) works fine. For required configuration dependencies, you can use code along these lines:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    manager.add(createService()
      .setInterface(HttpServlet.class.getName(), <SPAN class="code-keyword">null</SPAN>)
      .setImplementation(MyServlet.class)
      .add(createConfigurationDependency()
        .setPid(<SPAN class="code-quote">&quot;org.apache.felix.myservlet&quot;</SPAN>)
        .setPropagate(<SPAN class="code-keyword">true</SPAN>))
</PRE>
</DIV></DIV>

<P>As you can see, you do not need to register as ManagedService yourself. You do need to implement ManagedService in your implementation though. When implementing the updated() method, take the following things into account:</P>
<OL>
	<LI>updated() will be called after you are instantiated, but before init() and start() are invoked, or service dependencies are injected, so make sure this method works like this;</LI>
	<LI>if updated() executes normally, this dependency will become resolved;</LI>
	<LI>if updated() throws a ConfigurationException, you are signalling the configuration is invalid and the dependency won't be resolved (or it will become unresolved if it previously was);</LI>
	<LI>if updated() gets a null configuration, the dependency will become unresolved too;</LI>
</OL>


<P>In some cases, you might want to propagate configuration settings to your service properties. In that case, use the setPropagate(true) method to enable automatic property propagation (the default is false). That means any properties you specify yourself and any properties you get from ConfigurationAdmin will be merged, and your service will automatically be updated every time these properties change.</P>

<H2><A name="DependencyManagerUsage-Implementingtheservice"></A>Implementing the service</H2>

<P>The service implementation is pretty straightforward. Basically any class that implements the service interface can be used here. Two aspects of the implementation deserve some attention though: the life-cycle model and the service dependencies.</P>

<P>Depending on how the service was specified in the activator it is either instantiated as soon as all required dependencies become available or it was already instantiated when the activator started. The service then goes through a number of states, where each transition includes the invocation of a method on the service implementation. The default names of these methods are init, start, stop and destroy but these can be altered. As a developer, all you need to do is specify any of these methods in your service implementation and they will be invoked.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class WebServiceImpl <SPAN class="code-keyword">implements</SPAN> WebService {
  <SPAN class="code-keyword">public</SPAN> void init() {
  }
  <SPAN class="code-keyword">public</SPAN> void start() {
  }
  <SPAN class="code-keyword">public</SPAN> void stop() {
  }
  <SPAN class="code-keyword">public</SPAN> void destroy() {
  }
}
</PRE>
</DIV></DIV>

<P>Upon activation, the service implementation should initialize its internal state in the init() method and establish connections with other services in the start() method.</P>

<P>The dependency manager will automatically fill in any references to required dependencies that are specified as attributes. The same goes for optional dependencies if they are available. If not, those will be implemented by a null object <IMG class="emoticon" src="https://cwiki.apache.org/confluence/images/icons/emoticons/warning.gif" height="16" width="16" align="absmiddle" alt="" border="0"> TODO-ref. In short, this allows you to simply use these interfaces as if they were always available. A good example of this is the LogService. If it's available, we want to use it for logging. If not, we want to simply ignore log messages. Normally, you'd need to check a reference to this service for null before you can use it. By using a null object, this is not necessary anymore.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class WebServiceImpl <SPAN class="code-keyword">implements</SPAN> WebService {
  <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">volatile</SPAN> ConfigurationAdmin configAdminSvc;
  <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">volatile</SPAN> LogService logSvc;
  
  <SPAN class="code-keyword">public</SPAN> void loadSettings() {
    logSvc.log(LogService.LOG_INFO, <SPAN class="code-quote">&quot;Loading settings.&quot;</SPAN>);
    <SPAN class="code-comment">// <SPAN class="code-keyword">do</SPAN> stuff here
</SPAN>  }
}
</PRE>
</DIV></DIV>

<H2><A name="DependencyManagerUsage-Usinganinstancefactory"></A>Using an instance factory</H2>

<P><IMG class="emoticon" src="https://cwiki.apache.org/confluence/images/icons/emoticons/warning.gif" height="16" width="16" align="absmiddle" alt="" border="0"> TODO will explain how to provide a factory class and method that will be used to create the service implementation.</P>

<H2><A name="DependencyManagerUsage-Usingcompositions"></A>Using compositions</H2>

<P>Sometimes, a service implementation consists of more than a single instance. Instead, it can be a composition of a number of instances. That might also mean that you need dependencies injected into more than one instance. If that is the case, you can provide a list of instances to use for dependency injection yourself.</P>

<P>To do that, you can specify the name of a method that will return a list of instances, like this:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    manager.add(createService()
      .setImplementation(MainServiceImpl.class)
      .setComposition(<SPAN class="code-quote">&quot;getInstances&quot;</SPAN>));
</PRE>
</DIV></DIV>

<P>Whenever dependencies need to be injected, the dependency manager will query the method and try to inject dependencies into all the instances this method returns (as an Object[]). For example:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class MainServiceImpl {
    <SPAN class="code-keyword">private</SPAN> SubComponentA m_compA;
    <SPAN class="code-keyword">private</SPAN> SubComponentB m_compB;

    <SPAN class="code-keyword">public</SPAN> MainServiceImpl() {
        m_compA = <SPAN class="code-keyword">new</SPAN> SubComponentA();
        m_compB = <SPAN class="code-keyword">new</SPAN> SubComponentB();
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">Object</SPAN>[] getInstances() {
        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">new</SPAN> <SPAN class="code-object">Object</SPAN>[] { <SPAN class="code-keyword">this</SPAN>, m_compA, m_compB };
    }
}
</PRE>
</DIV></DIV>

<H2><A name="DependencyManagerUsage-Listeningtoservicedependencies"></A>Listening to service dependencies</H2>

<P>Optionally, a service can define callbacks for each dependency. These callbacks are invoked whenever a new dependency is discovered, an existing dependency changes or disappears. They allow you to track these dependencies. This can be very useful if you, for example, want to implement the white board pattern.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    manager.add(createService()
      .setImplementation(DeviceListener.class)
      .add(createServiceDependency()
        .setService(Device.class, <SPAN class="code-keyword">null</SPAN>)
        .setCallbacks(<SPAN class="code-quote">&quot;added&quot;</SPAN>, <SPAN class="code-quote">&quot;changed&quot;</SPAN>, <SPAN class="code-quote">&quot;removed&quot;</SPAN>)
        .setRequired(<SPAN class="code-keyword">false</SPAN>));
</PRE>
</DIV></DIV>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class DeviceListener {
  <SPAN class="code-keyword">public</SPAN> void added(ServiceReferende ref, <SPAN class="code-object">Object</SPAN> service) {
  }
  <SPAN class="code-keyword">public</SPAN> void changed(ServiceReference ref, <SPAN class="code-object">Object</SPAN> service) {
  }
  <SPAN class="code-keyword">public</SPAN> void removed(ServiceReference ref, <SPAN class="code-object">Object</SPAN> service) {
  }
}
</PRE>
</DIV></DIV>

<P>There are actually several signatures you can use for the callback methods. The dependency manager will search for them in this order (we use a dependency on Device as an example):</P>
<OL>
	<LI>ServiceReference, Device</LI>
	<LI>ServiceReference, Object</LI>
	<LI>ServiceReference</LI>
	<LI>Device</LI>
	<LI>Object</LI>
	<LI>(void)</LI>
</OL>


<P>The search ends when the first signature in this list is found. That method will actually be invoked.</P>

<H2><A name="DependencyManagerUsage-Listeningtotheservicestate"></A>Listening to the service state</H2>

<P>If you're interested in the state of a service, you can register a service state listener with the service of interest. It will be notified whenever the service is starting, started, stopping and stopped.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    Service s = createService()
      .setInterface(WebService.class.getName(), <SPAN class="code-keyword">null</SPAN>)
      .setImplementation(WebServiceImpl.class);
    s.setStateListener(<SPAN class="code-keyword">new</SPAN> ServiceStateListener() {
        <SPAN class="code-keyword">public</SPAN> void starting(Service s) {
        }
        <SPAN class="code-keyword">public</SPAN> void started(Service s) {
        }
        <SPAN class="code-keyword">public</SPAN> void stopping(Service s) {
        }
        <SPAN class="code-keyword">public</SPAN> void stopped(Service s) {
        }
      });
    manager.add(s);
</PRE>
</DIV></DIV>

<H2><A name="DependencyManagerUsage-InteractingwithOSGi"></A>Interacting with OSGi</H2>

<P>Although interaction of the service implementation with the OSGi framework has nothing to do with dependency managemement, the dependency manager does offer support for communicating with the framework.</P>

<P>Normally, your service implementation does not have to contain any OSGi specific classes or code. As shown before, even references to other services can be used without dealing with OSGi specifics. Sometimes, this is an advantage, since the service implementation can easily be reused in a different service oriented framework. However, there are times when you do want to access, for example, the BundleContext because you want to interact with the framework.</P>

<P>For these cases, you can specify one or two members to get direct access to:</P>
<OL>
	<LI>the BundleContext that provides you with an interface to the OSGi framework;</LI>
	<LI>the ServiceRegistration of the service that was registered, provided you have registered a public service interface.</LI>
</OL>


<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> class WebServiceImpl <SPAN class="code-keyword">implements</SPAN> WebService {
  <SPAN class="code-keyword">private</SPAN> BundleContext ctx;
  <SPAN class="code-keyword">private</SPAN> ServiceRegistration svcReg;

  <SPAN class="code-comment">//  
</SPAN>}
</PRE>
</DIV></DIV>

<H2><A name="DependencyManagerUsage-Dynamicdependencies"></A>Dynamic dependencies</H2>

<P>Most of the time, the dependency definitions are static. You define them when the bundle starts and they stay the same throughout the life-cycle of the bundle. However, in some cases you might want to add dependencies to a service afterwards. For example, you might want to start tracking a service with specific properties. To do this, simply add the dependency in the same way as you would have done in the init() method.</P>

        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by marrs on 2008-05-20 02:43:18.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
