
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - iPOJO Hierarchical Composition Overview</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/superfish.css); 
</STYLE>

<STYLE type="text/css">
 @import url(http://felix.apache.org/ipojo/site/style.css); 
</STYLE>

<P>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shCore.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushCSharp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPhp.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJScript.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushVb.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushSql.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushXml.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushShell.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushDelphi.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushPython.js"></SCRIPT>
<SCRIPT class="javascript" src="http://cwiki.apache.org/confluence/download/resources/confluence.ext.code:code/shBrushJava.js"></SCRIPT>

<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/jquery-1.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/hoverIntent.js"></SCRIPT>
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/superfish.js"></SCRIPT> 
<SCRIPT type="text/javascript" src="http://felix.apache.org/ipojo/site/supersubs.js"></SCRIPT> 

<SCRIPT type="text/javascript"> 
 
    $(document).ready(function(){ 
        $("ul.sf-menu").supersubs({ 
            minWidth:    14,   // minimum width of sub-menus in em units 
            maxWidth:    30,   // maximum width of sub-menus in em units 
            extraWidth:  1     // extra width can ensure lines don't sometimes turn over 
                               // due to slight rounding differences and font-family 
        }).superfish();  // call supersubs first, then superfish, so that subs are 
                         // not display:none when measuring. Call before initialising 
                         // containing tabs for same reason. 
    }); 
 
</SCRIPT>
<DIV class="main">
<DIV class="page-header">
<IMG src="http://felix.apache.org/ipojo/site/header.png" class="header">
<A href="http://ipojo.org/"><IMG src="http://felix.apache.org/ipojo/site/ipojo.png" width="225" class="header-logo"></A>
<UL class="sf-menu sf-js-enabled sf-shadow" id="ipojo-menu">
<LI class="current">
<!-- Menu Overview -->
<A href="" class="sf-with-ul">Overview<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
	<LI>
	<A href="apache-felix-ipojo.html" title="Apache Felix iPOJO">Home</A>							
	</LI>
	<LI>
	<A href="apache-felix-ipojo-why-choose-ipojo.html" title="apache-felix-ipojo-why-choose-ipojo">Why choose iPOJO</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-successstories.html" title="apache-felix-ipojo-successstories">Success stories</A>
	</LI>
	<LI>
	<A href="apache-felix-ipojo-feature-overview.html" title="Apache Felix iPOJO Feature Overview">Features</A>
	</LI>
</UL>
</LI>	

<LI class="">			
<!-- Menu download -->
<LI>
<A href="download.html" title="Download">Download </A>
</LI>

<LI class="">					
<!-- Menu Documentation -->
<A href="" class="sf-with-ul">Documentation<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
    <!-- sub- menu : getting started -->
    <LI class="">
    <A href="" class="sf-with-ul">Getting Started<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
    <UL>
     <LI><A href="ipojo-in-10-minutes.html" title="iPOJO in 10 minutes">iPOJO in 10 minutes</A></LI>
     <LI><A href="how-to-use-ipojo-annotations.html" title="How to use iPOJO Annotations">Using Annotations</A></LI>
     <LI><A href="ipojo-hello-word-maven-based-tutorial.html" title="iPOJO Hello Word (Maven-Based) tutorial">Maven tutorial</A></LI>
     <LI><A href="ipojo-advanced-tutorial.html" title="iPOJO Advanced Tutorial">Advanced tutorial</A></LI>
     <LI><A href="apache-felix-ipojo-dosgi.html" title="apache-felix-ipojo-dosgi">Using Distributed OSGi</A></LI>
     <LI><A href="ipojo-composition-tutorial.html" title="iPOJO Composition Tutorial">Application Composition</A></LI>
    </UL>
    </LI> <!-- end of getting started -->
    <!-- sub menu : Describing Components -->
     <LI class="">
        <A href="http://felix.apache.org/site/describing-components.html" class="sf-with-ul">Describing components<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="service-requirement-handler.html" title="Service Requirement Handler">Requiring a service</A></LI>
        <LI><A href="providing-osgi-services.html" title="Providing OSGi services">Providing a service</A></LI>
        <LI><A href="lifecycle-callback-handler.html" title="Lifecycle Callback Handler">Lifecycle management</A></LI>
        <LI><A href="configuration-handler.html" title="Configuration Handler">Configuration</A></LI>
        <LI><A href="architecture-handler.html" title="Architecture Handler">Introspection</A></LI>
        <LI><A href="controller-lifecycle-handler.html" title="Controller Lifecycle Handler">Impacting the lifecycle</A></LI>
        <LI><A href="event-admin-handlers.html" title="Event Admin Handlers">Asynchronous communication</A></LI>
        <LI><A href="ipojo-jmx-handler.html" title="iPOJO JMX Handler">JMX management</A></LI>
        <LI><A href="extender-pattern-handler.html" title="Extender Pattern Handler">Extender pattern</A></LI>
        <LI><A href="white-board-pattern-handler.html" title="White Board Pattern Handler">Whiteboard pattern</A></LI>
        <LI><A href="temporal-service-dependency.html" title="Temporal Service Dependency">Temporal dependencies</A></LI>
        </UL>
     </LI> <!-- End of describing components -->
    <!-- sub- menu : User Guide -->
    <LI class="">
    <A href="" class="sf-with-ul">User Guide<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
        <UL>
        <LI><A href="combining-ipojo-and-configuration-admin.html" title="Combining iPOJO and Configuration Admin">iPOJO and config admin</A></LI>
        <LI><A href="how-to-use-ipojo-factories.html" title="How-to use iPOJO factories">Factories and Instances</A></LI>
        <LI><A href="using-xml-schemas.html" title="Using XML Schemas">XML Schemas</A></LI>
        <LI><A href="apache-felix-ipojo-api.html" title="apache-felix-ipojo-api">API</A></LI>
        <LI><A href="apache-felix-ipojo-testing-components.html" title="apache-felix-ipojo-testing-components">Testing components</A></LI>
        <LI><A href="apache-felix-ipojo-eclipse-integration.html" title="apache-felix-ipojo-eclipse-integration">Eclipse Integration</A></LI>
        <LI><A href="ipojo-faq.html" title="iPOJO FAQ">FAQ</A></LI>
        <LI><A href="ipojo-reference-card.html" title="iPOJO-Reference-Card">Reference Card</A></LI>
        </UL>
    </LI> <!-- end of user guide -->
    <!-- sub- menu : Dev Guide -->
    <LI> 
    <A href="" class="sf-with-ul">Advanced Topics<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
       <UL>
        <LI><A href="http://felix.apache.org/ipojo/api/1.6.0" class="external-link" rel="nofollow">Javadoc</A></LI>
        <LI><A href="how-to-write-your-own-handler.html" title="How to write your own handler">Handler development</A></LI>
        <LI><A href="how-to-use-ipojo-manipulation-metadata.html" title="How to use iPOJO Manipulation Metadata">Manipulation Metadata </A></LI>
        <LI><A href="dive-into-the-ipojo-manipulation-depths.html" title="Dive into the iPOJO Manipulation depths">Dive into the iPOJO Manipulation depths</A></LI>
       </UL>
    </LI> <!-- End of Dev guide -->
</UL> 
</LI> <!-- End of doc -->
<!-- Menu 4 : Tools -->
<LI class="">
<A href="" class="sf-with-ul">Tools<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="ipojo-ant-task.html" title="iPOJO Ant Task">Ant Task</A></LI>
   <LI><A href="ipojo-eclipse-plug-in.html" title="iPOJO Eclipse Plug-in">Eclipse Plugin</A></LI>
   <LI><A href="ipojo-maven-plug-in.html" title="iPOJO Maven Plug-in">Maven Plugin</A></LI>
   <LI><A href="ipojo-arch-command.html" title="iPOJO-Arch-Command"><TT>arch</TT> shell command</A></LI>
   <LI><A href="apache-felix-ipojo-online-manipulator.html" title="apache-felix-ipojo-online-manipulator">Online Manipulator</A></LI>
   <LI><A href="ipojo-webconsole-plugin.html" title="iPOJO Webconsole Plugin">Webconsole plugin</A></LI>
   <LI><A href="apache-felix-ipojo-junit4osgi.html" title="apache-felix-ipojo-junit4osgi">Junit4OSGi</A></LI>
</UL>   
</LI><!-- End of tools -->	
<!-- Menu 5 : Support -->
<LI>
<A href="ipojo-support.html" title="ipojo-support">Support </A>
</LI>
<!-- End of the menu 5 -->			
<!-- Menu 6 : Misc -->
<LI class="">
<A href="" class="sf-with-ul">Misc<SPAN class="sf-sub-indicator"> &raquo;</SPAN><SPAN class="sf-sub-indicator"> &raquo;</SPAN></A>
<UL>
   <LI><A href="apache-felix-ipojo-supportedvms.html" title="apache-felix-ipojo-supportedVMs">Supported JVMs</A></LI>
   <LI><A href="apache-felix-ipojo-supportedosgi.html" title="apache-felix-ipojo-supportedOSGi">Supported OSGi Implementations</A></LI>
   <LI><A href="http://ipojo-dark-side.blogspot.com/" class="external-link" rel="nofollow">iPOJO's Dark Side Blog</A></LI>
   <LI><A href="article-presentations.html" title="Article & Presentations">Article &amp; Presentations</A></LI>
   <LI><A href="http://www.apache.org/">ASF</A></LI>
   <LI><A href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</A></LI>
   <LI><A href="http://www.apache.org/foundation/thanks.html">Sponsors</A></LI>
</UL>
</LI><!-- End of misc -->
</UL> <!-- End of the menu -->
</DIV> <!-- Page header -->
</P>

<DIV class="content">

<H1><A name="iPOJOHierarchicalCompositionOverview-Introduction"></A>Introduction</H1>

<P><EM>iPOJO is an extensible, service-oriented component model implemented on the top of the OSGi framework that aims to simplify the development of OSGi&trade; applications. iPOJO follows a POJO-based component approach using external metadata to describe how POJO components should be managed by the iPOJO runtime. Some of the standard features of iPOJO include automatic service dependency management, service publication, and configuration property injection.</EM></P>

<P>Another feature of iPOJO is component factories. As stated previously, an iPOJO component is described by its metadata. In iPOJO, the metadata describes a component type. For each component type, iPOJO registers a factory service that can be used to create instances of the component type described by the metadata.</P>

<P>In addition to these features, iPOJO also provides a service-oriented composition model. iPOJO's composition model tries to merge:</P>
<UL>
	<LI>Component-based composition and</LI>
	<LI>Dynamic service flexibility.</LI>
</UL>


<P>This document presents iPOJO's hierarchical service composition concepts and a simple example to illustrate them.</P>

<H1><A name="iPOJOHierarchicalCompositionOverview-Motivation"></A>Motivation</H1>

<P>Component composition occurs in two fashions:</P>
<UL>
	<LI>Horizontal composition: A provided interface from one component instance is bound to corresponding required interface of another component instance.</LI>
	<LI>Vertical composition: Component instances are contained inside of another component instance.</LI>
</UL>


<P>Typically, at runtime, a component composition is an unmodifiable set of connected component instances. The main motivation of iPOJO is to remove this limitation and introduce a more dynamic and flexible approach. iPOJO achieves its goals by applying service-oriented concepts to component orientation. Dynamic horizontal composition is supported by iPOJO's dependency injection mechanism described elsewhere (<A href="how-to-write-your-own-handler.html" title="How to write your own handler">How to write your own handler</A>) and dynamic vertical composition is supported by iPOJO's hierarchical composition mechanism described below.</P>

<P>iPOJO hierarchical composition tries to merge component composition and dynamic service flexibility to allow:</P>
<UL>
	<LI>Run-time/late binding.</LI>
	<LI>Service run-time dynamics.</LI>
	<LI>Implementation evolution.</LI>
</UL>


<P>The result is a flexible, yet easy-to-use service-oriented component model.</P>

<H1><A name="iPOJOHierarchicalCompositionOverview-HierachicalServiceComposition"></A>Hierachical Service Composition</H1>

<P>iPOJO essentially provides a kind of service-oriented architecture definition language (ADL). This service-oriented ADL allows you to define <EM>composite</EM> components. The main differences between a traditional component-oriented composite and an iPOJO composite is that the iPOJO composite's constituent entities are described in terms of abstract service interfaces instead of specific component types/instances and bindings are inferred from dependency metadata data rather than explicitly declared. This approach means that composite components in iPOJO are not concrete component implementations; rather, they are abstract implementations whose precise implementation selection is deferred until run time.</P>

<P>Unlike a POJO component in iPOJO that has code associated with it, a composite component is completely described by its metadata. Similar to a POJO component, however, the metadata describes a component type for which iPOJO registers a factory service that can be used to create instances of the composite component.</P>

<P>A composite can be thought of as a service registry or a scoping mechanism of the global OSGi&trade; service registry. Composites can contain other composite, creating a hierarchy of service registries. The OSGi&trade; service registry is the root composite.</P>

<P>A composite can:</P>
<UL>
	<LI>Contain services.</LI>
	<LI>Require services from its parent composite.</LI>
	<LI>Provide services to its parent composite.</LI>
</UL>


<P>A service contained in a composite is a <EM>sub-service</EM>, which is isomorphic to sub-components in traditional component-oriented composites. A sub-service is a service instance created from a component factory. Sub-services are not visible outside of the composite and can only see other services that reside in the composite service registry. The set of services in the composite service registry are all sub-services as well as all required services. Sub-services are not aware of the fact that they are inside of a composite and provide and use services normally within their composite.</P>

<H1><A name="iPOJOHierarchicalCompositionOverview-%22HelloWorld%22Composite"></A>&quot;Hello World&quot; Composite</H1>

<P>This section describes a simple composite example that requires an aggregated set of services from the parent composite, contains 3 sub-services, and provides one service to the parent composite.</P>

<H2><A name="iPOJOHierarchicalCompositionOverview-The%22Killer%22Application"></A>The &quot;Killer&quot; Application</H2>

<P>To illustrate composite we design a &quot;Hello World&quot; application named <EM>HelloComposition</EM>. This composite offers a service for dispatching a &quot;Hello&quot; message to each person listed in a Directory service. Each person is published as a service and is used by the composition to get the name of the person in order to write the message.<SPAN class="image-wrap" style="display: block; text-align: center"><IMG src="ipojo-hierarchical-composition-overview.data/compo1.jpg" style="border: 0px solid black"></SPAN><BR>
The composite provides the HelloDispatcher service:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> HelloDispatcher {
    <SPAN class="code-keyword">public</SPAN> void dispatch();
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">String</SPAN> getLanguage();
    <SPAN class="code-keyword">public</SPAN> List&lt;Person&gt; getPersons();
}
</PRE>
</DIV></DIV>
<P>The next section describes the abstract composite implementation.</P>

<H2><A name="iPOJOHierarchicalCompositionOverview-CompositeDesign"></A>Composite Design</H2>

<P>To implement this composite, we reuse existing service implementations;we have three off-the-shelf services:</P>
<UL>
	<LI>Hello service: Returns a &quot;Hello&quot; message in a particular language.</LI>
	<LI>Directory service: Aggregates Person services.</LI>
	<LI>Dispatch service: Requires Hello and Directory services to dispatch a &quot;Hello&quot; message to each person contained in the Directory.<SPAN class="image-wrap" style="display: block; text-align: center"><IMG src="ipojo-hierarchical-composition-overview.data/compo2.jpg" style="border: 0px solid black"></SPAN><BR>
The following code snippet shows the Hello service interface:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> Hello {
    <SPAN class="code-keyword">public</SPAN> void hello(<SPAN class="code-object">String</SPAN> name);
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">String</SPAN> getLanguage();
}
</PRE>
</DIV></DIV>
<P>The following code snippet shows the Directory service interface:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> Directory {
    <SPAN class="code-keyword">public</SPAN> Person getPerson(<SPAN class="code-object">String</SPAN> name);
    <SPAN class="code-keyword">public</SPAN> List&lt;Person&gt; getPersons();
    <SPAN class="code-keyword">public</SPAN> void addPerson(<SPAN class="code-object">String</SPAN> name, <SPAN class="code-object">String</SPAN> address);
    <SPAN class="code-keyword">public</SPAN> void removePerson(<SPAN class="code-object">String</SPAN> name);
}
</PRE>
</DIV></DIV>
<P>The following code snippet shows the Person service interface:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> Person {
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">String</SPAN> getName();
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">String</SPAN> getAddress();
}
</PRE>
</DIV></DIV>
<P>The following code snippet shows the Dispatch service interface:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> Dispatcher {
    <SPAN class="code-keyword">public</SPAN> void dispatch();
}
</PRE>
</DIV></DIV>
<P>These services define the overall abstract implementation of the composite.</P></LI>
</UL>


<H2><A name="iPOJOHierarchicalCompositionOverview-CompositeDescription"></A>Composite Description</H2>

<P>To describe our composite, we use the iPOJO service-oriented ADL:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;composite name=<SPAN class="code-quote">&quot;HelloComposition&quot;</SPAN>&gt;
    &lt;requires specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.person.Person&quot;</SPAN> aggregate=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.hello.Hello&quot;</SPAN>/&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.say.Dispatcher&quot;</SPAN>/&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.directory.Directory&quot;</SPAN>/&gt;
    &lt;provides specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.compo.HelloDispatcher&quot;</SPAN>/&gt;
&lt;/composite&gt;
</PRE>
</DIV></DIV>
<P>The composite is described in term of service specification, resulting in an abstract component implementation; it declares:</P>
<UL>
	<LI>An requirement for all available Person services from the parent composite.</LI>
	<LI>Sub-services for Hello, Dispatcher, and Directory services.</LI>
	<LI>A provided HelloDispatcher service to the parent composite.</LI>
</UL>


<P>When this composite is instantiated, all Person services from the parent composite are made available in the composite service registry and instances of the Hello, Dispatcher, and Directory are created from available factory services and their corresponding services are published in the composite service registry. The provided HelloDispatcher service is based on method delagation to sub-service specifications as depicted in the following image:<SPAN class="image-wrap" style="display: block; text-align: center"><IMG src="ipojo-hierarchical-composition-overview.data/compo3.jpg" style="border: 0px solid black"></SPAN><BR>
The delegation of HelloDispatcher service methods to sub-service methods is automatically performed by iPOJO based on method name and method parameter matching.</P>

<H3><A name="iPOJOHierarchicalCompositionOverview-CompositeDescriptionFutureWork"></A>Composite Description Future Work</H3>

<P>The composite description presented here does not entirely conform to the ideal model proposed in the earlier sections of this document. Specifically, while the composite is defined in terms of services, the composition as described only really makes sense if we were aware of implementation-specific dependencies of the eventual Dispatcher component type. In other words, for us to choose the Hello and Directory sub-services, we had to know that the eventual implementation of the Dispatcher sub-service would have dependencies on these other sub-services. Unfortunately, this violates the goal of iPOJO to define composites purely in terms of abstract services.</P>

<P>The main reason for this limitation is that OSGi service specifications are comprised of only two parts:</P>
<OL>
	<LI>A human-readable document.</LI>
	<LI>A Java service interface definition.</LI>
</OL>


<P>To realize iPOJO, OSGi service specifications must be extended to contain other information. For example, services must be able to declare specification-level dependencies on other services. Services with specification-level dependencies are referred to as <EM>composable services</EM>, since it is possible to compose them with other service. In the core OSGi framework, all service dependencies are at the implementation level, thus only component instances are composable.</P>

<P>Composable services are interesting because they make it possible to define services with parameterized behavior or algorithms. For example, a service to select something from a table could have a specification-level dependency on a sorting service, so that sort order is configurable externally. It might appear as if such a scenario were possible with standard OSGi services, but it is not possible unless you make assumptions about the component implementations.</P>

<P>For example, in standard OSGi if component implementation A provides service Foo and requires service Bar, it is not possible to know whether component implementation B, which also provides Foo and requires Bar, uses Bar for the same purpose as A. Composable services makes this possible, since the purpose of such service dependencies can be defined in the service specification. The resulting model obeys two levels of service dependencies:</P>
<UL>
	<LI>Specification-level dependencies: Dependencies that are imposed on all implementations and whose purpose is well defined.</LI>
	<LI>Implementation-level dependencies: Dependencies that are arbitrarily selected by the component developer for a specific component implementation and whose purpose is unknown.</LI>
</UL>


<P>As part of the ongoing work of iPOJO, specification-level dependencies (as well as other service specification improvements) will be introduced to the iPOJO model to further refine its service-oriented component model. Using the current example as an illustration, the current approach under investigation for specification-level dependencies looks like this:</P>

<P><A href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=FELIX&title=Coming%20soon...&linkCreation=true&fromPageId=51301" class="createlink">Coming soon...</A></P>

<H2><A name="iPOJOHierarchicalCompositionOverview-Packaging"></A>Packaging</H2>

<P>A composite component type is described in the metadata.xml file of an iPOJO bundle which means that iPOJO creates a factory service for the composite, like all iPOJO components. Also like all iPOJO components, it is possible to create an instance of the composite in the metadata file by declaring an instance, such as:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;instance component=<SPAN class="code-quote">&quot;HelloComposition&quot;</SPAN> name=<SPAN class="code-quote">&quot;hello-composition&quot;</SPAN>/&gt;
</PRE>
</DIV></DIV>

<H2><A name="iPOJOHierarchicalCompositionOverview-RunTime"></A>Run Time</H2>

<P>Imagine at run time you have:</P>
<UL>
	<LI>Two factories that can create Hello service provider instances.</LI>
	<LI>A factory that can create Dispatcher service provider instances.</LI>
	<LI>A factory that can create Directory service provider instances.</LI>
	<LI>Several existing Person service instances.</LI>
</UL>


<P>When you deploy the example composition and create an instance of it, all aspects of it are automatically managed by iPOJO:</P>
<UL>
	<LI>All available Person services from the parent composite are imported into the composite.</LI>
	<LI>One Hello service provider, one Directory service provider, and one Dispatcher service provider are instantiated inside the composite.</LI>
	<LI>The HelloDispatcher service method calls are wired to the constituent sub-services and it is provided into the parent composite.</LI>
</UL>


<P>If the factory which creates the Hello provider disappears (i.e., its instances become invalid), the composite will automatically switch to the second one to validate the composite service. If the second Hello provider disappears too, then the composite will be invalidated (i.e., the provided service will be revoked) and it will wait for new factory providing Hello service instances, which may themselves also be composite implementations.</P>

<P>When a Person service appears in the parent composite, it is automatically inserted into the composite. Likewise, if a Person service disappears from the parent composite, it is automatically removed from the composite.</P>

<P>A <A href="http://clement.plop-plop.net/animations/composite/composite.htm" class="external-link" rel="nofollow">flash demo</A> of this composition is available.</P>

<H1><A name="iPOJOHierarchicalCompositionOverview-CompositeConceptsandFeatures"></A>Composite Concepts and Features</H1>

<P>The following subsections define the various concepts and features of iPOJO's composite components.</P>

<H2><A name="iPOJOHierarchicalCompositionOverview-ServiceRequirement"></A>Service Requirement</H2>

<P>The composite can require services from the parent composite. Each requirement is describe by an <TT>&lt;requires&gt;</TT> element in the composite description. An imported service must specify the target service specification. Additionally, required sub-services can specify:</P>
<UL>
	<LI>Cardinality: Indicates whether a single provider instance is imported or an aggregated set of the available providers instances is imported.</LI>
	<LI>Optionality: Indicates whether the imported sub-service is optional or mandatory.</LI>
	<LI>Filtering: Indicates how the services available in the parent composite can be further filtered using an LDAP expression evaluated over their service properties.</LI>
</UL>


<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;requires specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.service.Hello&quot;</SPAN>
 optional=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> aggregate=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> filter=<SPAN class="code-quote">&quot;(language=en)&quot;</SPAN>/&gt;
</PRE>
</DIV></DIV>

<H2><A name="iPOJOHierarchicalCompositionOverview-ServiceProvisioning"></A>Service Provisioning</H2>

<P>The composite can provide services to its parent composite. Each provided service is described by a <TT>&lt;provides&gt;</TT> element in the composite description. A provide service must specify provided service specification.</P>

<P>Service provision is realized by delegating method invocations on the service interface to methods on the sub-service instances contained in the composition. A delegation mapping is automatically created by matching method names and arguments types. If a delegation mapping cannot be determined, the composition is invalidated.</P>

<P>Service specifications can also declare certain methods as optional in the service interface; this is done by declaring that a method throws an <TT>UnsupportedOperationException</TT>. Optional methods need not have a mapping for delegation purposes. If a non-optional service method does not have a mapping for delegation, then a warning message is issued.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;provides specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.service.HelloDispatcher&quot;</SPAN>/&gt;
</PRE>
</DIV></DIV>

<H2><A name="iPOJOHierarchicalCompositionOverview-SubServiceInstantiation"></A>Sub-Service Instantiation</H2>

<P>A composite can contain sub-services, which result in private service instances at run time. The composite will track factories able to create targeted specification providers. The created service instances are accessible only inside the composite. Sub-service instances may also be composites. Each sub-service to instantiate is represented in the composite description by a <TT>&lt;service&gt;</TT> element. The sub-services must specify the desired service specification for the sub-service. Additionally, the sub-service may specify:</P>
<UL>
	<LI>Cardinality: Indicates whether a single provider instance is created or an aggregated set of the available provider instances is imported.</LI>
	<LI>Optionality: Indicates whether the created sub-service instance is optional or mandatory.</LI>
	<LI>Filtering: Indicates how the service factories available in the parent composite can be further filtered using an LDAP expression evaluated over their service properties.</LI>
	<LI>Configuration: Indicates the configuration to inject in the created instances.</LI>
</UL>


<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;composite name=<SPAN class="code-quote">&quot;composite.bar &quot;</SPAN>&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.service.Hello&quot;</SPAN>&gt;
        &lt;property name=<SPAN class="code-quote">&quot;language&quot;</SPAN> value=<SPAN class="code-quote">&quot;en&quot;</SPAN>/&gt;
    &lt;/service&gt;
&lt;/composite&gt;
</PRE>
</DIV></DIV>

<H2><A name="iPOJOHierarchicalCompositionOverview-Instanceinjection"></A>Instance injection</H2>

<P>A composite can contain instances. These instances does not need to provide any service and are identified by their component types. The composite will track the corresponding factories and create the instances. The instances are accessible only inside the composite and their service requirements are resolved inside the composite too. Each instance to instantiate is represented in the composite description by a <TT>&lt;instance&gt;</TT> element. The instance can specify the desired configuration. The following code snippet will inject an instance of the Hello factory with the configuration : language=en.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;composite name=<SPAN class="code-quote">&quot;composite.bar &quot;</SPAN>&gt;
    &lt;instance component=<SPAN class="code-quote">&quot;Hello&quot;</SPAN>&gt;
        &lt;property name=<SPAN class="code-quote">&quot;language&quot;</SPAN> value=<SPAN class="code-quote">&quot;en&quot;</SPAN>/&gt;
    &lt;/instance&gt;
&lt;/composite&gt;
</PRE>
</DIV></DIV>
<P>Instance injection can be use for front end. However, these instances can be used to help a composite to provide a service (despite the instance does not provide a service). Indeed, these instances can be used as glue code to provide a service, containing method implementations of the provided service. For example, in the previous instance we had a Dispatcher service dispatching Hello message to Persons. Instead of this sub-service it is possible to inject in instance containing the <EM>dispatch</EM> method with a customized dispatching algorithm. A glue code instance can require services as any other iPOJO component.</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;composite name=<SPAN class="code-quote">&quot;HelloComposition&quot;</SPAN>&gt;
    &lt;requires specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.person.Person&quot;</SPAN> aggregate=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.hello.Hello&quot;</SPAN>/&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.directory.Directory&quot;</SPAN>/&gt;
    &lt;instance component=<SPAN class="code-quote">&quot;MyDispatcher&quot;</SPAN>/&gt;
    &lt;provides specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.composition.ex1.compo.HelloDispatcher&quot;</SPAN>/&gt;
&lt;/composite&gt;
</PRE>
</DIV></DIV>
<P><EM>Note:</EM> To use instances as glue code be sure that your bundle, containing your composite, imports the implementation of the component type. Moreover, the factory allowing to create the instance must be available when starting your bundle to compute correctly the delegation mapping.</P>

<H2><A name="iPOJOHierarchicalCompositionOverview-Architecture"></A>Architecture</H2>

<P>iPOJO composites can expose their internal architecture for reflection. This can be useful, for example, when debugging to understand why a given composite is currently invalid, such as when a given import cannot be satisfied. For a composite to expose its internal architecture, it must set the architecture flag, such as:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;composite name=<SPAN class="code-quote">&quot;composite.bar &quot;</SPAN> architecture=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>&gt;
    &lt;service specification=<SPAN class="code-quote">&quot;org.apache.felix.ipojo.test.scenarios.service.Hello&quot;</SPAN>&gt;
        &lt;property name=<SPAN class="code-quote">&quot;language&quot;</SPAN> value=<SPAN class="code-quote">&quot;en&quot;</SPAN>/&gt;
    &lt;/service&gt;
&lt;/composite&gt;
</PRE>
</DIV></DIV>
<P>With this flag set, iPOJO publishes an architecture service for the composite. The architecture of the composite can be examined using the &quot;arch&quot; shell command for Felix.</P>

<H2><A name="iPOJOHierarchicalCompositionOverview-CompositionModelExtensibility"></A>Composition Model Extensibility</H2>

<P>Like the rest of iPOJO, the composition model is extensible. The composite container is composed of a &quot;composite handler&quot;, which is a special handler designed to support composite components. More documentation to come on this feature.
<BR class="atl-forced-newline">
<BR class="atl-forced-newline"></P>

 </DIV>
        <IMG src="http://felix.apache.org/ipojo/site/footer.png" class="footer">
</DIV>

<SCRIPT type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</SCRIPT>
<SCRIPT type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-1518442-4");
pageTracker._trackPageview();
} catch(err) {}
</SCRIPT>

        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by clement.escoffier on 2009-08-25 01:37:39.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
