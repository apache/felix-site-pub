
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - 6.7. Configuring Failover Deployments</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="license.html" title="license">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<STYLE type="text/css">/*<![CDATA[*/
table.ScrollbarTable  {border: none;padding: 3px;width: 100%;padding: 3px;margin: 0px;background-color: #f0f0f0}
table.ScrollbarTable td.ScrollbarPrevIcon {text-align: center;width: 16px;border: none;}
table.ScrollbarTable td.ScrollbarPrevName {text-align: left;border: none;}
table.ScrollbarTable td.ScrollbarParent {text-align: center;border: none;}
table.ScrollbarTable td.ScrollbarNextName {text-align: right;border: none;}
table.ScrollbarTable td.ScrollbarNextIcon {text-align: center;width: 16px;border: none;}

/*]]>*/</STYLE><DIV class="Scrollbar"><TABLE class="ScrollbarTable"><TR><TD class="ScrollbarPrevIcon"><A href="66-installing-additional-features.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/back_16.gif" width="16" height="16"></A></TD><TD width="33%" class="ScrollbarPrevName"><A href="66-installing-additional-features.html">6.6. Installing additional features</A>&nbsp;</TD><TD width="33%" class="ScrollbarParent"><SUP><A href="6-advanced-uses.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/up_16.gif" width="8" height="8"></A></SUP><A href="6-advanced-uses.html">6. Advanced uses</A></TD><TD width="33%" class="ScrollbarNextName">&nbsp;</TD></TR></TABLE></DIV>

<P><A name="6.7.ConfiguringFailoverDeployments-top"></A></P>

<H1><A name="6.7.ConfiguringFailoverDeployments-6.7.ConfiguringFailoverDeployments"></A>6.7. Configuring Failover Deployments</H1>

<P>This chapter will demonstrate how to configure failover deployments.</P>

<H2><A name="6.7.ConfiguringFailoverDeployments-Simplelockfile"></A>Simple lock file</H2>

<P>The simple lock file mechanism is intended for failover configurations where instances reside on the same host machine.</P>

<P>To use this feature, edit the <TT>$KARAF_HOME/etc/system.properties</TT> file as follows on each system in the master/slave setup:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>karaf.lock=true
karaf.lock.class=org.apache.felix.karaf.main.SimpleFileLock
karaf.lock.dir=&lt;PathToLockFileDirectory&gt;
karaf.lock.delay=10
</PRE>
</DIV></DIV>

<P><B>Note</B>: Ensure that the <TT>karaf.lock.dir</TT> property points to the same directory for both the master and slave instance, so that the slave can only acquire the lock when the master releases it.</P>


<H2><A name="6.7.ConfiguringFailoverDeployments-JDBClocking"></A>JDBC locking</H2>

<P>The JDBC locking mechanism is intended for failover configurations where instances exist on separate machines. In this deployment, the master instance holds a lock on a Karaf locking table hosted on a database. If the master loses the lock, a waiting slave process gains access to the locking table and fully starts its container. </P>

<P>To use this feature, do the following on each system in the master/slave setup:</P>

<UL>
	<LI>Update the classpath to include the JDBC driver</LI>
	<LI>Update the <TT>$KARAF_HOME/bin/karaf</TT> script to have unique JMX remote port set if instances reside on the same host</LI>
	<LI>Update the <TT>$KARAF_HOME/etc/system.properties</TT> file as follows:</LI>
</UL>


<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>karaf.lock=true
karaf.lock.class=org.apache.felix.karaf.main.DefaultJDBCLock
karaf.lock.level=50
karaf.lock.delay=10
karaf.lock.jdbc.url=jdbc:derby://dbserver:1527/sample
karaf.lock.jdbc.driver=org.apache.derby.jdbc.ClientDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</PRE>
</DIV></DIV>

<P><B>Note</B>:</P>

<UL>
	<LI>Will fail if JDBC driver is not on classpath.</LI>
	<LI>The database name &quot;sample&quot; will be created if it does not exist on the database.</LI>
	<LI>The first Karaf instance to acquire the locking table is the master instance.</LI>
	<LI>If the connection to the database is lost, the master instance tries to gracefully shutdown, allowing a slave instance to become master when the database service is restored. The former master will require manual restart.</LI>
</UL>


<H3><A name="6.7.ConfiguringFailoverDeployments-JDBClockingonOracle"></A>JDBC locking on Oracle</H3>

<P>If you are using Oracle as your database in a JDBC locking scenario, the <TT>karaf.lock.class</TT> property in the <TT>$KARAF_HOME/etc/system.properties</TT> file must point to <TT>org.apache.felix.karaf.main.OracleJDBCLock</TT>.</P>

<P>Otherwise, configure the system.properties file as normal for your setup, for example:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>karaf.lock=true
karaf.lock.class=org.apache.felix.karaf.main.OracleJDBCLock
karaf.lock.jdbc.url=jdbc:oracle:thin:@hostname:1521:XE
karaf.lock.jdbc.driver=oracle.jdbc.OracleDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</PRE>
</DIV></DIV>

<P>As with the default JDBC locking setup, the Oracle JDBC driver JAR file must be in your classpath. You can ensure this by copying the <TT>ojdbc14.jar</TT> into Karaf's <TT>lib</TT> folder before starting Karaf.</P>

<P><B>Note</B>: The <TT>karaf.lock.jdbc.url</TT> requires an active SID, which means you must manually create a database instance before using this particular lock.</P>

<P><A name="6.7.ConfiguringFailoverDeployments-locklevel"></A></P>

<H2><A name="6.7.ConfiguringFailoverDeployments-Containerlevellocking"></A>Container-level locking</H2>

<P>Container-level locking allows bundles to be preloaded into the slave kernel instance in order to provide faster failover performance. Container-level locking is supported in both the simple file and JDBC locking mechanisms.</P>

<P>To implement container-level locking, add the following to the <TT>$KARAF_HOME/etc/system.properties</TT> file on each system in the master/slave setup:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>karaf.lock=true
karaf.lock.level=50
karaf.lock.delay=10
</PRE>
</DIV></DIV>

<P>The <TT>karaf.log.level</TT> property tells the Karaf instance how far up the boot process to bring the OSGi container. Bundles assigned the same start level or lower will then also be started in that Karaf instance.</P>

<P>Bundle start levels are specified in <TT>$KARAF_HOME/etc/startup.properties</TT>, in the format <TT>jar.name=level</TT>. The core system bundles have levels below 50, where as user bundles have levels greater than 50.</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TH class="confluenceTh"> Level </TH>
<TH class="confluenceTh"> Behavior </TH>
</TR>
<TR>
<TD class="confluenceTd"> 1 </TD>
<TD class="confluenceTd"> A 'cold' standby instance. Core bundles are not loaded into container. Slaves will wait until lock acquired to start server. </TD>
</TR>
<TR>
<TD class="confluenceTd"> &lt;50 </TD>
<TD class="confluenceTd"> A 'hot' standby instance. Core bundles are loaded into the container. Slaves will wait until lock acquired to start user level bundles. The console will be accessible for each slave instance at this level. </TD>
</TR>
<TR>
<TD class="confluenceTd"> &gt;50 </TD>
<TD class="confluenceTd"> This setting is not recommended as user bundles will be started. </TD>
</TR>
</TBODY></TABLE>
</DIV>


<P><B>Note</B>: When using a 'hot' spare on the same host you need to set the JMX remote port to a unique value to avoid bind conflicts. You can edit the Karaf start script to include the following:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>DEFAULT_JAVA_OPTS=&quot;-server $DEFAULT_JAVA_OPTS -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.authenticate=false&quot;
</PRE>
</DIV></DIV>


<P><A href="#6.7.ConfiguringFailoverDeployments-top">top</A></P>

<STYLE type="text/css">/*<![CDATA[*/
table.ScrollbarTable  {border: none;padding: 3px;width: 100%;padding: 3px;margin: 0px;background-color: #f0f0f0}
table.ScrollbarTable td.ScrollbarPrevIcon {text-align: center;width: 16px;border: none;}
table.ScrollbarTable td.ScrollbarPrevName {text-align: left;border: none;}
table.ScrollbarTable td.ScrollbarParent {text-align: center;border: none;}
table.ScrollbarTable td.ScrollbarNextName {text-align: right;border: none;}
table.ScrollbarTable td.ScrollbarNextIcon {text-align: center;width: 16px;border: none;}

/*]]>*/</STYLE><DIV class="Scrollbar"><TABLE class="ScrollbarTable"><TR><TD class="ScrollbarPrevIcon"><A href="66-installing-additional-features.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/back_16.gif" width="16" height="16"></A></TD><TD width="33%" class="ScrollbarPrevName"><A href="66-installing-additional-features.html">6.6. Installing additional features</A>&nbsp;</TD><TD width="33%" class="ScrollbarParent"><SUP><A href="6-advanced-uses.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/up_16.gif" width="8" height="8"></A></SUP><A href="6-advanced-uses.html">6. Advanced uses</A></TD><TD width="33%" class="ScrollbarNextName">&nbsp;</TD></TR></TABLE></DIV>
    </DIV>
  </BODY>
</HTML>
