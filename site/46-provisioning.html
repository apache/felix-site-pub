
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - 4.6. Provisioning</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="license.html" title="license">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<STYLE type="text/css">/*<![CDATA[*/
table.ScrollbarTable  {border: none;padding: 3px;width: 100%;padding: 3px;margin: 0px;background-color: #f0f0f0}
table.ScrollbarTable td.ScrollbarPrevIcon {text-align: center;width: 16px;border: none;}
table.ScrollbarTable td.ScrollbarPrevName {text-align: left;border: none;}
table.ScrollbarTable td.ScrollbarParent {text-align: center;border: none;}
table.ScrollbarTable td.ScrollbarNextName {text-align: right;border: none;}
table.ScrollbarTable td.ScrollbarNextIcon {text-align: center;width: 16px;border: none;}

/*]]>*/</STYLE><DIV class="Scrollbar"><TABLE class="ScrollbarTable"><TR><TD class="ScrollbarPrevIcon"><A href="45-security-framework.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/back_16.gif" width="16" height="16"></A></TD><TD width="33%" class="ScrollbarPrevName"><A href="45-security-framework.html">4.5. Security framework</A>&nbsp;</TD><TD width="33%" class="ScrollbarParent"><SUP><A href="4-understanding-karaf.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/up_16.gif" width="8" height="8"></A></SUP><A href="4-understanding-karaf.html">4. Understanding Karaf</A></TD><TD width="33%" class="ScrollbarNextName">&nbsp;<A href="47-administration.html">4.7. Administration</A></TD><TD class="ScrollbarNextIcon"><A href="47-administration.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/forwd_16.gif" width="16" height="16"></A></TD></TR></TABLE></DIV>
<P><A name="4.6.Provisioning-top"></A></P>

<H1><A name="4.6.Provisioning-4.6.Provisioning"></A>4.6. Provisioning</H1>

<P>Karaf provides a simple, yet flexible, way to provision applications or &quot;features&quot;.  Such a mechanism is mainly provided by a set of commands available in the <TT>features</TT> shell.  The provisioning system uses xml &quot;repositories&quot; that define a set of features.</P>

<H2><A name="4.6.Provisioning-Repositories"></A>Repositories</H2>

<P>The xml repositories use the following Relax NG Compact syntax:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeHeader panelHeader" style="border-bottom-width: 1px;"><B>Repository schema</B></DIV><DIV class="codeContent panelContent">
<PRE class="code-java">
element features {
  element repository { text }*
  element feature {
    attribute name { text },
    attribute version { text },
    element feature { 
      attribute version { text },
      text 
    }*,
    element config {
      attribute name { text },
      text
    }*,
    element bundle { text }*
  }*
}
</PRE>
</DIV></DIV>

<P>Here is an example of such a repository:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;features&gt;</SPAN>
    <SPAN class="code-tag">&lt;feature name=<SPAN class="code-quote">&quot;spring&quot;</SPAN> version=<SPAN class="code-quote">&quot;2.5.6.SEC01&quot;</SPAN>&gt;</SPAN>
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.aopalliance/1.0_1<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.springframework/spring-core/2.5.6.SEC01<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.springframework/spring-beans/2.5.6.SEC01<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.springframework/spring-aop/2.5.6.SEC01<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>        
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.springframework/spring-context/2.5.6.SEC01<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
        <SPAN class="code-tag">&lt;bundle&gt;</SPAN>mvn:org.springframework/spring-context-support/2.5.6.SEC01<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
    <SPAN class="code-tag">&lt;/feature&gt;</SPAN>
<SPAN class="code-tag">&lt;/features&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>A repository includes a list of <TT>feature</TT> elements, each one representing an application that can be installed.  The feature is identified by its <TT>name</TT> which must be unique amongst all the repositories used and consists of a set of bundles that need to be installed along with some optional dependencies on other features and some optional configurations for the Configuration Admin OSGi service.</P>

<H3><A name="4.6.Provisioning-Bundles"></A>Bundles</H3>

<P>The main information provided by a feature is the set of OSGi bundles that defines the application.  Such bundles are URLs pointing to the actual bundle jars.  For example, one would write the following definition:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;bundle&gt;</SPAN>http://repo1.maven.org/maven2/org/apache/servicemix/nmr/org.apache.servicemix.nmr.api/1.0.0-m2/org.apache.servicemix.nmr.api-1.0.0-m2.jar<SPAN class="code-tag">&lt;/bundle&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>Doing this will make sure the above bundle is installed while installing the feature.</P>

<P>However, Karaf provides several URL handlers, in addition to the usual ones (file, http, etc...). One of these is the maven URL handler, which allow reusing maven repositories to point to the bundles. </P>

<H4><A name="4.6.Provisioning-MavenURLHandler"></A>Maven URL Handler</H4>

<P>The equivalent of the above bundle would be:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;bundle&gt;mvn:org.apache.servicemix.nmr/org.apache.servicemix.nmr.api/1.0.0-m2&lt;/bundle&gt;
</PRE>
</DIV></DIV>
<P>In addition to being less verbose, the maven url handlers can also resolve snapshots and can use a local copy of the jar if one is available in your maven local repository.</P>

<P>The <TT>org.ops4j.pax.url.mvn</TT> bundle resolves <TT>mvn</TT> URLs. This flexible tool can be configured through the configuration service. For example, to find the current repositories type:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
karaf@root:/&gt; config:list
...
----------------------------------------------------------------
Pid:            org.ops4j.pax.url.mvn
BundleLocation: mvn:org.ops4j.pax.url/pax-url-mvn/0.3.3
Properties:
   service.pid = org.ops4j.pax.url.mvn
   org.ops4j.pax.url.mvn.defaultRepositories = file:/opt/development/karaf/assembly/target/apache-felix-karaf-1.2.0-SNAPSHOT/system@snapshots
   org.ops4j.pax.url.mvn.repositories = http:<SPAN class="code-comment">//repo1.maven.org/maven2, 
</SPAN>                                         http:<SPAN class="code-comment">//people.apache.org/repo/m2-snapshot-repository@snapshots@noreleases, 
</SPAN>                                         http:<SPAN class="code-comment">//repository.ops4j.org/maven2, 
</SPAN>                                         http:<SPAN class="code-comment">//svn.apache.org/repos/asf/servicemix/m2-repo 
</SPAN>   below = list of repositories and even before the local repository
</PRE>
</DIV></DIV>

<P>The repositories checked are controlled by these configuration properties. </P>

<P>For example, <TT>org.ops4j.pax.url.mvn.repositories</TT> is a comma separate list of repository URLs specifying those remote repositories to be checked. So, to replace the defaults with a new repository at <TT><A href="http://www.example.org/repo" class="external-link" rel="nofollow">http://www.example.org/repo</A></TT> on the local machine:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
karaf@root:/&gt; config:edit org.ops4j.pax.url.mvn
karaf@root:/&gt; config:proplist                  
   service.pid = org.ops4j.pax.url.mvn
   org.ops4j.pax.url.mvn.defaultRepositories = file:/opt/development/karaf/assembly/target/apache-felix-karaf-1.2.0-SNAPSHOT/system@snapshots
   org.ops4j.pax.url.mvn.repositories = http:<SPAN class="code-comment">//repo1.maven.org/maven2,
</SPAN>                                        http:<SPAN class="code-comment">//people.apache.org/repo/m2-snapshot-repository@snapshots@noreleases,
</SPAN>                                        http:<SPAN class="code-comment">//repository.ops4j.org/maven2,
</SPAN>                                        http:<SPAN class="code-comment">//svn.apache.org/repos/asf/servicemix/m2-repo
</SPAN>   below = list of repositories and even before the local repository
karaf@root:/&gt; config:propset org.ops4j.pax.url.mvn.repositories http:<SPAN class="code-comment">//www.example.org/repo
</SPAN>karaf@root:/&gt; config:update
</PRE>
</DIV></DIV>

<P>By default, snapshots are disable. To enable an URL for snapshots append @snapshots. For example</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
http:<SPAN class="code-comment">//www.example.org/repo@snapshots</SPAN>
</PRE>
</DIV></DIV>

<P>Repositories on the local are supported through <TT><A href="file:///" class="external-link" rel="nofollow">file:/</A></TT> URLs</P>

<H3><A name="4.6.Provisioning-Dependantfeatures"></A>Dependant features</H3>

<P>Dependant features are usefull when a given feature depends on another feature to be installed.  Such a dependency can be expressed easily in the feature definition:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;feature name=<SPAN class="code-quote">&quot;jbi&quot;</SPAN>&gt;</SPAN>
  <SPAN class="code-tag">&lt;feature&gt;</SPAN>nmr<SPAN class="code-tag">&lt;/feature&gt;</SPAN>
  ...
<SPAN class="code-tag">&lt;/feature&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The effect of such a dependency is to automatically install the required <TT>nmr</TT> feature when the <TT>jbi</TT> feature will be installed.</P>

<H3><A name="4.6.Provisioning-Configurations"></A>Configurations</H3>

<P>The configuration section allows to deploy configuration for the OSGi Configuration Admin service along a set of bundles.<BR>
Here is an example of such a configuration:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;config name=<SPAN class="code-quote">&quot;com.foo.bar&quot;</SPAN>&gt;</SPAN>
  myProperty = myValue
<SPAN class="code-tag">&lt;/config&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>The <TT>name</TT> attribute of the <TT>configuration</TT> element will be used as the ManagedService PID for the configuration set in the Configuration Admin service.  When using a ManagedServiceFactory, the <TT>name</TT> attribute is <EM>servicePid</EM>-<EM>aliasId</EM>, where <EM>servicePid</EM> is the PID of the ManagedServiceFactory and <EM>aliasId</EM> is a label used to uniquely identify a particular service (an alias to the factory generated service PID).</P>

<P>Deploying such a configuration has the same effect than dropping a file named <TT>com.foo.bar.cfg</TT> into the <TT>etc</TT> folder.  </P>

<P>The content of the <TT>configuration</TT> element is set of properties parsed using the <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/Properties.html#load(java.io.InputStream)" class="external-link" rel="nofollow">standard java property mechanism</A>.</P>

<P>Such configuration as usually used with Spring-DM or Blueprint support for the Configuration Admin service, as in the following example, but using plain OSGi APIs will of course work the same way:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;bean ...&gt;</SPAN>
    <SPAN class="code-tag">&lt;property name=<SPAN class="code-quote">&quot;propertyName&quot;</SPAN> value=<SPAN class="code-quote">&quot;${myProperty}&quot;</SPAN> /&gt;</SPAN>
<SPAN class="code-tag">&lt;/bean&gt;</SPAN>

<SPAN class="code-tag">&lt;osgix:cm-properties id=<SPAN class="code-quote">&quot;cmProps&quot;</SPAN> persistent-id=<SPAN class="code-quote">&quot;com.foo.bar&quot;</SPAN>&gt;</SPAN>
    <SPAN class="code-tag">&lt;prop key=<SPAN class="code-quote">&quot;myProperty&quot;</SPAN>&gt;</SPAN>myValue<SPAN class="code-tag">&lt;/prop&gt;</SPAN>
<SPAN class="code-tag">&lt;/osgix:cm-properties&gt;</SPAN>
<SPAN class="code-tag">&lt;ctx:property-placeholder properties-ref=<SPAN class="code-quote">&quot;cmProps&quot;</SPAN> /&gt;</SPAN>
</PRE>
</DIV></DIV>

<P>For more informations about using the Configuration Admin service in Spring-DM, see the <A href="http://static.springframework.org/osgi/docs/1.2.0-m2/reference/html/compendium.html#compendium:cm:props" class="external-link" rel="nofollow">Spring-DM documentation</A>.</P>


<H2><A name="4.6.Provisioning-Commands"></A>Commands</H2>

<H3><A name="4.6.Provisioning-Repositorymanagement"></A>Repository management</H3>

<P>The following commands can be used to manage the list of descriptors known by Karaf.  They use URLs pointing to features descriptors.  These URLs can use any protocol known to the ServiceMix Kernel, the most common ones being http, file and mvn.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
features:addUrl      Add a list of repository URLs to the features service
features:removeUrl   Remove a list of repository URLs from the features service
features:listUrl     Display the repository URLs currently associated with the features service.
features:refreshUrl  Reload the repositories to obtain a fresh list of features
</PRE>
</DIV></DIV>

<P>Karaf maintains a persistent list of these repositories so that if you add one URL and restart Karaf, the features will still be available.</P>

<P>The <TT>refreshUrl</TT> command is mostly used when developing features descriptors: when changing the descriptor, it can be handy to reload it in the Kernel without having to restart it or to remove then add again this URL.</P>

<H3><A name="4.6.Provisioning-Featuresmanagement"></A>Features management</H3>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
features:install
features:uninstall
features:list
</PRE>
</DIV></DIV>

<H3><A name="4.6.Provisioning-Examples"></A>Examples</H3>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
features/addUrl mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/1.0.0-m2/xml/features
features/install nmr
</PRE>
</DIV></DIV>

<H2><A name="4.6.Provisioning-Serviceconfiguration"></A>Service configuration</H2>

<P>A simple configuration file located in <TT>[karaf]/etc/org.apache.servicemix.features.cfg</TT> can be modified to customize the behavior when starting the Kernel for the first time.<BR>
This configuration file contains two properties:</P>
<UL>
	<LI><TT>featuresBoot</TT>: a comma separated list of features to install at startup</LI>
	<LI><TT>featuresRepositories</TT>: a comma separated list of feature repositories to load at startup</LI>
</UL>


<P>This configuration file is of interest if you plan to distribute a ServiceMix Kernel distribution which includes pre-installed features.  Such a process is detailed in the <A href="62-building-custom-distributions.html" title="6.2. Building custom distributions">6.2. Building custom distributions</A> section.</P>

<P><A href="#4.6.Provisioning-top">top</A></P>
<STYLE type="text/css">/*<![CDATA[*/
table.ScrollbarTable  {border: none;padding: 3px;width: 100%;padding: 3px;margin: 0px;background-color: #f0f0f0}
table.ScrollbarTable td.ScrollbarPrevIcon {text-align: center;width: 16px;border: none;}
table.ScrollbarTable td.ScrollbarPrevName {text-align: left;border: none;}
table.ScrollbarTable td.ScrollbarParent {text-align: center;border: none;}
table.ScrollbarTable td.ScrollbarNextName {text-align: right;border: none;}
table.ScrollbarTable td.ScrollbarNextIcon {text-align: center;width: 16px;border: none;}

/*]]>*/</STYLE><DIV class="Scrollbar"><TABLE class="ScrollbarTable"><TR><TD class="ScrollbarPrevIcon"><A href="45-security-framework.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/back_16.gif" width="16" height="16"></A></TD><TD width="33%" class="ScrollbarPrevName"><A href="45-security-framework.html">4.5. Security framework</A>&nbsp;</TD><TD width="33%" class="ScrollbarParent"><SUP><A href="4-understanding-karaf.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/up_16.gif" width="8" height="8"></A></SUP><A href="4-understanding-karaf.html">4. Understanding Karaf</A></TD><TD width="33%" class="ScrollbarNextName">&nbsp;<A href="47-administration.html">4.7. Administration</A></TD><TD class="ScrollbarNextIcon"><A href="47-administration.html"><IMG border="0" align="middle" src="http://cwiki.apache.org/confluence/images/icons/forwd_16.gif" width="16" height="16"></A></TD></TR></TABLE></DIV>
    </DIV>
  </BODY>
</HTML>
