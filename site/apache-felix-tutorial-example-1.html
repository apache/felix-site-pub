
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Felix - Apache Felix Tutorial Example 1</TITLE>
    <LINK rel="stylesheet" href="http://felix.apache.org/site/media.data/site.css" type="text/css" media="all">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>
    <DIV class="title"><DIV class="logo"><A href="http://felix.apache.org/site/index.html"><IMG border="0" alt="Apache Felix" src="http://felix.apache.org/site/media.data/logo.png"></A></DIV><DIV class="header"><A href="http://www.apache.org/"><IMG border="0" alt="Apache" src="http://felix.apache.org/site/media.data/apache.png"></A></DIV></DIV>
    <DIV class="menu">
<UL>
	<LI><A href="news.html" title="news">news</A></LI>
	<LI><A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">license</A></LI>
	<LI><A href="http://felix.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">downloads</A></LI>
	<LI><A href="documentation.html" title="documentation">documentation</A></LI>
	<LI><A href="mailinglists.html" title="mailinglists">mailing lists</A></LI>
	<LI><A href="contributing.html" title="Contributing">contributing</A></LI>
	<LI><A href="http://www.apache.org/" class="external-link" rel="nofollow">asf</A></LI>
	<LI><A href="http://www.apache.org/security/" class="external-link" rel="nofollow">security</A></LI>
	<LI><A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">sponsorship</A></LI>
	<LI><A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">sponsors</A>
<!-- ApacheCon Ad -->
<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px">
<!-- ApacheCon Ad --></LI>
</UL>
    </DIV>
    <DIV class="main">
<H1><A name="ApacheFelixTutorialExample1-ApacheFelixTutorialExample1ServiceEventListenerBundle"></A>Apache Felix Tutorial Example 1 - Service Event Listener Bundle</H1>

<P>This example creates a simple bundle that listens for OSGi service events. This example does not do much at first, because it only prints out the details of registering and unregistering services. In the next example we will create a bundle that implements a service, which will cause this bundle to actually do something. For now, we will just use this example to help us understand the basics of creating a bundle.</P>

<P>A bundle gains access to the OSGi framework using a unique instance of <TT>BundleContext</TT>. In order for a bundle to get its unique bundle context, it must implement the <TT>BundleActivator</TT> interface; this interface has two methods, <TT>start()</TT> and <TT>stop()</TT>, that both receive the bundle's context and are called when the bundle is started and stopped, respectively. In the following source code, our bundle implements the <TT>BundleActivator</TT> interface and uses the context to add itself as a listener for service events (the file for our bundle is called <TT>Activator.java</TT>):</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
/*
 * Apache Felix OSGi tutorial.
**/

<SPAN class="code-keyword">package</SPAN> tutorial.example1;

<SPAN class="code-keyword">import</SPAN> org.osgi.framework.BundleActivator;
<SPAN class="code-keyword">import</SPAN> org.osgi.framework.BundleContext;
<SPAN class="code-keyword">import</SPAN> org.osgi.framework.ServiceListener;
<SPAN class="code-keyword">import</SPAN> org.osgi.framework.ServiceEvent;

/**
 * This class <SPAN class="code-keyword">implements</SPAN> a simple bundle that utilizes the OSGi
 * framework's event mechanism to listen <SPAN class="code-keyword">for</SPAN> service events. Upon
 * receiving a service event, it prints out the event's details.
**/
<SPAN class="code-keyword">public</SPAN> class Activator <SPAN class="code-keyword">implements</SPAN> BundleActivator, ServiceListener
{
    /**
     * Implements BundleActivator.start(). Prints
     * a message and adds itself to the bundle context as a service
     * listener.
     * @param context the framework context <SPAN class="code-keyword">for</SPAN> the bundle.
    **/
    <SPAN class="code-keyword">public</SPAN> void start(BundleContext context)
    {
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Starting to listen <SPAN class="code-keyword">for</SPAN> service events.&quot;</SPAN>);
        context.addServiceListener(<SPAN class="code-keyword">this</SPAN>);
    }

    /**
     * Implements BundleActivator.stop(). Prints
     * a message and removes itself from the bundle context as a
     * service listener.
     * @param context the framework context <SPAN class="code-keyword">for</SPAN> the bundle.
    **/
    <SPAN class="code-keyword">public</SPAN> void stop(BundleContext context)
    {
        context.removeServiceListener(<SPAN class="code-keyword">this</SPAN>);
        <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;Stopped listening <SPAN class="code-keyword">for</SPAN> service events.&quot;</SPAN>);

        <SPAN class="code-comment">// Note: It is not required that we remove the listener here,
</SPAN>        <SPAN class="code-comment">// since the framework will <SPAN class="code-keyword">do</SPAN> it automatically anyway.
</SPAN>    }

    /**
     * Implements ServiceListener.serviceChanged().
     * Prints the details of any service event from the framework.
     * @param event the fired service event.
    **/
    <SPAN class="code-keyword">public</SPAN> void serviceChanged(ServiceEvent event)
    {
        <SPAN class="code-object">String</SPAN>[] objectClass = (<SPAN class="code-object">String</SPAN>[])
            event.getServiceReference().getProperty(<SPAN class="code-quote">&quot;objectClass&quot;</SPAN>);

        <SPAN class="code-keyword">if</SPAN> (event.getType() == ServiceEvent.REGISTERED)
        {
            <SPAN class="code-object">System</SPAN>.out.println(
                <SPAN class="code-quote">&quot;Ex1: Service of type &quot;</SPAN> + objectClass[0] + <SPAN class="code-quote">&quot; registered.&quot;</SPAN>);
        }
        <SPAN class="code-keyword">else</SPAN> <SPAN class="code-keyword">if</SPAN> (event.getType() == ServiceEvent.UNREGISTERING)
        {
            <SPAN class="code-object">System</SPAN>.out.println(
                <SPAN class="code-quote">&quot;Ex1: Service of type &quot;</SPAN> + objectClass[0] + <SPAN class="code-quote">&quot; unregistered.&quot;</SPAN>);
        }
        <SPAN class="code-keyword">else</SPAN> <SPAN class="code-keyword">if</SPAN> (event.getType() == ServiceEvent.MODIFIED)
        {
            <SPAN class="code-object">System</SPAN>.out.println(
                <SPAN class="code-quote">&quot;Ex1: Service of type &quot;</SPAN> + objectClass[0] + <SPAN class="code-quote">&quot; modified.&quot;</SPAN>);
        }
    }
}
</PRE>
</DIV></DIV>

<P>After implementing the Java source code for the bundle, we must also define a manifest file that contains meta-data needed by the OSGi framework for manipulating the bundle. The manifest is packaged into a JAR file along with the Java class file associated with our bundle; the whole JAR package is actually referred to as a bundle. We create a file called <TT>manifest.mf</TT> that contains the following:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
Bundle-Name: Service listener example
Bundle-Description: A bundle that displays messages at startup and when service events occur
Bundle-Vendor: Apache Felix
Bundle-Version: 1.0.0
Bundle-Activator: tutorial.example1.Activator
Import-Package: org.osgi.framework
</PRE>
</DIV></DIV>

<P>Most of the above meta-data is for human consumption and does not affect the OSGi framework. Only the <TT>Bundle-Activator</TT> and <TT>Import-Package</TT> meta-data is used by the framework. The <TT>Bundle-Activator</TT> attribute tells the framework which class implements the <TT>BundleActivator</TT> interface. With this information, when the OSGi framework starts the bundle, an instance of the specified class is created and its <TT>start()</TT> method is invoked. The created instance will also have its <TT>stop()</TT> method called when the framework stops the bundle. The <TT>Import-Package</TT> attribute informs the framework of the bundle's dependencies on external packages; all bundles with an activator must import <TT>org.osgi.framework</TT> since it contains the core OSGi class definitions. Any packages dependencies will be verified and resolved by the OSGi framework. (Note: Make sure your manifest file ends in a trailing carriage return or else the last line will be ignored.)</P>

<P>Now we need to compile the source code. To compile we must have the <TT>felix.jar</TT> file (found in Felix' <TT>bin</TT> directory) in our class path. We compile the source file using a command like:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>javac -d c:\classes *.java
</PRE>
</DIV></DIV>

<P>This command compiles all source files and outputs the generated classes into a subdirectory of the <TT>c:\classes</TT> directory; this subdirectory is <TT>tutorial\example1</TT>, named after the package we specified in the source file. For the above command to work, the <TT>c:\classes</TT> directory must exist. After compiling, we need to create a JAR file containing the generated package directories. We will also add our manifest file that contains the bundle's meta-data to the JAR file. To create the JAR file, we issue the command:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>jar cfm example1.jar manifest.mf -C c:\classes tutorial\example1
</PRE>
</DIV></DIV>

<P>This command creates a JAR file using the manifest file we created and includes all of the classes in the <TT>tutorial\example1</TT> directory inside of the <TT>c:\classes</TT> directory. Once the JAR file is created, we are ready to install and start the bundle.</P>

<P>To run Felix, we follow the instructions described in usage.html. When we start Felix, it asks for a profile name, we will put all of our bundles in a profile named <TT>tutorial</TT>. Now we will install and start our bundle. Assuming that we created our bundle in the directory <TT>c:\tutorial</TT>, we can install and start it in Felix' shell using the following command:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>start file:/c:/tutorial/example1.jar
</PRE>
</DIV></DIV>

<P>The above command installs and starts the bundle in a single step; it is also possible to install and start the bundle in two steps by using the Felix <TT>install</TT> and <TT>start</TT> shell commands. To stop the bundle, use the Felix <TT>stop</TT> shell command. Keep in mind, that this bundle will not do much at this point since it only listens for service events and we are not registering any services. In the next example we will register a service that will generate an event for this bundle to receive. To exit Felix, we use the <TT>shutdown</TT> command.</P>
        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by heavy@ungoverned.org on 2008-02-29 12:20:46.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Felix, Felix, Apache, the Apache feather logo, and the Apache Felix project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>
